
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="naver-site-verification" content="a37ea649edf26e70c3de94f9cb034f9d6e11de3f" />
    <meta name="generator" content="Yun Blog">
    <title>Spring Cloud Gateway Error Handling &amp; Filter - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"Spring Cloud Gateway를 활용하여 여러 API를 서비싱 하는 경우 해당 API들은 이전에 포스팅한 Spring Guide - Exception 전략으로 통일된 Error Response를 갖게 할 수 있습니다. 하지만 게이트웨이 내부에서 발생한 예외에 대한 Error Response를 핸들링하지 않게 되는 경우는 통일된 메시지를 갖지 못하게 됩니다. 예를 들어 해당 리소스를 찾을 수 없는 예외의 경우 아래와 같이 응답됩니다.\n123456789http://localhost:5555/ASDASDHTTP/1.1 404 Not Foundcontent-length: 0&lt;Response body is empty&gt;Response code: 404 (Not Found); Time: 145ms; Content length: 0 bytes\n라우팅 되는 서비스 API와는 Error Response 형식이 맞지 않아 문제가 발생할 수 있습니다. 최종적으로 아래와 같이 라우팅하는 서비스 API와 통일된 Error Response를 내려주는 전략에 대한 내용을 정리해보았습니다.\n12345678910111213http://localhost:5555/ASDASDHTTP/1.1 200 OKtransfer-encoding: chunkedContent-Type: application/json&#123;  &quot;message&quot;: &quot;404 NOT_FOUND&quot;,  &quot;status&quot;: 404,  &quot;errors&quot;: [],  &quot;code&quot;: &quot;C001&quot;&#125;Response file saved.\nGlobalExceptionHandler\n게이트웨이 내부에서 발생하는 예외에 대한 전체적인 핸들링을 담당하는 객체입니다.\nErrorResponse 및 예외 클래스 정의\n우선 ErrorResponse 객체 정의 및 예외 클래스를 정의합니다. 해당 내용은 Spring Guide - Exception 전략과 유사합니다.\n12345678910111213141516171819202122232425262728293031323334353637class ErrorResponse(    val message: String,    val status: Int,    val errors: List&lt;FieldError&gt; = emptyList(),    val code: String,) &#123;    // Error Code 기반 생성자    constructor(        message: String? = null,        code: ErrorCode    ) : this(        message = message ?: code.message,        status = code.status,        code = code.code    )&#125;class FieldError(    val field: String,    val value: String,    val reason: String)enum class ErrorCode(    val status: Int,    val code: String,    val message: String) &#123;    FRAME_WORK_INTERNAL_ERROR(500, &quot;C001&quot;, &quot;프레임워크 내부 예외&quot;),    UNDEFINED_ERROR(500, &quot;C002&quot;, &quot;정의하지 않은 예외&quot;),&#125;open class BusinessException(    override val message: String? = null,    val errorCode: ErrorCode) : RuntimeException()\nError Respones 객체를 서비스 API와 동일하게 만듭니다. 대부분의 객체는 Error Code 기반 생성자 기반 생성자로 만들게 생성되며 BusinessException는 게이트웨이 내부의 서비스 로직에 최상위 Exception으로 해당 객체를 기반으로 내부 예외가 핸들링됩니다. 만약 게이트웨이에 로직이 거의 없고 라우팅만 사용하는 경우에는 정의하지 않아도 무방합니다.\nCode C001은 스프링 게이트웨이 내부에서 발생하는 내부 예외, C002는 정의하지 않은 예외들에 대한 코드입니다. 해당 코드들도 서비스 특성에 맞게 설정하면 됩니다.\n예외 핸들링\nSpring Cloud Gateway에서는 @ControllerAdvice와 같은 것을 지원해주지 않아 ErrorWebExceptionHandler를 구현하는 것으로 직접 만들어야 합니다.\n\n1234567891011121314151617181920212223242526272829303132333435@Component@Order(-1)// 내부 bean 보다 우선 순위를 높여 해당 빈이 동작하게 설정class GlobalExceptionHandler(    private val objectMapper: ObjectMapper) : ErrorWebExceptionHandler &#123;    override fun handle(exchange: ServerWebExchange, ex: Throwable): Mono&lt;Void&gt; &#123;        val response = exchange.response        response.headers.contentType = MediaType.APPLICATION_JSON        val errorResponse = when (ex) &#123;            // Spring Web Server 관련 오류의 경우 Spring 오류 메시지를 사용            is ResponseStatusException -&gt; ErrorResponse(code = ErrorCode.FRAME_WORK_INTERNAL_ERROR)            is BusinessException -&gt; &#123;                response.statusCode = HttpStatus.valueOf(ex.errorCode.status)                ErrorResponse(code = ex.errorCode)            &#125;            // 그외 오류는 ErrorCode.UNDEFINED_ERROR 기반으로 메시지를 사용            else -&gt; &#123;                response.statusCode = HttpStatus.valueOf(ErrorCode.UNDEFINED_ERROR.status)                ErrorResponse(code = ErrorCode.UNDEFINED_ERROR)            &#125;        &#125;        return response.writeWith(            Jackson2JsonEncoder(objectMapper).encode(                Mono.just(errorResponse),                response.bufferFactory(),                ResolvableType.forInstance(errorResponse),                MediaType.APPLICATION_JSON,                Hints.from(Hints.LOG_PREFIX_HINT, exchange.logPrefix)            )        )    &#125;&#125;\n해당 객체는 예외가 발생하면 발생한 Exception 인스턴스에 맞게 Jackson 기반으로 Error Response를 생성하여 최종 응답 메시지를 만들어 내려주게 됩니다.\nResponseStatusException 핸들링\nResponseStatusException는 게이트웨이 내부 예외 중 HTTP와 관련된 예외 객체로 예를 들어 게이트웨이에서 라우팅에 등록하지 않거나 없는 주소로 접근하는 경우, 등록되지 않은 HTTP method로 요청하는 경우 등 HTTP와 관련된 예외의 경우 사용되는 예외 객체입니다.\n\n브레이크 포인트를 걸고 없는 페이지를 호출하면 ex 객체에 ResponseStatusException는 객체가 있는 것을 확인할 수 있습니다. 해당 객체로 위에서 정의한 ErrorResponse를 생성하여 아래와 같은 형식으로 응답합니다.\n12345678910111213http://localhost:5555/ASDASDHTTP/1.1 200 OKtransfer-encoding: chunkedContent-Type: application/json&#123;  &quot;message&quot;: &quot;404 NOT_FOUND&quot;,  &quot;status&quot;: 404,  &quot;errors&quot;: [],  &quot;code&quot;: &quot;C001&quot;&#125;Response file saved.\nmessage는 ResponseStatusException에서 넘겨주는 message를 그대로 사용하고 있습니다. 만약 유저에게 공개되어 있는 API인 경우에는 이런 시스템 내부에서 넘겨주는 메시지를 그대로 사용하는 것보다 내부적으로 정제된 ErrorCode의 message를 사용하여 정제된 메시지가 내려가게 하는 것도 좋은 방법입니다. 프로젝트 특성에 맞게 선택하면 됩니다.\n123456789101112http://localhost:5555/actuatorHTTP/1.1 200 OKtransfer-encoding: chunkedContent-Type: application/json&#123;  &quot;message&quot;: &quot;405 METHOD_NOT_ALLOWED \\&quot;Request method &#x27;POST&#x27; not supported\\&quot;&quot;,  &quot;status&quot;: 405,  &quot;errors&quot;: [],  &quot;code&quot;: &quot;C001&quot;&#125;\n위 메시지는 정의되지 않은 HTTP method로 호출했을 때 응답입니다.\nBusinessException\nBusinessException는 비즈니스 예외가 발생하는 경우를 핸들링을 진행하기 위한 객체입니다. 예를 들어 게이트웨이에서 인증 관련된 내부로 직을 진행하다 오류가 발생했을 경우 핸들링하기 위한 객체입니다. 우선 모든 요청에 대한 필터를 추가하는 로직을 간단하게 작성해 보겠습니다.\nFilter\n12345678910# application.ymlspring:    cloud:        gateway:            ...            default-filters:                -   name: GlobalFilter                    args:                        preLogger: false                        postLogger: true\ndefault-filters를 등록합니다. name에는 해당 클래스의 이름, args는 해당 객체에 넘겨줄 arguemnt를 정의합니다. 사용 방법은 아래에서 자세히 설명하겠습니다.\n1234567891011121314151617181920@Componentclass GlobalFilter : AbstractGatewayFilterFactory&lt;GlobalFilter.Config&gt;(Config::class.java) &#123;        private val log by logger()    override fun apply(config: Config): GatewayFilter &#123;        return GatewayFilter &#123; exchange, chain -&gt;            log.info(&quot;preLogger: $&#123;config.preLogger&#125;&quot;)            log.info(&quot;postLogger: $&#123;config.postLogger&#125;&quot;)            chain.filter(exchange)        &#125;    &#125;    class Config(        val preLogger: Boolean,        val postLogger: Boolean    )&#125;\napplication.yml에서 정의한 이름인 GlobalFilter으로 클래스명을 지정하고 args에서 정의한 Argument를 할당할 클래스인 Config 클래스를 지정하고 해당 필드 이름으로 변수를 지정합니다.\n\n해당 필터와 Argument가 정상적으로 동작하는 것을 확인할 수 있습니다. 해당 필터에 인증 관련된 비즈니스 로직이 있다고 가정하고 간단하게 샘플 코드를 만들어 만들어 보겠습니다.\n1234567891011121314151617class UnauthorizedException(errorCode: ErrorCode) : BusinessException(errorCode = errorCode)@Componentclass GlobalFilter : AbstractGatewayFilterFactory&lt;GlobalFilter.Config&gt;(Config::class.java) &#123;    override fun apply(config: Config): GatewayFilter &#123;        return GatewayFilter &#123; exchange, chain -&gt;            // 인증 관련 로직이 있다고 가정 하고, 인증이 실패하는 경우 라고 가정            if (true)&#123;                // UNAUTHORIZED_ERROR(401, &quot;C003&quot;, &quot;인증에 실패했습니다&quot;), ErrorCode 추가                 throw UnauthorizedException(ErrorCode.UNAUTHORIZED_ERROR)            &#125;            chain.filter(exchange)        &#125;    &#125;&#125;\n인증 관련된 UnauthorizedException 예외 클래스를 생성합니다. BusinessException 해당 객체를 그대로 사용해도 무방합니다. 해당 예외가 발생했을 경우 정의된 UNAUTHORIZED_ERROR 객체를 넘겨주기만 하면 적절한 ErrorResponse가 내려가게 됩니다.\n해당 해당 예외가 발생하면 GlobalExceptionHandler 객체에서 BusinessException 객체로 예외 객체가 할당되어 핸들링됩니다.\n\nBusinessException을 상속한 UnauthorizedException 객체와 해당 객체에\nUNAUTHORIZED_ERROR ErrorCode 값이 할당되어 있는 것을 확인할 수 있습니다. 해당 정보 기반으로 최종적으로 Error Response는 다음과 같이 내려지게 됩니다.\n123456789101112http://localhost:5555/a-service/actuatorHTTP/1.1 401 Unauthorizedtransfer-encoding: chunkedContent-Type: application/json&#123;  &quot;message&quot;: &quot;인증에 실패했습니다&quot;,  &quot;status&quot;: 401,  &quot;errors&quot;: [],  &quot;code&quot;: &quot;C003&quot;&#125;\n그 외 오류\n12345678910111213val errorResponse = when (ex) &#123;    // Spring Web Server 관련 오류의 경우 Spring 오류 메시지를 사용    is ResponseStatusException -&gt; ErrorResponse(code = ErrorCode.FRAME_WORK_INTERNAL_ERROR)    is BusinessException -&gt; &#123;        response.statusCode = HttpStatus.valueOf(ex.errorCode.status)        ErrorResponse(code = ex.errorCode)    &#125;    // 그외 오류는 ErrorCode.UNDEFINED_ERROR 기반으로 메시지를 사용    else -&gt; &#123;        response.statusCode = HttpStatus.valueOf(ErrorCode.UNDEFINED_ERROR.status)        ErrorResponse(code = ErrorCode.UNDEFINED_ERROR)    &#125;&#125;\n해당 코드에서 else에 해당하며 정의하지 않은 예외에 대한 부분에 대한 핸들링입니다. 예를 들어 Spring Cloud Gateway 등 내부 예외, 새롭게 추가한 의존성의 내부 예외, 우리가 직접 작성한 예외지만 BusinessException를 기반으로 하지 않은 예외 코드 등이 있습니다.\n1234567891011121314@Componentclass GlobalFilter : AbstractGatewayFilterFactory&lt;GlobalFilter.Config&gt;(Config::class.java) &#123;    private val log by logger()    override fun apply(config: Config): GatewayFilter &#123;        return GatewayFilter &#123; exchange, chain -&gt;            // 코틀린에서 제공해주는 check 메서드            check(config.preLogger) &#123; &quot;check 메서드...&quot; &#125;            chain.filter(exchange)        &#125;    &#125;&#125;\n위 코드처럼 코틀린 자체적으로 지원해 주는 check메서드를 사용하는 경우 IllegalStateException을 예외를 발생시킵니다. 이런 경우 BusinessException에 의해서 핸들링되지 않기 때문에 else 항목으로 잡히게 되며 ErrorCode.UNDEFINED_ERROR에 의해 ErrorResponse가 내려가게 됩니다.\n필요하다면 IllegalStateException 객체를 분기문에 추가하여 핸들링 할 수도 있습니다. 하지만 모든 예외에 대한 핸들링을 할 수 없기 때문에 우리가 정의하지 않은 예외에 대해서는 메시지를 통일화하는 작업은 필요합니다.\n\ncheck메서드로 발생시킨 IllegalStateException 객체와 해당 메시지가 보이는 것을 확인할 수 있습니다. 해당 객체로 최종적으로 아래와 같은 메시지로 응답을 내려줍니다.\n123456789101112http://localhost:5555/a-service/actuatorHTTP/1.1 500 Internal Server Errortransfer-encoding: chunkedContent-Type: application/json&#123;  &quot;message&quot;: &quot;정의하지 않은 예외&quot;,  &quot;status&quot;: 500,  &quot;errors&quot;: [],  &quot;code&quot;: &quot;C002&quot;&#125;\n정리\n게이트웨이로 여러 내부 API에 대한 서비싱을 제공하고 있다면 내부 서비스들의 Error Response의 통일과 게이트웨이 자체도 서비스 내부의 Error Response와 통일하는 것이 본 내용의 핵심입니다. 그 틀안에서 예외 핸들링 전략은 각 서비스 특성과 처한 환경에 맞게 진행하면 된다고 생각합니다. 위에서 설명한 방법도 게이트웨이에 서비스 관련된 로직이 많지 않다고 가정하고 설명한 전략입니다. 라우팅 관련된 설정으로만 구성된 게이트웨이인 경우 예외 클래스를 따로 정의하고 예외 코드를 정의하지 않고 간단하게 구성하는 것이 더 효율적이라고 판단하며 인증 관련된 코드 및 기타 코드들이 많아 예외를 더 체계적으로 관리하게 된다면 위 전략 보다 더 디테일한 전략이 필요할 거 같습니다.\n","dateCreated":"2022-06-11T00:00:00+09:00","dateModified":"2025-01-31T22:31:40+09:00","datePublished":"2022-06-11T00:00:00+09:00","description":"Spring Cloud Gateway를 활용하여 여러 API를 서비싱 하는 경우 해당 API들은 이전에 포스팅한 Spring Guide - Exception 전략으로 통일된 Error Response를 갖게 할 수 있습니다.","headline":"Spring Cloud Gateway Error Handling & Filter","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheese10yun.github.io/spring-cloud-gateway-2/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"https://cheese10yun.github.io/spring-cloud-gateway-2/","keywords":"Spring, MSA"}</script>
    <meta name="description" content="Spring Cloud Gateway를 활용하여 여러 API를 서비싱 하는 경우 해당 API들은 이전에 포스팅한 Spring Guide - Exception 전략으로 통일된 Error Response를 갖게 할 수 있습니다.">
<meta property="og:type" content="blog">
<meta property="og:title" content="Spring Cloud Gateway Error Handling &amp; Filter">
<meta property="og:url" content="https://cheese10yun.github.io/spring-cloud-gateway-2/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="Spring Cloud Gateway를 활용하여 여러 API를 서비싱 하는 경우 해당 API들은 이전에 포스팅한 Spring Guide - Exception 전략으로 통일된 Error Response를 갖게 할 수 있습니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/ErrorWebExceptionHandler.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/404.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/error-code.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/error-code-1.png">
<meta property="article:published_time" content="2022-06-10T15:00:00.000Z">
<meta property="article:modified_time" content="2025-01-31T13:31:40.700Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="MSA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/ErrorWebExceptionHandler.png">
    
    
        
    
    
        <meta property="og:image" content="https://cheese10yun.github.io/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5813739623204880" crossorigin="anonymous"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="카테고리"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">카테고리</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="검색"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">검색</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Spring Cloud Gateway Error Handling &amp; Filter
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2022-06-11T00:00:00+09:00">
	
		    2022/06/11
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>Spring Cloud Gateway를 활용하여 여러 API를 서비싱 하는 경우 해당 API들은 이전에 포스팅한 <a href="https://cheese10yun.github.io/spring-guide-exception/">Spring Guide - Exception 전략</a>으로 통일된 Error Response를 갖게 할 수 있습니다. 하지만 게이트웨이 내부에서 발생한 예외에 대한 Error Response를 핸들링하지 않게 되는 경우는 통일된 메시지를 갖지 못하게 됩니다. 예를 들어 해당 리소스를 찾을 수 없는 예외의 경우 아래와 같이 응답됩니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5555/ASDASD</span><br><span class="line"></span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">content-length: 0</span><br><span class="line"></span><br><span class="line">&lt;Response body is empty&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Response code: 404 (Not Found); Time: 145ms; Content length: 0 bytes</span><br></pre></td></tr></table></figure>
<p>라우팅 되는 서비스 API와는 Error Response 형식이 맞지 않아 문제가 발생할 수 있습니다. 최종적으로 아래와 같이 라우팅하는 서비스 API와 통일된 Error Response를 내려주는 전략에 대한 내용을 정리해보았습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5555/ASDASD</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;404 NOT_FOUND&quot;,</span><br><span class="line">  &quot;status&quot;: 404,</span><br><span class="line">  &quot;errors&quot;: [],</span><br><span class="line">  &quot;code&quot;: &quot;C001&quot;</span><br><span class="line">&#125;</span><br><span class="line">Response file saved.</span><br></pre></td></tr></table></figure>
<h2 id="GlobalExceptionHandler">GlobalExceptionHandler</h2>
<p>게이트웨이 내부에서 발생하는 예외에 대한 전체적인 핸들링을 담당하는 객체입니다.</p>
<h3 id="ErrorResponse-및-예외-클래스-정의">ErrorResponse 및 예외 클래스 정의</h3>
<p>우선 ErrorResponse 객체 정의 및 예외 클래스를 정의합니다. 해당 내용은 <a href="https://cheese10yun.github.io/spring-guide-exception/">Spring Guide - Exception 전략</a>과 유사합니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorResponse</span>(</span><br><span class="line">    <span class="keyword">val</span> message: String,</span><br><span class="line">    <span class="keyword">val</span> status: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">val</span> errors: List&lt;FieldError&gt; = emptyList(),</span><br><span class="line">    <span class="keyword">val</span> code: String,</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error Code 기반 생성자</span></span><br><span class="line">    <span class="keyword">constructor</span>(</span><br><span class="line">        message: String? = <span class="literal">null</span>,</span><br><span class="line">        code: ErrorCode</span><br><span class="line">    ) : <span class="keyword">this</span>(</span><br><span class="line">        message = message ?: code.message,</span><br><span class="line">        status = code.status,</span><br><span class="line">        code = code.code</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FieldError</span>(</span><br><span class="line">    <span class="keyword">val</span> field: String,</span><br><span class="line">    <span class="keyword">val</span> value: String,</span><br><span class="line">    <span class="keyword">val</span> reason: String</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title class_">ErrorCode</span>(</span><br><span class="line">    <span class="keyword">val</span> status: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">val</span> code: String,</span><br><span class="line">    <span class="keyword">val</span> message: String</span><br><span class="line">) &#123;</span><br><span class="line">    FRAME_WORK_INTERNAL_ERROR(<span class="number">500</span>, <span class="string">&quot;C001&quot;</span>, <span class="string">&quot;프레임워크 내부 예외&quot;</span>),</span><br><span class="line">    UNDEFINED_ERROR(<span class="number">500</span>, <span class="string">&quot;C002&quot;</span>, <span class="string">&quot;정의하지 않은 예외&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">BusinessException</span>(</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> message: String? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> errorCode: ErrorCode</span><br><span class="line">) : RuntimeException()</span><br></pre></td></tr></table></figure>
<p>Error Respones 객체를 서비스 API와 동일하게 만듭니다. 대부분의 객체는 Error Code 기반 생성자 기반 생성자로 만들게 생성되며 BusinessException는 게이트웨이 내부의 서비스 로직에 최상위 Exception으로 해당 객체를 기반으로 내부 예외가 핸들링됩니다. 만약 게이트웨이에 로직이 거의 없고 라우팅만 사용하는 경우에는 정의하지 않아도 무방합니다.</p>
<p>Code C001은 스프링 게이트웨이 내부에서 발생하는 내부 예외, C002는 정의하지 않은 예외들에 대한 코드입니다. 해당 코드들도 서비스 특성에 맞게 설정하면 됩니다.</p>
<h3 id="예외-핸들링">예외 핸들링</h3>
<p>Spring Cloud Gateway에서는 <code>@ControllerAdvice</code>와 같은 것을 지원해주지 않아 <code>ErrorWebExceptionHandler</code>를 구현하는 것으로 직접 만들어야 합니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/ErrorWebExceptionHandler.png" alt=""></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(-1)</span><span class="comment">// 내부 bean 보다 우선 순위를 높여 해당 빈이 동작하게 설정</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> objectMapper: ObjectMapper</span><br><span class="line">) : ErrorWebExceptionHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handle</span><span class="params">(exchange: <span class="type">ServerWebExchange</span>, ex: <span class="type">Throwable</span>)</span></span>: Mono&lt;<span class="built_in">Void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> response = exchange.response</span><br><span class="line">        response.headers.contentType = MediaType.APPLICATION_JSON</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> errorResponse = <span class="keyword">when</span> (ex) &#123;</span><br><span class="line">            <span class="comment">// Spring Web Server 관련 오류의 경우 Spring 오류 메시지를 사용</span></span><br><span class="line">            <span class="keyword">is</span> ResponseStatusException -&gt; ErrorResponse(code = ErrorCode.FRAME_WORK_INTERNAL_ERROR)</span><br><span class="line">            <span class="keyword">is</span> BusinessException -&gt; &#123;</span><br><span class="line">                response.statusCode = HttpStatus.valueOf(ex.errorCode.status)</span><br><span class="line">                ErrorResponse(code = ex.errorCode)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 그외 오류는 ErrorCode.UNDEFINED_ERROR 기반으로 메시지를 사용</span></span><br><span class="line">            <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                response.statusCode = HttpStatus.valueOf(ErrorCode.UNDEFINED_ERROR.status)</span><br><span class="line">                ErrorResponse(code = ErrorCode.UNDEFINED_ERROR)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response.writeWith(</span><br><span class="line">            Jackson2JsonEncoder(objectMapper).encode(</span><br><span class="line">                Mono.just(errorResponse),</span><br><span class="line">                response.bufferFactory(),</span><br><span class="line">                ResolvableType.forInstance(errorResponse),</span><br><span class="line">                MediaType.APPLICATION_JSON,</span><br><span class="line">                Hints.from(Hints.LOG_PREFIX_HINT, exchange.logPrefix)</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>해당 객체는 예외가 발생하면 발생한 Exception 인스턴스에 맞게 Jackson 기반으로 Error Response를 생성하여 최종 응답 메시지를 만들어 내려주게 됩니다.</p>
<h4 id="ResponseStatusException-핸들링">ResponseStatusException 핸들링</h4>
<p><code>ResponseStatusException</code>는 게이트웨이 내부 예외 중 HTTP와 관련된 예외 객체로 예를 들어 게이트웨이에서 라우팅에 등록하지 않거나 없는 주소로 접근하는 경우, 등록되지 않은 HTTP method로 요청하는 경우 등 HTTP와 관련된 예외의 경우 사용되는 예외 객체입니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/404.png" alt=""></p>
<p>브레이크 포인트를 걸고 없는 페이지를 호출하면 <code>ex</code> 객체에 <code>ResponseStatusException</code>는 객체가 있는 것을 확인할 수 있습니다. 해당 객체로 위에서 정의한 ErrorResponse를 생성하여 아래와 같은 형식으로 응답합니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5555/ASDASD</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;404 NOT_FOUND&quot;,</span><br><span class="line">  &quot;status&quot;: 404,</span><br><span class="line">  &quot;errors&quot;: [],</span><br><span class="line">  &quot;code&quot;: &quot;C001&quot;</span><br><span class="line">&#125;</span><br><span class="line">Response file saved.</span><br></pre></td></tr></table></figure>
<p>message는 <code>ResponseStatusException</code>에서 넘겨주는 message를 그대로 사용하고 있습니다. 만약 유저에게 공개되어 있는 API인 경우에는 이런 시스템 내부에서 넘겨주는 메시지를 그대로 사용하는 것보다 내부적으로 정제된 ErrorCode의 message를 사용하여 정제된 메시지가 내려가게 하는 것도 좋은 방법입니다. 프로젝트 특성에 맞게 선택하면 됩니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5555/actuator</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;405 METHOD_NOT_ALLOWED \&quot;Request method &#x27;POST&#x27; not supported\&quot;&quot;,</span><br><span class="line">  &quot;status&quot;: 405,</span><br><span class="line">  &quot;errors&quot;: [],</span><br><span class="line">  &quot;code&quot;: &quot;C001&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 메시지는 정의되지 않은 HTTP method로 호출했을 때 응답입니다.</p>
<h4 id="BusinessException">BusinessException</h4>
<p>BusinessException는 비즈니스 예외가 발생하는 경우를 핸들링을 진행하기 위한 객체입니다. 예를 들어 게이트웨이에서 인증 관련된 내부로 직을 진행하다 오류가 발생했을 경우 핸들링하기 위한 객체입니다. 우선 모든 요청에 대한 필터를 추가하는 로직을 간단하게 작성해 보겠습니다.</p>
<h4 id="Filter">Filter</h4>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">gateway:</span></span><br><span class="line">            <span class="string">...</span></span><br><span class="line">            <span class="attr">default-filters:</span></span><br><span class="line">                <span class="bullet">-</span>   <span class="attr">name:</span> <span class="string">GlobalFilter</span></span><br><span class="line">                    <span class="attr">args:</span></span><br><span class="line">                        <span class="attr">preLogger:</span> <span class="literal">false</span></span><br><span class="line">                        <span class="attr">postLogger:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><code>default-filters</code>를 등록합니다. <code>name</code>에는 해당 클래스의 이름, <code>args</code>는 해당 객체에 넘겨줄 arguemnt를 정의합니다. 사용 방법은 아래에서 자세히 설명하겠습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GlobalFilter</span> : <span class="type">AbstractGatewayFilterFactory</span>&lt;<span class="type">GlobalFilter.Config</span>&gt;(Config::<span class="keyword">class</span>.java) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> log <span class="keyword">by</span> logger()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(config: <span class="type">Config</span>)</span></span>: GatewayFilter &#123;</span><br><span class="line">        <span class="keyword">return</span> GatewayFilter &#123; exchange, chain -&gt;</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;preLogger: <span class="subst">$&#123;config.preLogger&#125;</span>&quot;</span>)</span><br><span class="line">            log.info(<span class="string">&quot;postLogger: <span class="subst">$&#123;config.postLogger&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            chain.filter(exchange)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Config</span>(</span><br><span class="line">        <span class="keyword">val</span> preLogger: <span class="built_in">Boolean</span>,</span><br><span class="line">        <span class="keyword">val</span> postLogger: <span class="built_in">Boolean</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>application.yml</code>에서 정의한 이름인 GlobalFilter으로 클래스명을 지정하고 <code>args</code>에서 정의한 Argument를 할당할 클래스인 Config 클래스를 지정하고 해당 필드 이름으로 변수를 지정합니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config.png" alt=""></p>
<p>해당 필터와 Argument가 정상적으로 동작하는 것을 확인할 수 있습니다. 해당 필터에 인증 관련된 비즈니스 로직이 있다고 가정하고 간단하게 샘플 코드를 만들어 만들어 보겠습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UnauthorizedException</span>(errorCode: ErrorCode) : BusinessException(errorCode = errorCode)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GlobalFilter</span> : <span class="type">AbstractGatewayFilterFactory</span>&lt;<span class="type">GlobalFilter.Config</span>&gt;(Config::<span class="keyword">class</span>.java) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(config: <span class="type">Config</span>)</span></span>: GatewayFilter &#123;</span><br><span class="line">        <span class="keyword">return</span> GatewayFilter &#123; exchange, chain -&gt;</span><br><span class="line">            <span class="comment">// 인증 관련 로직이 있다고 가정 하고, 인증이 실패하는 경우 라고 가정</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">                <span class="comment">// UNAUTHORIZED_ERROR(401, &quot;C003&quot;, &quot;인증에 실패했습니다&quot;), ErrorCode 추가 </span></span><br><span class="line">                <span class="keyword">throw</span> UnauthorizedException(ErrorCode.UNAUTHORIZED_ERROR)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            chain.filter(exchange)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>인증 관련된 UnauthorizedException 예외 클래스를 생성합니다. BusinessException 해당 객체를 그대로 사용해도 무방합니다. 해당 예외가 발생했을 경우 정의된 <code>UNAUTHORIZED_ERROR</code> 객체를 넘겨주기만 하면 적절한 ErrorResponse가 내려가게 됩니다.</p>
<p>해당 해당 예외가 발생하면 <code>GlobalExceptionHandler</code> 객체에서 <code>BusinessException</code> 객체로 예외 객체가 할당되어 핸들링됩니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/error-code.png" alt=""></p>
<p><code>BusinessException</code>을 상속한 <code>UnauthorizedException</code> 객체와 해당 객체에<br>
<code>UNAUTHORIZED_ERROR</code> ErrorCode 값이 할당되어 있는 것을 확인할 수 있습니다. 해당 정보 기반으로 최종적으로 Error Response는 다음과 같이 내려지게 됩니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5555/a-service/actuator</span><br><span class="line"></span><br><span class="line">HTTP/1.1 401 Unauthorized</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;인증에 실패했습니다&quot;,</span><br><span class="line">  &quot;status&quot;: 401,</span><br><span class="line">  &quot;errors&quot;: [],</span><br><span class="line">  &quot;code&quot;: &quot;C003&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="그-외-오류">그 외 오류</h2>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> errorResponse = <span class="keyword">when</span> (ex) &#123;</span><br><span class="line">    <span class="comment">// Spring Web Server 관련 오류의 경우 Spring 오류 메시지를 사용</span></span><br><span class="line">    <span class="keyword">is</span> ResponseStatusException -&gt; ErrorResponse(code = ErrorCode.FRAME_WORK_INTERNAL_ERROR)</span><br><span class="line">    <span class="keyword">is</span> BusinessException -&gt; &#123;</span><br><span class="line">        response.statusCode = HttpStatus.valueOf(ex.errorCode.status)</span><br><span class="line">        ErrorResponse(code = ex.errorCode)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 그외 오류는 ErrorCode.UNDEFINED_ERROR 기반으로 메시지를 사용</span></span><br><span class="line">    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">        response.statusCode = HttpStatus.valueOf(ErrorCode.UNDEFINED_ERROR.status)</span><br><span class="line">        ErrorResponse(code = ErrorCode.UNDEFINED_ERROR)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>해당 코드에서 <code>else</code>에 해당하며 정의하지 않은 예외에 대한 부분에 대한 핸들링입니다. 예를 들어 Spring Cloud Gateway 등 내부 예외, 새롭게 추가한 의존성의 내부 예외, 우리가 직접 작성한 예외지만 <code>BusinessException</code>를 기반으로 하지 않은 예외 코드 등이 있습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GlobalFilter</span> : <span class="type">AbstractGatewayFilterFactory</span>&lt;<span class="type">GlobalFilter.Config</span>&gt;(Config::<span class="keyword">class</span>.java) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> log <span class="keyword">by</span> logger()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(config: <span class="type">Config</span>)</span></span>: GatewayFilter &#123;</span><br><span class="line">        <span class="keyword">return</span> GatewayFilter &#123; exchange, chain -&gt;</span><br><span class="line">            <span class="comment">// 코틀린에서 제공해주는 check 메서드</span></span><br><span class="line">            check(config.preLogger) &#123; <span class="string">&quot;check 메서드...&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">            chain.filter(exchange)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드처럼 코틀린 자체적으로 지원해 주는 <code>check</code>메서드를 사용하는 경우 <code>IllegalStateException</code>을 예외를 발생시킵니다. 이런 경우 BusinessException에 의해서 핸들링되지 않기 때문에 <code>else</code> 항목으로 잡히게 되며 <code>ErrorCode.UNDEFINED_ERROR</code>에 의해 ErrorResponse가 내려가게 됩니다.</p>
<p>필요하다면 <code>IllegalStateException</code> 객체를 분기문에 추가하여 핸들링 할 수도 있습니다. 하지만 모든 예외에 대한 핸들링을 할 수 없기 때문에 우리가 정의하지 않은 예외에 대해서는 메시지를 통일화하는 작업은 필요합니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/error-code-1.png" alt=""></p>
<p><code>check</code>메서드로 발생시킨 <code>IllegalStateException</code> 객체와 해당 메시지가 보이는 것을 확인할 수 있습니다. 해당 객체로 최종적으로 아래와 같은 메시지로 응답을 내려줍니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5555/a-service/actuator</span><br><span class="line"></span><br><span class="line">HTTP/1.1 500 Internal Server Error</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;정의하지 않은 예외&quot;,</span><br><span class="line">  &quot;status&quot;: 500,</span><br><span class="line">  &quot;errors&quot;: [],</span><br><span class="line">  &quot;code&quot;: &quot;C002&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="정리">정리</h2>
<p>게이트웨이로 여러 내부 API에 대한 서비싱을 제공하고 있다면 내부 서비스들의 Error Response의 통일과 게이트웨이 자체도 서비스 내부의 Error Response와 통일하는 것이 본 내용의 핵심입니다. 그 틀안에서 예외 핸들링 전략은 각 서비스 특성과 처한 환경에 맞게 진행하면 된다고 생각합니다. 위에서 설명한 방법도 게이트웨이에 서비스 관련된 로직이 많지 않다고 가정하고 설명한 전략입니다. 라우팅 관련된 설정으로만 구성된 게이트웨이인 경우 예외 클래스를 따로 정의하고 예외 코드를 정의하지 않고 간단하게 구성하는 것이 더 효율적이라고 판단하며 인증 관련된 코드 및 기타 코드들이 많아 예외를 더 체계적으로 관리하게 된다면 위 전략 보다 더 디테일한 전략이 필요할 거 같습니다.</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/MSA/" rel="tag">MSA</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Spring/" rel="tag">Spring</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/data-grip/"
                    data-tooltip="DataGrip 살펴 보기"
                    aria-label="이전: DataGrip 살펴 보기"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/exposed-2/"
                    data-tooltip="Kotlin 기반 경량 ORM Exposed 추가 정리 part 1"
                    aria-label="다음: Kotlin 기반 경량 ORM Exposed 추가 정리 part 1"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-cloud-gateway-2/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-cloud-gateway-2/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://cheese10yun.github.io/spring-cloud-gateway-2/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>


<!-- Comment -->
<!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/data-grip/"
                    data-tooltip="DataGrip 살펴 보기"
                    aria-label="이전: DataGrip 살펴 보기"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/exposed-2/"
                    data-tooltip="Kotlin 기반 경량 ORM Exposed 추가 정리 part 1"
                    aria-label="다음: Kotlin 기반 경량 ORM Exposed 추가 정리 part 1"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-cloud-gateway-2/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-cloud-gateway-2/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://cheese10yun.github.io/spring-cloud-gateway-2/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-cloud-gateway-2/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-cloud-gateway-2/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://cheese10yun.github.io/spring-cloud-gateway-2/"
                        aria-label="Google+에 공유하기"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Google+에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>

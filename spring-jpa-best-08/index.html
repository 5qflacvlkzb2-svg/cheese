
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="naver-site-verification" content="a37ea649edf26e70c3de94f9cb034f9d6e11de3f" />
    <meta name="generator" content="Yun Blog">
    <title>Spring JPA Best Practices Step-08 - OneToOne 관계 설정 팁 - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"해당 코드는 Github를 확인해주세요.\nOneToOne 관계 설정 시에 간단한 팁을 정리하겠습니다. 해당 객체들의 성격은 다음과 같습니다. \n\n주문과 쿠폰 엔티티가 있다.\n주문 시 쿠폰을 적용해서 할인받을 수 있다.\n주문과 쿠폰 관계는 1:1 관계 즉 OneToOne 관계이다.\n\n주의 깊게 살펴볼 내용은 다음과 같습니다.\n\n외래 키는 어디 테이블에 두는 것이 좋은가?\n양방향 연관 관계 편의 메소드\n제약 조건으로 인한 안정성 및 성능 향상\n\nEntity 객체#1234567891011121314151617181920212223242526272829public class Coupon &#123;    @Id    @GeneratedValue    private long id;    @Column(name = &quot;discount_amount&quot;)    private double discountAmount;    @Column(name = &quot;use&quot;)    private boolean use;    @OneToOne()    private Order order;&#125;public class Order &#123;    @Id    @GeneratedValue    private long id;        @Column(name = &quot;price&quot;)    private double price;    @OneToOne    @JoinColumn()    private Coupon coupon;&#125;\n\n\n외래 키는 어디 테이블에 두는 것이 좋은가?#123456789101112131415// Order 가연관관계의 주인일 경우@OneToOne@JoinColumn(name = &quot;coupon_id&quot;, referencedColumnName = &quot;id&quot;)private Coupon coupon;@OneToOne(mappedBy = &quot;coupon&quot;)private Order order;// coupon이 연관관계의 주인일 경우 @OneToOne(mappedBy = &quot;order&quot;)private Coupon coupon;@OneToOne@JoinColumn(name = &quot;order_id&quot;, referencedColumnName = &quot;id&quot;)private Order order;\n\n일대다 관계에서는 다 쪽에서 외래 키를 관리 하게 되지만 상대적으로 일대일 관계 설정에는 외래 키를 어느 곳에 두어야 하는지를 생각을 해야 합니다. JPA 상에서는 외래 키가 갖는 쪽이 연관 관계의 주인이 되고연관 관계의 주인만이 데이터베이스 연관 관계와 매핑되고 왜래 키를 관리(등록, 수정, 삭제)할 수 있기 때문입니다.\nSample Code#123456789101112131415// 주문시 1,000 할인 쿠폰을 적용해본 간단한 코드입니다. public Order order() &#123;    final Order order = Order.builder().price(1_0000).build(); // 10,000 상품주문    Coupon coupon = couponService.findById(1); // 1,000 할인 쿠폰    order.applyCoupon(coupon);    return orderRepository.save(order);&#125;@Testpublic void order_쿠폰할인적용() &#123;    final Order order = orderService.order();    assertThat(order.getPrice(), is(9_000D)); // 1,000 할인 적용 확인    final Order findOrder = orderService.findOrder(order.getId());    System.out.println(&quot;couponId : &quot;+ findOrder.getCoupon().getId()); // couponId : 1 (coupon_id 외래 키를 저장 완료)&#125;\n\n\nOrder가 주인일 경우 장점 : INSERT SQL이 한번 실행#\n123456// order가 연관 관계의 주인일 경우 SQLinsert into orders (id, coupon_id, price) values (null, ?, ?) //coupon이 연관 관계의 주인일 경우 SQLinsert into orders (id, price) values (null, ?)update coupon set discount_amount=?, order_id=?, use=? where id=?\norder 테이블에 coupon_id 칼럼을 저장하기 때문에 주문 SQL은 한 번만 실행됩니다. 반면에 coupon이 연관 관계의 주인일 경우에는 coupon에 order의 외래 키가 있으니 order INSERT SQL 한 번, coupon 테이블에 order_id 칼럼 업데이트 쿼리 한번 총 2번의 쿼리가 실행됩니다. \n작은 장점으로는 데이터베이스 칼럼에 coupon_id 항목이 null이 아닌 경우 할인 쿠폰이 적용된 것으로 판단할 수 있습니다.\nOrder가 주인일 경우 단점 : 연관 관계 변경 시 취약#기존 요구사항은 주문 한 개에 쿠폰은 한 개만 적용 이 가는 했기 때문에 OneToOne 연관 관계를 맺었지만  하나의 주문에 여러 개의 쿠폰이 적용되는 기능이 추가되었을 때 변경하기 어렵다는 단점이 있습니다. \norder 테이블에 coupon_id 칼럼을 갖고 있어서 여러 개의 쿠폰을 적용하기 위해서는 coupon 테이블에서 order_id 칼럼을 가진 구조로 변경 해야 합니다. OneToMany 관계에서는 연관 관계의 주인은 왜래 키를 갖는 엔티티가 갖는 것이 바람직합니다. 비즈니스 로직 변경은 어려운 게 없으나 데이터베이스 칼럼들을 이전 해야 하기 때문에 실제 서비스 중인 프로젝트에는 상당히 골치 아프게 됩니다.\n장점이 단점이 되고 단점이 장점이 되기 때문에 Coupon 장단점을 정리하지 않았습니다.\n연관 관계의 주인 설정#OneToOne 관계를 맺으면 외래 키를 어디에 둘 것인지, 즉 연관 관계의 주인을 어디에 둘 것인지는 많은 고민이 필요 합니다. 제 개인적인 생각으로는 OneToMany로 변경될 가능성이 있는지를 판단하고 변경이 될 가능성이 있다고 판단되면 Many가 될 엔티티가 관계의 주인이 되는 것이 좋다고 봅니다. 또 애초에 OneToMany를 고려해서 초기 관계 설정을 OneToMany로 가져가는 것도 좋다고 생각합니다. \n그러니 이 연관 관계가 정말 OneToOne 관계인지 깊은 고민이 필요하고 해당 도메인에 대한 지식도 필요 하다고 생각합니다. 예를 들어 개인 송금 관계에서 입금 &amp;amplt-&amp;ampgt 출금 관계를 가질 경우 반드시 하나의 입금 당 하나의 출금을 갖게 되니 이것은 OneToOne 관계로 맺어가도 무리가 없다고 판단됩니다. (물론 아닌 때도 있습니다. 그래서 해당 도메인에 대한 지식이 필요 한다고 생각합니다)\n주인 설정이라고 하면 뭔가 더 중요한 것이 주인이 되어야 할 거 같다는 생각이 들지만 연관 관계의 주인이라는 것은 왜래 키의 위치와 관련해서 정해야 하지 해당 도메인의 중요성과는 상관관계가 없습니다.\n양방향 연관관계 편의 메소드#12345678910111213141516171819202122232425262728// Order가 연관관계의 주인일 경우 예제class Coupon &#123;    ...    // 연관관계 편의 메소드    public void use(final Order order) &#123;        this.order = order;        this.use = true;    &#125;&#125;class Order &#123;    private Coupon coupon; //(1)    ...    // 연관관계 편의 메소드    public void applyCoupon(final Coupon coupon) &#123;        this.coupon = coupon;        coupon.use(this);        price -= coupon.getDiscountAmount();    &#125;&#125;// 주문 생성시 1,000 할인 쿠폰 적용public Order order() &#123;    final Order order = Order.builder().price(1_0000).build(); // 10,000 상품주문    Coupon coupon = couponService.findById(1); // 1,000 할인 쿠폰    order.applyCoupon(coupon);    return orderRepository.save(order);&#125;\n연관 관계의 주인이 해당 참조할 객체를 넣어줘야 데이터베이스의 칼럼에 외래 키가 저장됩니다. 즉 Order가 연관 관계의 주인이면 (1)번 멤버 필드에 Coupon을 넣어줘야 데이터베이스 order 테이블에 coupon_id 칼럼에 저장됩니다.\n양방향 연관 관계일 경우 위처럼 연관 관계 편의 메소드를 작성하는 것이 좋습니다. 위에서 말했듯이 연관 관계의 주인만이 왜래 키를 관리 할 수 있으니 applyCoupon 메소드는 이해하는데 어렵지 않습니다.\n그렇다면 use 메서드에서에 데이터베이스에 저장하지도 않는 Order를 set을 왜 해주는 걸까요?\n1234567891011public void use(final Order order) &#123;//  this.order = order; 해당코드를 주석했을 때 테스트 코드    this.use = true;&#125; @Testpublic void use_메서드에_order_set_필요이유() &#123;    final Order order = orderService.order();    assertThat(order.getPrice(), is(9_000D)); // 1,000 할인 적용 확인    final Coupon coupon = order.getCoupon();    assertThat(coupon.getOrder(), is(notNullValue())); // 해당 검사는 실패한다.&#125;\norder를 바인딩하는 코드를 주석하고 해당 코드를 돌려보면 실패하게 됩니다. 일반적으로 생각했을 때 order 생성 시 1,000할인 쿠폰을 적용했기 때문에 해당 쿠폰에도 주문 객체가 들어갔을 거로 생각할 수 있습니다. 하지만 위의 주석시킨 코드가 그 기능을 담당했기 때문에 쿠폰 객체의 주문 값은 null인 상태입니다. 즉 순수한 객체까지 고려한 양방향 관계를 고려하는 것이 바람직하고 그것이 안전합니다.\n제약 조건으로 인한 안정 성 및 성능 향상#1234567public class Order &#123;    ...    @OneToOne    @JoinColumn(name = &quot;coupon_id&quot;, referencedColumnName = &quot;id&quot;, nullable = false)    private Coupon coupon;&#125;\n\n모든 주문에 할인 쿠폰이 적용된다면 @JoinColumn의 nullable 옵션을 false로 주는 것이 좋습니다. NOT NULL 제약 조건을 준수해서 안전성이 보장됩니다.\n\n\nnullable &#x3D; false 없는 경우, outer join\n\n\n\nnullable &#x3D; false 선언한 경우, inner join\n\n외래 키에 NOT NULL 제약 조건을 설정하면 값이 있는 것을 보장합니다. 따라서 JPA는 이때 내부조인을통해서 내부 조인 SQL을 만들어 주고 이것은 외부 조인보다 성능과 최적화에 더 좋습니다.\n물론 모든 경우에 적용할 수는 없고 반드시 외래 키가 NOT NULL인 조건에만 사용할 수 있습니다. 예를 들어 쿠폰과 회원 연관 관계가 있을 때 쿠폰은 반드시 회원의 외래 키를 참조하고 있어야 합니다. 이런 경우 유용하게 사용할 수 있습니다.\n","dateCreated":"2018-06-29T00:00:00+09:00","dateModified":"2025-02-02T18:20:44+09:00","datePublished":"2018-06-29T00:00:00+09:00","description":"OneToOne 관계 설정 시에 간단한 팁을 정리하겠습니다. 해당 객체들의 성격은 다음과 같습니다.","headline":"Spring JPA Best Practices Step-08 - OneToOne 관계 설정 팁","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheese10yun.github.io/spring-jpa-best-08/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"https://cheese10yun.github.io/spring-jpa-best-08/","keywords":"Spring, JPA, ORM"}</script>
    <meta name="description" content="OneToOne 관계 설정 시에 간단한 팁을 정리하겠습니다. 해당 객체들의 성격은 다음과 같습니다.">
<meta property="og:type" content="blog">
<meta property="og:title" content="Spring JPA Best Practices Step-08 - OneToOne 관계 설정 팁">
<meta property="og:url" content="https://cheese10yun.github.io/spring-jpa-best-08/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="OneToOne 관계 설정 시에 간단한 팁을 정리하겠습니다. 해당 객체들의 성격은 다음과 같습니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://i.imgur.com/k6V64ye.png">
<meta property="og:image" content="https://i.imgur.com/bHfKh8m.png">
<meta property="og:image" content="https://i.imgur.com/94To549.png">
<meta property="article:published_time" content="2018-06-28T15:00:00.000Z">
<meta property="article:modified_time" content="2025-02-02T09:20:44.293Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="JPA">
<meta property="article:tag" content="ORM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/k6V64ye.png">
    
    
        
    
    
        <meta property="og:image" content="https://cheese10yun.github.io/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5813739623204880" crossorigin="anonymous"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Spring JPA Best Practices Step-08 - OneToOne 관계 설정 팁
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2018-06-29T00:00:00+09:00">
	
		    2018/06/29
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>해당 코드는 <a target="_blank" rel="noopener" href="https://github.com/cheese10yun/spring-jpa-best-practices">Github</a>를 확인해주세요.</p>
<p>OneToOne 관계 설정 시에 간단한 팁을 정리하겠습니다. 해당 객체들의 성격은 다음과 같습니다. </p>
<ul>
<li>주문과 쿠폰 엔티티가 있다.</li>
<li>주문 시 쿠폰을 적용해서 할인받을 수 있다.</li>
<li>주문과 쿠폰 관계는 1:1 관계 즉 OneToOne 관계이다.</li>
</ul>
<p>주의 깊게 살펴볼 내용은 다음과 같습니다.</p>
<ul>
<li>외래 키는 어디 테이블에 두는 것이 좋은가?</li>
<li>양방향 연관 관계 편의 메소드</li>
<li>제약 조건으로 인한 안정성 및 성능 향상</li>
</ul>
<h2><span id="entity-gaegce">Entity 객체</span><a href="#entity-gaegce" class="header-anchor">#</a></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Coupon</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;discount_amount&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> discountAmount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;use&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> use;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToOne()</span></span><br><span class="line">    <span class="keyword">private</span> Order order;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;price&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> price;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn()</span></span><br><span class="line">    <span class="keyword">private</span> Coupon coupon;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2><span id="oerae-kineun-eodi-teibeule-duneun-geosi-joheunga">외래 키는 어디 테이블에 두는 것이 좋은가?</span><a href="#oerae-kineun-eodi-teibeule-duneun-geosi-joheunga" class="header-anchor">#</a></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Order 가연관관계의 주인일 경우</span></span><br><span class="line"><span class="meta">@OneToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name = &quot;coupon_id&quot;, referencedColumnName = &quot;id&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Coupon coupon;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OneToOne(mappedBy = &quot;coupon&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Order order;</span><br><span class="line"></span><br><span class="line"><span class="comment">// coupon이 연관관계의 주인일 경우 </span></span><br><span class="line"><span class="meta">@OneToOne(mappedBy = &quot;order&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Coupon coupon;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OneToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name = &quot;order_id&quot;, referencedColumnName = &quot;id&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Order order;</span><br></pre></td></tr></table></figure>

<p>일대다 관계에서는 다 쪽에서 외래 키를 관리 하게 되지만 상대적으로 일대일 관계 설정에는 외래 키를 어느 곳에 두어야 하는지를 생각을 해야 합니다. JPA 상에서는 외래 키가 갖는 쪽이 연관 관계의 주인이 되고<br><strong>연관 관계의 주인만이 데이터베이스 연관 관계와 매핑되고 왜래 키를 관리(등록, 수정, 삭제)할 수 있기 때문입니다.</strong></p>
<h2><span id="sample-code">Sample Code</span><a href="#sample-code" class="header-anchor">#</a></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 주문시 1,000 할인 쿠폰을 적용해본 간단한 코드입니다. </span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">order</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> Order.builder().price(<span class="number">1_0000</span>).build(); <span class="comment">// 10,000 상품주문</span></span><br><span class="line">    <span class="type">Coupon</span> <span class="variable">coupon</span> <span class="operator">=</span> couponService.findById(<span class="number">1</span>); <span class="comment">// 1,000 할인 쿠폰</span></span><br><span class="line">    order.applyCoupon(coupon);</span><br><span class="line">    <span class="keyword">return</span> orderRepository.save(order);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> order_쿠폰할인적용() &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.order();</span><br><span class="line">    assertThat(order.getPrice(), is(<span class="number">9_000D</span>)); <span class="comment">// 1,000 할인 적용 확인</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Order</span> <span class="variable">findOrder</span> <span class="operator">=</span> orderService.findOrder(order.getId());</span><br><span class="line">    System.out.println(<span class="string">&quot;couponId : &quot;</span>+ findOrder.getCoupon().getId()); <span class="comment">// couponId : 1 (coupon_id 외래 키를 저장 완료)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3><span id="orderga-juinil-gyeongu-jangjeom-insert-sqli-hanbeon-silhaeng">Order가 주인일 경우 장점 : INSERT SQL이 한번 실행</span><a href="#orderga-juinil-gyeongu-jangjeom-insert-sqli-hanbeon-silhaeng" class="header-anchor">#</a></h3><p><img src="https://i.imgur.com/k6V64ye.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> <span class="keyword">order</span>가 연관 관계의 주인일 경우 <span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">insert into</span> orders (id, coupon_id, price) <span class="keyword">values</span> (<span class="keyword">null</span>, ?, ?) </span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>coupon이 연관 관계의 주인일 경우 <span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">insert into</span> orders (id, price) <span class="keyword">values</span> (<span class="keyword">null</span>, ?)</span><br><span class="line"><span class="keyword">update</span> coupon <span class="keyword">set</span> discount_amount<span class="operator">=</span>?, order_id<span class="operator">=</span>?, use<span class="operator">=</span>? <span class="keyword">where</span> id<span class="operator">=</span>?</span><br></pre></td></tr></table></figure>
<p>order 테이블에 coupon_id 칼럼을 저장하기 때문에 주문 SQL은 한 번만 실행됩니다. 반면에 coupon이 연관 관계의 주인일 경우에는 coupon에 order의 외래 키가 있으니 order INSERT SQL 한 번, coupon 테이블에 order_id 칼럼 업데이트 쿼리 한번 총 2번의 쿼리가 실행됩니다. </p>
<p>작은 장점으로는 데이터베이스 칼럼에 coupon_id 항목이 null이 아닌 경우 할인 쿠폰이 적용된 것으로 판단할 수 있습니다.</p>
<h3><span id="orderga-juinil-gyeongu-danjeom-yeongwan-gwangye-byeongyeong-si-cwiyag">Order가 주인일 경우 단점 : 연관 관계 변경 시 취약</span><a href="#orderga-juinil-gyeongu-danjeom-yeongwan-gwangye-byeongyeong-si-cwiyag" class="header-anchor">#</a></h3><p>기존 요구사항은 주문 한 개에 쿠폰은 한 개만 적용 이 가는 했기 때문에 OneToOne 연관 관계를 맺었지만  <strong>하나의 주문에 여러 개의 쿠폰이 적용되는 기능이 추가되었을 때 변경하기 어렵다는 단점이 있습니다.</strong> </p>
<p>order 테이블에 coupon_id 칼럼을 갖고 있어서 여러 개의 쿠폰을 적용하기 위해서는 coupon 테이블에서 order_id 칼럼을 가진 구조로 변경 해야 합니다. <strong>OneToMany 관계에서는 연관 관계의 주인은 왜래 키를 갖는 엔티티가 갖는 것이 바람직합니다.</strong> 비즈니스 로직 변경은 어려운 게 없으나 데이터베이스 칼럼들을 이전 해야 하기 때문에 실제 서비스 중인 프로젝트에는 상당히 골치 아프게 됩니다.</p>
<p>장점이 단점이 되고 단점이 장점이 되기 때문에 Coupon 장단점을 정리하지 않았습니다.</p>
<h2><span id="yeongwan-gwangyeyi-juin-seoljeong">연관 관계의 주인 설정</span><a href="#yeongwan-gwangyeyi-juin-seoljeong" class="header-anchor">#</a></h2><p>OneToOne 관계를 맺으면 외래 키를 어디에 둘 것인지, 즉 연관 관계의 주인을 어디에 둘 것인지는 많은 고민이 필요 합니다. 제 개인적인 생각으로는 OneToMany로 변경될 가능성이 있는지를 판단하고 변경이 될 가능성이 있다고 판단되면 Many가 될 엔티티가 관계의 주인이 되는 것이 좋다고 봅니다. 또 애초에 OneToMany를 고려해서 초기 관계 설정을 OneToMany로 가져가는 것도 좋다고 생각합니다. </p>
<p>그러니 이 연관 관계가 정말 OneToOne 관계인지 깊은 고민이 필요하고 해당 도메인에 대한 지식도 필요 하다고 생각합니다. 예를 들어 개인 송금 관계에서 입금 &amp;amplt-&amp;ampgt 출금 관계를 가질 경우 반드시 하나의 입금 당 하나의 출금을 갖게 되니 이것은 OneToOne 관계로 맺어가도 무리가 없다고 판단됩니다. (물론 아닌 때도 있습니다. 그래서 해당 도메인에 대한 지식이 필요 한다고 생각합니다)</p>
<p><strong>주인 설정이라고 하면 뭔가 더 중요한 것이 주인이 되어야 할 거 같다는 생각이 들지만 연관 관계의 주인이라는 것은 왜래 키의 위치와 관련해서 정해야 하지 해당 도메인의 중요성과는 상관관계가 없습니다.</strong></p>
<h2><span id="yangbanghyang-yeongwangwangye-pyeonyi-mesodeu">양방향 연관관계 편의 메소드</span><a href="#yangbanghyang-yeongwangwangye-pyeonyi-mesodeu" class="header-anchor">#</a></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Order가 연관관계의 주인일 경우 예제</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Coupon</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 연관관계 편의 메소드</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">use</span><span class="params">(<span class="keyword">final</span> Order order)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.order = order;</span><br><span class="line">        <span class="built_in">this</span>.use = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Coupon coupon; <span class="comment">//(1)</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 연관관계 편의 메소드</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">applyCoupon</span><span class="params">(<span class="keyword">final</span> Coupon coupon)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.coupon = coupon;</span><br><span class="line">        coupon.use(<span class="built_in">this</span>);</span><br><span class="line">        price -= coupon.getDiscountAmount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 주문 생성시 1,000 할인 쿠폰 적용</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">order</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> Order.builder().price(<span class="number">1_0000</span>).build(); <span class="comment">// 10,000 상품주문</span></span><br><span class="line">    <span class="type">Coupon</span> <span class="variable">coupon</span> <span class="operator">=</span> couponService.findById(<span class="number">1</span>); <span class="comment">// 1,000 할인 쿠폰</span></span><br><span class="line">    order.applyCoupon(coupon);</span><br><span class="line">    <span class="keyword">return</span> orderRepository.save(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>연관 관계의 주인이 해당 참조할 객체를 넣어줘야 데이터베이스의 칼럼에 외래 키가 저장됩니다. 즉 Order가 연관 관계의 주인이면 (1)번 멤버 필드에 Coupon을 넣어줘야 데이터베이스 order 테이블에 coupon_id 칼럼에 저장됩니다.</p>
<p>양방향 연관 관계일 경우 위처럼 연관 관계 편의 메소드를 작성하는 것이 좋습니다. 위에서 말했듯이 연관 관계의 주인만이 왜래 키를 관리 할 수 있으니 applyCoupon 메소드는 이해하는데 어렵지 않습니다.</p>
<p>그렇다면 use 메서드에서에 데이터베이스에 저장하지도 않는 Order를 set을 왜 해주는 걸까요?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">use</span><span class="params">(<span class="keyword">final</span> Order order)</span> &#123;</span><br><span class="line"><span class="comment">//  this.order = order; 해당코드를 주석했을 때 테스트 코드</span></span><br><span class="line">    <span class="built_in">this</span>.use = <span class="literal">true</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> use_메서드에_order_set_필요이유() &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.order();</span><br><span class="line">    assertThat(order.getPrice(), is(<span class="number">9_000D</span>)); <span class="comment">// 1,000 할인 적용 확인</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Coupon</span> <span class="variable">coupon</span> <span class="operator">=</span> order.getCoupon();</span><br><span class="line">    assertThat(coupon.getOrder(), is(notNullValue())); <span class="comment">// 해당 검사는 실패한다.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>order를 바인딩하는 코드를 주석하고 해당 코드를 돌려보면 실패하게 됩니다. 일반적으로 생각했을 때 order 생성 시 1,000할인 쿠폰을 적용했기 때문에 해당 쿠폰에도 주문 객체가 들어갔을 거로 생각할 수 있습니다. 하지만 위의 주석시킨 코드가 그 기능을 담당했기 때문에 쿠폰 객체의 주문 값은 null인 상태입니다. <strong>즉 순수한 객체까지 고려한 양방향 관계를 고려하는 것이 바람직하고 그것이 안전합니다.</strong></p>
<h2><span id="jeyag-jogeoneuro-inhan-anjeong-seong-mic-seongneung-hyangsang">제약 조건으로 인한 안정 성 및 성능 향상</span><a href="#jeyag-jogeoneuro-inhan-anjeong-seong-mic-seongneung-hyangsang" class="header-anchor">#</a></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;coupon_id&quot;, referencedColumnName = &quot;id&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Coupon coupon;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>모든 주문에 할인 쿠폰이 적용된다면 @JoinColumn의 nullable 옵션을 false로 주는 것이 좋습니다. <strong>NOT NULL 제약 조건을 준수해서 안전성이 보장됩니다.</strong></p>
<p><img src="https://i.imgur.com/bHfKh8m.png"></p>
<ul>
<li>nullable &#x3D; false 없는 경우, outer join</li>
</ul>
<p><img src="https://i.imgur.com/94To549.png"></p>
<ul>
<li>nullable &#x3D; false 선언한 경우, inner join</li>
</ul>
<p><strong>외래 키에 NOT NULL 제약 조건을 설정하면 값이 있는 것을 보장합니다. 따라서 JPA는 이때 내부조인을<br>통해서 내부 조인 SQL을 만들어 주고 이것은 외부 조인보다 성능과 최적화에 더 좋습니다.</strong></p>
<p>물론 모든 경우에 적용할 수는 없고 반드시 외래 키가 NOT NULL인 조건에만 사용할 수 있습니다. 예를 들어 쿠폰과 회원 연관 관계가 있을 때 쿠폰은 반드시 회원의 외래 키를 참조하고 있어야 합니다. 이런 경우 유용하게 사용할 수 있습니다.</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/JPA/" rel="tag">JPA</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/ORM/" rel="tag">ORM</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Spring/" rel="tag">Spring</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-oop-05/"
                    data-tooltip="Spring OOP 프로그래밍 예제(5) - 외부 API(PagerDuty) 호출"
                    aria-label="이전: Spring OOP 프로그래밍 예제(5) - 외부 API(PagerDuty) 호출"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/jackson-annotation-05/"
                    data-tooltip="Jackson 어노테이션 사용법(5)"
                    aria-label="다음: Jackson 어노테이션 사용법(5)"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-jpa-best-08/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-jpa-best-08/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        

                
                    <!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

                

            
        
    </div>
</article>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-oop-05/"
                    data-tooltip="Spring OOP 프로그래밍 예제(5) - 외부 API(PagerDuty) 호출"
                    aria-label="이전: Spring OOP 프로그래밍 예제(5) - 외부 API(PagerDuty) 호출"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/jackson-annotation-05/"
                    data-tooltip="Jackson 어노테이션 사용법(5)"
                    aria-label="다음: Jackson 어노테이션 사용법(5)"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-jpa-best-08/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-jpa-best-08/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-jpa-best-08/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-jpa-best-08/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>

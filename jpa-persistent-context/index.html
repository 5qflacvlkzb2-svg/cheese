
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Yun Blog">
    <title>JPA 영속성 컨텍스트 주의 점 - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"엔티티 객체123456789101112131415161718192021222324@Entity@Table(name = &quot;member&quot;)data class Member(        @Column(name = &quot;username&quot;, nullable = false)        var username: String,        @Column(name = &quot;age&quot;, nullable = false)        var age: Int = 0,        @ManyToOne(fetch = FetchType.LAZY, optional = false)        @JoinColumn(name = &quot;team_id&quot;, nullable = false)        var team: Team) : EntityAuditing()@Entity@Table(name = &quot;team&quot;)data class Team(        @Column(name = &quot;name&quot;, nullable = false)        var name: String) : EntityAuditing() &#123;    @OneToMany(mappedBy = &quot;team&quot;)    var members: MutableList&lt;Member&gt; = mutableListOf()  &#125;\n엔티티 관계는 위와 같습니다.\n테스트 코드12345678910111213141516171819202122232425262728293031323334353637import com.example.querydsl.domain.QMember.member as qMemberimport com.example.querydsl.domain.QTeam.team as qTeam@SpringBootTest@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)@Transactionalclass PersistenceContextTest(        private val em: EntityManager) &#123;    val query = JPAQueryFactory(em)    @Test    internal fun `persistence context test`() &#123;        //given        val teamA = Team(&quot;teamA&quot;)        em.persist(teamA)        val member1 = Member(username = &quot;member1&quot;, age = 10, team = teamA)        val member2 = Member(username = &quot;member2&quot;, age = 20, team = teamA)        em.persist(member1)        em.persist(member2)        //when        val team = query                .selectFrom(qTeam)                .join(qTeam.members, qMember).fetchJoin()                .where(qTeam.name.eq(&quot;teamA&quot;))                .fetchOne()!!        //then        val members = team.members        then(members).anySatisfy &#123;            then(it.username).isIn(&quot;member1&quot;, &quot;member2&quot;)        &#125;    &#125;&#125;\nteamA를 영속화 이후,\u001d member1, member2를 영속화를 진행합니다. member1, member2는 teamA 소속이 됩니다.\n그리고 fetch join통해서 teamA와 teamA에 속한 member를 조회하고 있습니다. 그리고 then절에서 member1, member2가 teamA에 있는지 검증을 진행합니다.\n이 테스트 코드는 실패합니다.\n\n디버깅 모드로 보면 memebers SIZE가 0인 것을 확인할 수 있습니다. 그렇다면 실제 데이터베이에 member1, member2가 영속화가 안 된 것일 까요?\n\nteamA insert, member1, memeber2 insert 쿼리를 확인할 수 있습니다. 물론 insert query log를 출력했더라도 실제 데이터베이스에 insert 됐다고는 볼 수 없습니다. 정확하게 테스트하기 위해서는 실제 데이터베이스에 저장됐는지 확인하는 것이 바람직합니다. 해당 경우는 실제 데이터베이스에 commit까지 되는 경우입니다.\n그렇다면 왜 해당 테스트 코드가 실패할까요? 그 이유를 알기 위해서는 영속성 컨텍스트의 1차 케시의 저장 메커니즘을 이해해야 합니다.\n영속성 컨텍스트 1차 캐시 저장 메커니즘\nfindById() 같은 경우는 영속성 컨텍스트를 먼저 찾고 영속성 컨텍스트에 해당 엔티티가 있으면 그 값을 바로 리턴합니다. 이를 1차 캐시라고 말합니다. 반면 JPQL은 영속성 컨텍스트를 먼저 조회하지 않고 데이터베이스에 query하여 결과를 가져옵니다. 그리고 아래와 같은 흐름으로 영속성 컨텍스트를 저장을 시도합니다.\n\nJPQL을 호출하면 데이터베이스에 우선적으로 조회한다.\n조회한 값을 영속성 컨텍스트에 저장을 시도한다.\n저장을 시도할 때 해당 데이터가 이미 영속성 컨텍스트에 존재하는 경우((영속성 컨텍스트에서는 식별자 값으로 식별)) 데이터베이스에서 조회한 신규 데이터를 버린다.\n\n테스트가 실패하는 이유\n123456789101112131415    ...    @Test    internal fun `persistence context test`() &#123;    //given    val teamA = Team(&quot;teamA&quot;)    em.persist(teamA)    val member1 = Member(username = &quot;member1&quot;, age = 10, team = teamA)    val member2 = Member(username = &quot;member2&quot;, age = 20, team = teamA)    em.persist(member1)    em.persist(member2)    ... &#125;\nteamA, member1, member2 영속화를 진행합니다. 이때 위 그림처럼 영속성 컨텍스트에 저장됩니다. \n그리고 아래 코드의 when 절을 보겠습니다.\n123456//whenval team = query        .selectFrom(qTeam)        .join(qTeam.members, qMember).fetchJoin()        .where(qTeam.name.eq(&quot;teamA&quot;))        .fetchOne()!!\n위에서 언급했던 것처럼 JPQL은 영속성 컨텍스트의 데이터를 조회하지 않고 데이터베이스에 아래의 query를 진행합니다.\n1234567891011121314151617181920select    team0_.id as id1_2_0_,    members1_.id as id1_1_1_,    team0_.created_at as created_2_2_0_,    team0_.updated_at as updated_3_2_0_,    team0_.name as name4_2_0_,    members1_.created_at as created_2_1_1_,    members1_.updated_at as updated_3_1_1_,    members1_.age as age4_1_1_,    members1_.team_id as team_id6_1_1_,    members1_.username as username5_1_1_,    members1_.team_id as team_id6_1_0__,    members1_.id as id1_1_0__ from    team team0_ inner join    member members1_         on team0_.id=members1_.team_id where    team0_.name=?\nfetch join를 사용했기 때문에 team, member 객체를 한번에 가져오게 됩니다. 하지만 teamA가 이미 존재 하므로 해당 쿼리를 통해서 가져온 데이터를 버리게 됩니다.\n해결 하는 방법Team 객체에 Member 추가하기12345678910111213141516@Testinternal fun `persistence context test`() &#123;    //given    val teamA = Team(&quot;teamA&quot;)    em.persist(teamA)    val member1 = Member(username = &quot;member1&quot;, age = 10, team = teamA)    val member2 = Member(username = &quot;member2&quot;, age = 20, team = teamA)    em.persist(member1)    em.persist(member2)    teamA.members.add(member1) // teamA에 member1 추가    teamA.members.add(member2) // teamA에 member2 추가    ...&#125;\nmember1, member2영속화 이후 teamA 객체에 영속화된 member 객체를 추가하는 코드를 작성하면 됩니다.\n그렇게 되면 fetch join을 통해서 데이터베이스에 query를 진행하고 해당 데이터가 영속성 컨텍스트에 이미 있으므로 데이터를 버리게 되더라도 이미 member1, memeber2가 존재하는 상태이기 때문에 문제가 되지 않습니다.\n양방향 연관 관계의 경우 편의 메서드를 작성해서 이런 문제를 미연에 방지하는 것이 좋습니다. 물론 필요에 따라서 양방향 양방향 연관 관계를 작성하는 것은 상관없지만 가능하면 단방향 연관 관계를 유지하는 것이 좋다고 생각합니다.\n양방향 관계가 되면 생각보다 신경 쓸 것이 많아지게 되어 복잡도가 증가하게 됩니다. 또 OneToMany, ManyToOne 같은 양방향 연관 관계의 경우 N+1 문제도 신경 쓸 것들이 많아지게 됩니다.\n영속성 컨텍스트 초기화12345678910111213141516171819@Testinternal fun `persistence context test`() &#123;    //given    val teamA = Team(&quot;teamA&quot;)    em.persist(teamA)    val member1 = Member(username = &quot;member1&quot;, age = 10, team = teamA)    val member2 = Member(username = &quot;member2&quot;, age = 20, team = teamA)    em.persist(member1)    em.persist(member2)//        teamA.members.add(member1)//        teamA.members.add(member2)        em.flush()    em.clear()    ...&#125;\nem.flush()을 통해서 영속성 컨텍스트의 내용을 데이터베이스에 반영하고 em.clear()을 통해서 영속성 컨텍스트를 모두 초기화 합니다.(영속성 컨텍스트의 데이터를 모두 제거) 영속성 컨텍스츠가 초기화 되었기 때문에 fetch join의 결과가 모두 영속성 컨텍스트의 반영됩니다.\n결론테스트 코드를 작성할 때 이런 점을 조심하자는 것이 중점은 아닙니다. 중점으로 다루고 싶었던 내용은 영속성 컨텍스트의 저장에 대한 메커니즘입니다. 이 부분은 명확하게 알고 있더라도 영속성 컨텍스트는 실제 보이는 영역이 아니기 때문에 실수하기 좋고  이런 실수를 하더라도 이것을 바로 캐치하기가 어렵습니다. 그래서 정리차 포스팅을 진행하게 되었습니다.\n참고\n자바 ORM 표준 JPA 프로그래밍\n\n","dateCreated":"2020-01-27T00:00:00+09:00","dateModified":"2025-01-31T04:44:51+09:00","datePublished":"2020-01-27T00:00:00+09:00","description":"JPA 영속성 컨텍스트 주의 점","headline":"JPA 영속성 컨텍스트 주의 점","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheese10yun.github.io/jpa-persistent-context/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"https://cheese10yun.github.io/jpa-persistent-context/","keywords":"JPA, ORM"}</script>
    <meta name="description" content="JPA 영속성 컨텍스트 주의 점">
<meta property="og:type" content="blog">
<meta property="og:title" content="JPA 영속성 컨텍스트 주의 점">
<meta property="og:url" content="https://cheese10yun.github.io/jpa-persistent-context/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="JPA 영속성 컨텍스트 주의 점">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/query-dsl/docs/images/team-members-result.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/query-dsl/docs/images/insert-result.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/query-dsl/docs/images/query-result-.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/query-dsl/docs/images/query-result-.png">
<meta property="article:published_time" content="2020-01-26T15:00:00.000Z">
<meta property="article:modified_time" content="2025-01-30T19:44:51.990Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="JPA">
<meta property="article:tag" content="ORM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/cheese10yun/blog-sample/raw/master/query-dsl/docs/images/team-members-result.png">
    
    
        
    
    
        <meta property="og:image" content="https://cheese10yun.github.io/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5813739623204880" crossorigin="anonymous"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="카테고리"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">카테고리</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="검색"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">검색</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            JPA 영속성 컨텍스트 주의 점
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-01-27T00:00:00+09:00">
	
		    2020/01/27
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h2 id="엔티티-객체"><a href="#엔티티-객체" class="headerlink" title="엔티티 객체"></a>엔티티 객체</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = <span class="string">&quot;member&quot;</span>)</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Member</span>(</span><br><span class="line">        <span class="meta">@Column(name = <span class="string">&quot;username&quot;</span>, nullable = false)</span></span><br><span class="line">        <span class="keyword">var</span> username: String,</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Column(name = <span class="string">&quot;age&quot;</span>, nullable = false)</span></span><br><span class="line">        <span class="keyword">var</span> age: <span class="built_in">Int</span> = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="meta">@ManyToOne(fetch = FetchType.LAZY, optional = false)</span></span><br><span class="line">        <span class="meta">@JoinColumn(name = <span class="string">&quot;team_id&quot;</span>, nullable = false)</span></span><br><span class="line">        <span class="keyword">var</span> team: Team</span><br><span class="line">) : EntityAuditing()</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = <span class="string">&quot;team&quot;</span>)</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Team</span>(</span><br><span class="line">        <span class="meta">@Column(name = <span class="string">&quot;name&quot;</span>, nullable = false)</span></span><br><span class="line">        <span class="keyword">var</span> name: String</span><br><span class="line">) : EntityAuditing() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany(mappedBy = <span class="string">&quot;team&quot;</span>)</span></span><br><span class="line">    <span class="keyword">var</span> members: MutableList&lt;Member&gt; = mutableListOf()  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>엔티티 관계는 위와 같습니다.</p>
<h2 id="테스트-코드"><a href="#테스트-코드" class="headerlink" title="테스트 코드"></a>테스트 코드</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.querydsl.domain.QMember.member <span class="keyword">as</span> qMember</span><br><span class="line"><span class="keyword">import</span> com.example.querydsl.domain.QTeam.team <span class="keyword">as</span> qTeam</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PersistenceContextTest</span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> em: EntityManager</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> query = JPAQueryFactory(em)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `persistence context test`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//given</span></span><br><span class="line">        <span class="keyword">val</span> teamA = Team(<span class="string">&quot;teamA&quot;</span>)</span><br><span class="line">        em.persist(teamA)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> member1 = Member(username = <span class="string">&quot;member1&quot;</span>, age = <span class="number">10</span>, team = teamA)</span><br><span class="line">        <span class="keyword">val</span> member2 = Member(username = <span class="string">&quot;member2&quot;</span>, age = <span class="number">20</span>, team = teamA)</span><br><span class="line">        em.persist(member1)</span><br><span class="line">        em.persist(member2)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//when</span></span><br><span class="line">        <span class="keyword">val</span> team = query</span><br><span class="line">                .selectFrom(qTeam)</span><br><span class="line">                .join(qTeam.members, qMember).fetchJoin()</span><br><span class="line">                .<span class="keyword">where</span>(qTeam.name.eq(<span class="string">&quot;teamA&quot;</span>))</span><br><span class="line">                .fetchOne()!!</span><br><span class="line"></span><br><span class="line">        <span class="comment">//then</span></span><br><span class="line">        <span class="keyword">val</span> members = team.members</span><br><span class="line">        then(members).anySatisfy &#123;</span><br><span class="line">            then(it.username).isIn(<span class="string">&quot;member1&quot;</span>, <span class="string">&quot;member2&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>teamA</code>를 영속화 이후, <code>member1</code>, <code>member2</code>를 영속화를 진행합니다. <code>member1</code>, <code>member2</code>는 <code>teamA</code> 소속이 됩니다.</p>
<p>그리고 <code>fetch join</code>통해서 <code>teamA</code>와 <code>teamA</code>에 속한 <code>member</code>를 조회하고 있습니다. 그리고 <code>then</code>절에서 <code>member1</code>, <code>member2</code>가 <code>teamA</code>에 있는지 검증을 진행합니다.</p>
<p><strong>이 테스트 코드는 실패합니다.</strong></p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/query-dsl/docs/images/team-members-result.png"></p>
<p>디버깅 모드로 보면 <code>memebers</code> SIZE가 0인 것을 확인할 수 있습니다. 그렇다면 실제 데이터베이에 <code>member1</code>, <code>member2</code>가 영속화가 안 된 것일 까요?</p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/query-dsl/docs/images/insert-result.png"></p>
<p><code>teamA</code> insert, <code>member1</code>, <code>memeber2</code> insert 쿼리를 확인할 수 있습니다. 물론 insert query log를 출력했더라도 실제 데이터베이스에 insert 됐다고는 볼 수 없습니다. <strong>정확하게 테스트하기 위해서는 실제 데이터베이스에 저장됐는지 확인하는 것이 바람직합니다.</strong> 해당 경우는 실제 데이터베이스에 commit까지 되는 경우입니다.</p>
<p>그렇다면 왜 해당 테스트 코드가 실패할까요? 그 이유를 알기 위해서는 영속성 컨텍스트의 1차 케시의 저장 메커니즘을 이해해야 합니다.</p>
<h2 id="영속성-컨텍스트-1차-캐시-저장-메커니즘"><a href="#영속성-컨텍스트-1차-캐시-저장-메커니즘" class="headerlink" title="영속성 컨텍스트 1차 캐시 저장 메커니즘"></a>영속성 컨텍스트 1차 캐시 저장 메커니즘</h2><p><img src="https://github.com/cheese10yun/blog-sample/raw/master/query-dsl/docs/images/query-result-.png"></p>
<p><code>findById()</code> 같은 경우는 영속성 컨텍스트를 먼저 찾고 영속성 컨텍스트에 해당 엔티티가 있으면 그 값을 바로 리턴합니다. 이를 1차 캐시라고 말합니다. <strong>반면 JPQL은 영속성 컨텍스트를 먼저 조회하지 않고 데이터베이스에 query하여 결과를 가져옵니다.</strong> 그리고 아래와 같은 흐름으로 영속성 컨텍스트를 저장을 시도합니다.</p>
<ol>
<li><strong>JPQL을 호출하면 데이터베이스에 우선적으로 조회한다.</strong></li>
<li>조회한 값을 영속성 컨텍스트에 저장을 시도한다.</li>
<li><strong>저장을 시도할 때 해당 데이터가 이미 영속성 컨텍스트에 존재하는 경우((영속성 컨텍스트에서는 식별자 값으로 식별)) 데이터베이스에서 조회한 신규 데이터를 버린다.</strong></li>
</ol>
<h2 id="테스트가-실패하는-이유"><a href="#테스트가-실패하는-이유" class="headerlink" title="테스트가 실패하는 이유"></a>테스트가 실패하는 이유</h2><p><img src="https://github.com/cheese10yun/blog-sample/raw/master/query-dsl/docs/images/query-result-.png"></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `persistence context test`<span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//given</span></span><br><span class="line">    <span class="keyword">val</span> teamA = Team(<span class="string">&quot;teamA&quot;</span>)</span><br><span class="line">    em.persist(teamA)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> member1 = Member(username = <span class="string">&quot;member1&quot;</span>, age = <span class="number">10</span>, team = teamA)</span><br><span class="line">    <span class="keyword">val</span> member2 = Member(username = <span class="string">&quot;member2&quot;</span>, age = <span class="number">20</span>, team = teamA)</span><br><span class="line">    em.persist(member1)</span><br><span class="line">    em.persist(member2)</span><br><span class="line"></span><br><span class="line">    ... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>teamA</code>, <code>member1</code>, <code>member2</code> 영속화를 진행합니다. 이때 위 그림처럼 영속성 컨텍스트에 저장됩니다. </p>
<p>그리고 아래 코드의 <code>when</code> 절을 보겠습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//when</span></span><br><span class="line"><span class="keyword">val</span> team = query</span><br><span class="line">        .selectFrom(qTeam)</span><br><span class="line">        .join(qTeam.members, qMember).fetchJoin()</span><br><span class="line">        .<span class="keyword">where</span>(qTeam.name.eq(<span class="string">&quot;teamA&quot;</span>))</span><br><span class="line">        .fetchOne()!!</span><br></pre></td></tr></table></figure>
<p>위에서 언급했던 것처럼 JPQL은 영속성 컨텍스트의 데이터를 조회하지 않고 <strong>데이터베이스에 아래의 query를 진행합니다.</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    team0_.id <span class="keyword">as</span> id1_2_0_,</span><br><span class="line">    members1_.id <span class="keyword">as</span> id1_1_1_,</span><br><span class="line">    team0_.created_at <span class="keyword">as</span> created_2_2_0_,</span><br><span class="line">    team0_.updated_at <span class="keyword">as</span> updated_3_2_0_,</span><br><span class="line">    team0_.name <span class="keyword">as</span> name4_2_0_,</span><br><span class="line">    members1_.created_at <span class="keyword">as</span> created_2_1_1_,</span><br><span class="line">    members1_.updated_at <span class="keyword">as</span> updated_3_1_1_,</span><br><span class="line">    members1_.age <span class="keyword">as</span> age4_1_1_,</span><br><span class="line">    members1_.team_id <span class="keyword">as</span> team_id6_1_1_,</span><br><span class="line">    members1_.username <span class="keyword">as</span> username5_1_1_,</span><br><span class="line">    members1_.team_id <span class="keyword">as</span> team_id6_1_0__,</span><br><span class="line">    members1_.id <span class="keyword">as</span> id1_1_0__ </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    team team0_ </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">    <span class="keyword">member</span> members1_ </span><br><span class="line">        <span class="keyword">on</span> team0_.id<span class="operator">=</span>members1_.team_id </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    team0_.name<span class="operator">=</span>?</span><br></pre></td></tr></table></figure>
<p><code>fetch join</code>를 사용했기 때문에 <code>team</code>, <code>member</code> 객체를 한번에 가져오게 됩니다. <strong>하지만 <code>teamA</code>가 이미 존재 하므로 해당 쿼리를 통해서 가져온 데이터를 버리게 됩니다.</strong></p>
<h2 id="해결-하는-방법"><a href="#해결-하는-방법" class="headerlink" title="해결 하는 방법"></a>해결 하는 방법</h2><h3 id="Team-객체에-Member-추가하기"><a href="#Team-객체에-Member-추가하기" class="headerlink" title="Team 객체에 Member 추가하기"></a>Team 객체에 Member 추가하기</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `persistence context test`<span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//given</span></span><br><span class="line">    <span class="keyword">val</span> teamA = Team(<span class="string">&quot;teamA&quot;</span>)</span><br><span class="line">    em.persist(teamA)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> member1 = Member(username = <span class="string">&quot;member1&quot;</span>, age = <span class="number">10</span>, team = teamA)</span><br><span class="line">    <span class="keyword">val</span> member2 = Member(username = <span class="string">&quot;member2&quot;</span>, age = <span class="number">20</span>, team = teamA)</span><br><span class="line">    em.persist(member1)</span><br><span class="line">    em.persist(member2)</span><br><span class="line"></span><br><span class="line">    teamA.members.add(member1) <span class="comment">// teamA에 member1 추가</span></span><br><span class="line">    teamA.members.add(member2) <span class="comment">// teamA에 member2 추가</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>member1</code>, <code>member2</code>영속화 이후 <code>teamA</code> 객체에 영속화된 member 객체를 추가하는 코드를 작성하면 됩니다.</p>
<p>그렇게 되면 <code>fetch join</code>을 통해서 데이터베이스에 query를 진행하고 해당 데이터가 영속성 컨텍스트에 이미 있으므로 <strong>데이터를 버리게 되더라도 이미 <code>member1</code>, <code>memeber2</code>가 존재하는 상태이기 때문에 문제가 되지 않습니다.</strong></p>
<p>양방향 연관 관계의 경우 편의 메서드를 작성해서 이런 문제를 미연에 방지하는 것이 좋습니다. 물론 필요에 따라서 양방향 양방향 연관 관계를 작성하는 것은 상관없지만 <strong>가능하면 단방향 연관 관계를 유지하는 것이 좋다고 생각합니다.</strong></p>
<p>양방향 관계가 되면 생각보다 신경 쓸 것이 많아지게 되어 복잡도가 증가하게 됩니다. 또 <code>OneToMany</code>, <code>ManyToOne</code> 같은 양방향 연관 관계의 경우 N+1 문제도 신경 쓸 것들이 많아지게 됩니다.</p>
<h3 id="영속성-컨텍스트-초기화"><a href="#영속성-컨텍스트-초기화" class="headerlink" title="영속성 컨텍스트 초기화"></a>영속성 컨텍스트 초기화</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `persistence context test`<span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//given</span></span><br><span class="line">    <span class="keyword">val</span> teamA = Team(<span class="string">&quot;teamA&quot;</span>)</span><br><span class="line">    em.persist(teamA)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> member1 = Member(username = <span class="string">&quot;member1&quot;</span>, age = <span class="number">10</span>, team = teamA)</span><br><span class="line">    <span class="keyword">val</span> member2 = Member(username = <span class="string">&quot;member2&quot;</span>, age = <span class="number">20</span>, team = teamA)</span><br><span class="line">    em.persist(member1)</span><br><span class="line">    em.persist(member2)</span><br><span class="line"></span><br><span class="line"><span class="comment">//        teamA.members.add(member1)</span></span><br><span class="line"><span class="comment">//        teamA.members.add(member2)</span></span><br><span class="line">    </span><br><span class="line">    em.flush()</span><br><span class="line">    em.clear()</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>em.flush()</code>을 통해서 영속성 컨텍스트의 내용을 데이터베이스에 반영하고 <strong><code>em.clear()</code>을 통해서 영속성 컨텍스트를 모두 초기화 합니다.(영속성 컨텍스트의 데이터를 모두 제거)</strong> 영속성 컨텍스츠가 초기화 되었기 때문에 <code>fetch join</code>의 결과가 모두 영속성 컨텍스트의 반영됩니다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>테스트 코드를 작성할 때 이런 점을 조심하자는 것이 중점은 아닙니다. 중점으로 다루고 싶었던 내용은 영속성 컨텍스트의 저장에 대한 메커니즘입니다. 이 부분은 명확하게 알고 있더라도 영속성 컨텍스트는 실제 보이는 영역이 아니기 때문에 실수하기 좋고  이런 실수를 하더라도 이것을 바로 캐치하기가 어렵습니다. 그래서 정리차 포스팅을 진행하게 되었습니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a target="_blank" rel="noopener" href="http://acornpub.co.kr/book/jpa-programmig">자바 ORM 표준 JPA 프로그래밍</a></li>
</ul>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/JPA/" rel="tag">JPA</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/ORM/" rel="tag">ORM</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/jpa-flush/"
                    data-tooltip="JPA 플러시 정리"
                    aria-label="이전: JPA 플러시 정리"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/application-event/"
                    data-tooltip="스프링 Application Event"
                    aria-label="다음: 스프링 Application Event"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/jpa-persistent-context/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/jpa-persistent-context/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://cheese10yun.github.io/jpa-persistent-context/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>


<!-- Comment -->
<!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/jpa-flush/"
                    data-tooltip="JPA 플러시 정리"
                    aria-label="이전: JPA 플러시 정리"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/application-event/"
                    data-tooltip="스프링 Application Event"
                    aria-label="다음: 스프링 Application Event"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/jpa-persistent-context/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/jpa-persistent-context/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://cheese10yun.github.io/jpa-persistent-context/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/jpa-persistent-context/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/jpa-persistent-context/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://cheese10yun.github.io/jpa-persistent-context/"
                        aria-label="Google+에 공유하기"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Google+에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>

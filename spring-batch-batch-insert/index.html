
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="naver-site-verification" content="a37ea649edf26e70c3de94f9cb034f9d6e11de3f" />
    <meta name="generator" content="Yun Blog">
    <title>Batch Insert 성능 향상기 2편 - 성능 측정 - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"JPA + MySQL + GenerationType.IDENTITY 조합으로는 Batch Insert를 사용할 수 없습니다. 자세한 내용은 Batch Insert 성능 향상기 1편 - With JPA에서 자세하게 정리했습니다.\nJPA의 단일 insert와, batch insert의 성능적인 차이가 얼마나 발생하는지 측정해보고 batch insert를 지원하는 새로운 솔루션을 찾아 성능 측정을 진행한 포스팅입니다.\n다른 솔루션 찾기솔루션에 대한 요구사항\nSQL 관련 작업들을 문자열로 처리하지 하지 않고 DSL 표현하며 DSL 표현이 풍부할 것\nBatch Insert 외에도 조회 작업 등에도 사용이 용이할 것\nJDBC addBatch() 직접 호출하는 코드와 성능적인 차이가 거의 없을 것\n\nExposed결론부터 말씀드리면 Exposed라는 도구를 선택했습니다. Batch Insert를 지원하며 DSL을 잘 지원해 JPA에서 사용 못 하는 쿼리를 진행할 수 있는 장점이 있습니다. Exposed에 대한 소개는 다음 포스팅에 진행해 보겠습니다.\nBatch Code123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106const val GLOBAL_CHUNK_SIZE = 1_000const val DATA_SET_UP_SIZE = 5_000_000@Configurationclass BulkInsertJobConfiguration(    private val jobBuilderFactory: JobBuilderFactory,    private val jobDataSetUpListener: JobDataSetUpListener,    private val dataSource: DataSource,    private val exposedDataBase: Database,    private val paymentBackJpaRepository: PaymentBackJpaRepository,    entityManagerFactory: EntityManagerFactory) &#123;    @Bean    fun bulkInsertJob(        jdbcTemplateInsertStep: Step    ): Job =        jobBuilderFactory[&quot;bulkInsertJob&quot;]            .incrementer(RunIdIncrementer())            .listener(jobDataSetUpListener) // payment 데이터 setup            .start(jdbcTemplateInsertStep)            .build()    @Bean    @JobScope    fun bulkInsertStep(        stepBuilderFactory: StepBuilderFactory,        bulkInsertReader: JpaCursorItemReader&lt;Payment&gt;    ): Step =        stepBuilderFactory[&quot;bulkInsertStep&quot;]            .chunk&lt;Payment, Payment&gt;(GLOBAL_CHUNK_SIZE)            .reader(bulkInsertReader) // Reader는 JpaCursorItemReader 기반으로 조회//            .writer(writerWithStatement) // Statement addBatch() 기반 저장             .writer(writerWithExposed) // Exposed 기반 저장//            .writer(writerWithJpa) // JPA 기반 저장            .build()    @Bean    @StepScope    fun bulkInsertReader(        entityManagerFactory: EntityManagerFactory    ) = JpaCursorItemReaderBuilder&lt;Payment&gt;()        .name(&quot;bulkInsertReader&quot;)        .entityManagerFactory(entityManagerFactory)        .queryString(&quot;SELECT p FROM Payment p&quot;)        .build()    private val writerWithStatement: ItemWriter&lt;Payment&gt; = ItemWriter &#123; payments -&gt;        val sql = &quot;insert into payment_back (amount, order_id) values (?, ?)&quot;        val connection = dataSource.connection        val statement = connection.prepareStatement(sql)!!        try &#123;            for (payment in payments) &#123;                statement.apply &#123;                    this.setBigDecimal(1, payment.amount)                    this.setLong(2, payment.orderId)                    this.addBatch()                &#125;            &#125;            statement.executeBatch()        &#125; catch (e: Exception) &#123;            throw e        &#125; finally &#123;            if (statement.isClosed.not()) &#123;                statement.close()            &#125;            if (connection.isClosed.not()) &#123;                connection.close()            &#125;        &#125;    &#125;    private val writerWithJpa: ItemWriter&lt;Payment&gt; =        ItemWriter &#123; payments -&gt;            payments.map &#123; payment -&gt;                PaymentBackJpa(                    amount = payment.amount,                    orderId = payment.orderId                )            &#125;                .also &#123;                    paymentBackJpaRepository.saveAll(it)                &#125;        &#125;    private val writerWithExposed: ItemWriter&lt;Payment&gt; = ItemWriter &#123; payments -&gt;        transaction(            exposedDataBase        ) &#123;            PaymentBack.batchInsert(                data = payments,                shouldReturnGeneratedValues = false            ) &#123; payment -&gt;                this[PaymentBack.orderId] = payment.orderId                this[PaymentBack.amount] = payment.amount            &#125;        &#125;    &#125;&#125;object PaymentBack : LongIdTable(name = &quot;payment_back&quot;) &#123;    val amount = decimal(&quot;amount&quot;, 19, 4)    val orderId = long(&quot;order_id&quot;)&#125;\n\nSpring Batch 기반으로 payment 테이블을 N 개 읽어서 payment_back 테이블로 저장하는 흐름입니다. Reader는 JpaCursorItemReader 기반으로 payment 테이블을 조회합니다. 그리고 각 저장하는 wirter 코드들이 있습니다. writerWithExposed() 메서드는 Exposed 라이브러리에서 지원하는 batchInsert()메서드를 이용해서 insert를 진행하고 있습니다.\nExposed Batch Insert1234567891011transaction(    exposedDataBase) &#123;    PaymentBack.batchInsert(        data = payments,        shouldReturnGeneratedValues = false    ) &#123; payment -&gt;        this[PaymentBack.orderId] = payment.orderId        this[PaymentBack.amount] = payment.amount    &#125;&#125;\nExposed는 batchInsert() 메서드를 지원하기 때문에 쉽게 batch insert를 진행할 수 있습니다. Mysql의 경우 JDBC 드라이버에 rewriteBatchedStatements=true 속성을 반드시 입력해야 batch insert가 가능합니다. shouldReturnGeneratedValues 값을 false로 지정하면 auto_increment으로 증가된 ID 값을 가져오지 않기에 성능이 향상될 수 있습니다.\nInsert 성능 측정Insert에 대한 성능 측정은 JPA, Statement, Exposed 3가지 라이브러리로 진행하겠습니다. JPA는 단건으로 저장하며, Statement는 문자열 기반으로 addBatch()를 직접 호출, Exposed는 자체적으로 지원하는 Batch Insert를 진행합니다.\n해당 속도 측정은 JpaCursorItemReader 기반으로 조회하는 시간까지 포함된 시간입니다. 수백수만 데이터를 한 번에 저장하는 경우는 보다 페이징 처리를 진행해서 저장하는 것이 일반적이기도 하고 모두 동일한 Reader를 사용했기 때문에 비율은 동일하게 측정됩니다. 측정 단위는 모두 ms입니다.\nchunk size &#x3D; 1,000\n\n\n\nrows\nJPA\nStatement\nExposed\n\n\n\n10,000\n9278\n577\n890\n\n\n50,000\n53330\n2632\n3119\n\n\n100,000\n108460(1.8 min)\n3470\n4820\n\n\n500,000\n561756(9.3 min)\n14693\n21154\n\n\n1,000,000\n1163130(19.3 min)\n28633\n46533\n\n\n5,000,000\n5452635(90.8 min)\n140117(2.3 min)\n227203(3.7 min)\n\n\n10,000,000\nx\n282603(4.7 min)\n438349(7.3 min)\n\n\nrows 10,000,000 측정은 너무 오래 걸려 진행하지 못했습니다. 5,000,000 보다 약 2배 정도 10905270 ms (181 min) 정도 예상됩니다. JPA 성능 측정은 더 이상 의미가 없을 거 같아서 Statement, Exposed를 chunk size 기준으로 진행하겠습니다.\nchunk size &#x3D; 5,000\n\n\n\nrows\nStatement\nExposed\n\n\n\n10,000\n415\n787\n\n\n50,000\n1454\n2569\n\n\n100,000\n2681\n3777\n\n\n500,000\n10607\n17911\n\n\n1,000,000\n22378\n33637\n\n\n5,000,000\n105275\n165472\n\n\n10,000,000\n215456\n311385\n\n\nchunk size &#x3D; 10,000\n\n\n\nrows\nStatement\nExposed\n\n\n\n10,000\n421\n879\n\n\n50,000\n1713\n2582\n\n\n100,000\n2636\n4101\n\n\n500,000\n10959\n15479\n\n\n1,000,000\n21159\n33711\n\n\n5,000,000\n105478\n150009\n\n\n10,000,000\n205380\n308874\n\n\n정리JPA(단일 insert)와 성능은 비교 자체가 되지 않으며, 자바 코드와, 데이터베이스가 동일하지 않은 네트워크 환경에서는 IO 작업이 더 많이 발생하기 때문에 위 성능 측정보다 안 좋은 결과가 예상됩니다.\nExposed도 내부적으로 addBatch()를 사용해서 batch insert를 진행하는데도 불과하고 대략 30%성능의 차이를 보였습니다. Statement 보다 느린 부분은 사실이지만 절대적인 성능 자체가 둘 모두 빠르기에 (10,000,000 기준 1분 40초 차이) 속도적인 측면보다는 개발 및 유지 보수 측면에서 Exposed가 더 좋다고 판단했습니다.\n그리고 chunk size 5,000, 10,000 각각 측정해 본 결과 Exposed가 조금 더 효율적으로 성능이 향상되었습니다. 물론 모든 측정은 로컬 환경에서 진행한 것이니 절대적인 수치보다는 각 rows 별 JPA, Statement, Exposed의 비율을 보는 게 더 바람직합니다.\n","dateCreated":"2021-02-27T00:00:00+09:00","dateModified":"2025-02-01T16:59:04+09:00","datePublished":"2021-02-27T00:00:00+09:00","description":"JPA + MySQL + GenerationType.IDENTITY 조합으로는 Batch Insert를 사용할 수 없습니다. 자세한 내용은 Batch Insert 성능 향상기 1편 - With JPA에서 자세하게 정리했습니다.","headline":"Batch Insert 성능 향상기 2편 - 성능 측정","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheese10yun.github.io/spring-batch-batch-insert/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"https://cheese10yun.github.io/spring-batch-batch-insert/","keywords":"JPA, ORM, Exposed, Performance"}</script>
    <meta name="description" content="JPA + MySQL + GenerationType.IDENTITY 조합으로는 Batch Insert를 사용할 수 없습니다. 자세한 내용은 Batch Insert 성능 향상기 1편 - With JPA에서 자세하게 정리했습니다.">
<meta property="og:type" content="blog">
<meta property="og:title" content="Batch Insert 성능 향상기 2편 - 성능 측정">
<meta property="og:url" content="https://cheese10yun.github.io/spring-batch-batch-insert/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="JPA + MySQL + GenerationType.IDENTITY 조합으로는 Batch Insert를 사용할 수 없습니다. 자세한 내용은 Batch Insert 성능 향상기 1편 - With JPA에서 자세하게 정리했습니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/chunk_size_1000.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/chunk_size_5000.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/chunk_size_100000.png">
<meta property="article:published_time" content="2021-02-26T15:00:00.000Z">
<meta property="article:modified_time" content="2025-02-01T07:59:04.976Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="JPA">
<meta property="article:tag" content="ORM">
<meta property="article:tag" content="Exposed">
<meta property="article:tag" content="Performance">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/chunk_size_1000.png">
    
    
        
    
    
        <meta property="og:image" content="https://cheese10yun.github.io/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5813739623204880" crossorigin="anonymous"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Batch Insert 성능 향상기 2편 - 성능 측정
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2021-02-27T00:00:00+09:00">
	
		    2021/02/27
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>JPA + MySQL + GenerationType.IDENTITY 조합으로는 Batch Insert를 사용할 수 없습니다. 자세한 내용은 <a href="https://cheese10yun.github.io/jpa-batch-insert/">Batch Insert 성능 향상기 1편 - With JPA</a>에서 자세하게 정리했습니다.</p>
<p>JPA의 단일 insert와, batch insert의 성능적인 차이가 얼마나 발생하는지 측정해보고 batch insert를 지원하는 새로운 솔루션을 찾아 성능 측정을 진행한 포스팅입니다.</p>
<h2 id="다른-솔루션-찾기"><a href="#다른-솔루션-찾기" class="headerlink" title="다른 솔루션 찾기"></a>다른 솔루션 찾기</h2><h3 id="솔루션에-대한-요구사항"><a href="#솔루션에-대한-요구사항" class="headerlink" title="솔루션에 대한 요구사항"></a>솔루션에 대한 요구사항</h3><ul>
<li>SQL 관련 작업들을 문자열로 처리하지 하지 않고 DSL 표현하며 DSL 표현이 풍부할 것</li>
<li>Batch Insert 외에도 조회 작업 등에도 사용이 용이할 것</li>
<li>JDBC <code>addBatch()</code> 직접 호출하는 코드와 성능적인 차이가 거의 없을 것</li>
</ul>
<h3 id="Exposed"><a href="#Exposed" class="headerlink" title="Exposed"></a>Exposed</h3><p>결론부터 말씀드리면 <a target="_blank" rel="noopener" href="https://github.com/JetBrains/Exposed">Exposed</a>라는 도구를 선택했습니다. Batch Insert를 지원하며 DSL을 잘 지원해 JPA에서 사용 못 하는 쿼리를 진행할 수 있는 장점이 있습니다. Exposed에 대한 소개는 다음 포스팅에 진행해 보겠습니다.</p>
<h3 id="Batch-Code"><a href="#Batch-Code" class="headerlink" title="Batch Code"></a>Batch Code</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> GLOBAL_CHUNK_SIZE = <span class="number">1_000</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> DATA_SET_UP_SIZE = <span class="number">5_000_000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BulkInsertJobConfiguration</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> jobBuilderFactory: JobBuilderFactory,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> jobDataSetUpListener: JobDataSetUpListener,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> dataSource: DataSource,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> exposedDataBase: Database,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paymentBackJpaRepository: PaymentBackJpaRepository,</span><br><span class="line">    entityManagerFactory: EntityManagerFactory</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bulkInsertJob</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        jdbcTemplateInsertStep: <span class="type">Step</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: Job =</span><br><span class="line">        jobBuilderFactory[<span class="string">&quot;bulkInsertJob&quot;</span>]</span><br><span class="line">            .incrementer(RunIdIncrementer())</span><br><span class="line">            .listener(jobDataSetUpListener) <span class="comment">// payment 데이터 setup</span></span><br><span class="line">            .start(jdbcTemplateInsertStep)</span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@JobScope</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bulkInsertStep</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        stepBuilderFactory: <span class="type">StepBuilderFactory</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        bulkInsertReader: <span class="type">JpaCursorItemReader</span>&lt;<span class="type">Payment</span>&gt;</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: Step =</span><br><span class="line">        stepBuilderFactory[<span class="string">&quot;bulkInsertStep&quot;</span>]</span><br><span class="line">            .chunk&lt;Payment, Payment&gt;(GLOBAL_CHUNK_SIZE)</span><br><span class="line">            .reader(bulkInsertReader) <span class="comment">// Reader는 JpaCursorItemReader 기반으로 조회</span></span><br><span class="line"><span class="comment">//            .writer(writerWithStatement) // Statement addBatch() 기반 저장 </span></span><br><span class="line">            .writer(writerWithExposed) <span class="comment">// Exposed 기반 저장</span></span><br><span class="line"><span class="comment">//            .writer(writerWithJpa) // JPA 기반 저장</span></span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@StepScope</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bulkInsertReader</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        entityManagerFactory: <span class="type">EntityManagerFactory</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> = JpaCursorItemReaderBuilder&lt;Payment&gt;()</span><br><span class="line">        .name(<span class="string">&quot;bulkInsertReader&quot;</span>)</span><br><span class="line">        .entityManagerFactory(entityManagerFactory)</span><br><span class="line">        .queryString(<span class="string">&quot;SELECT p FROM Payment p&quot;</span>)</span><br><span class="line">        .build()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> writerWithStatement: ItemWriter&lt;Payment&gt; = ItemWriter &#123; payments -&gt;</span><br><span class="line">        <span class="keyword">val</span> sql = <span class="string">&quot;insert into payment_back (amount, order_id) values (?, ?)&quot;</span></span><br><span class="line">        <span class="keyword">val</span> connection = dataSource.connection</span><br><span class="line">        <span class="keyword">val</span> statement = connection.prepareStatement(sql)!!</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (payment <span class="keyword">in</span> payments) &#123;</span><br><span class="line">                statement.apply &#123;</span><br><span class="line">                    <span class="keyword">this</span>.setBigDecimal(<span class="number">1</span>, payment.amount)</span><br><span class="line">                    <span class="keyword">this</span>.setLong(<span class="number">2</span>, payment.orderId)</span><br><span class="line">                    <span class="keyword">this</span>.addBatch()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            statement.executeBatch()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (statement.isClosed.not()) &#123;</span><br><span class="line">                statement.close()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection.isClosed.not()) &#123;</span><br><span class="line">                connection.close()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> writerWithJpa: ItemWriter&lt;Payment&gt; =</span><br><span class="line">        ItemWriter &#123; payments -&gt;</span><br><span class="line">            payments.map &#123; payment -&gt;</span><br><span class="line">                PaymentBackJpa(</span><br><span class="line">                    amount = payment.amount,</span><br><span class="line">                    orderId = payment.orderId</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">                .also &#123;</span><br><span class="line">                    paymentBackJpaRepository.saveAll(it)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> writerWithExposed: ItemWriter&lt;Payment&gt; = ItemWriter &#123; payments -&gt;</span><br><span class="line">        transaction(</span><br><span class="line">            exposedDataBase</span><br><span class="line">        ) &#123;</span><br><span class="line">            PaymentBack.batchInsert(</span><br><span class="line">                <span class="keyword">data</span> = payments,</span><br><span class="line">                shouldReturnGeneratedValues = <span class="literal">false</span></span><br><span class="line">            ) &#123; payment -&gt;</span><br><span class="line">                <span class="keyword">this</span>[PaymentBack.orderId] = payment.orderId</span><br><span class="line">                <span class="keyword">this</span>[PaymentBack.amount] = payment.amount</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> PaymentBack : LongIdTable(name = <span class="string">&quot;payment_back&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> amount = decimal(<span class="string">&quot;amount&quot;</span>, <span class="number">19</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">val</span> orderId = long(<span class="string">&quot;order_id&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring Batch 기반으로 <code>payment</code> 테이블을 N 개 읽어서 <code>payment_back</code> 테이블로 저장하는 흐름입니다. Reader는 JpaCursorItemReader 기반으로 <code>payment</code> 테이블을 조회합니다. 그리고 각 저장하는 <code>wirter</code> 코드들이 있습니다. <code>writerWithExposed()</code> 메서드는 <code>Exposed</code> 라이브러리에서 지원하는 <code>batchInsert()</code>메서드를 이용해서 insert를 진행하고 있습니다.</p>
<h3 id="Exposed-Batch-Insert"><a href="#Exposed-Batch-Insert" class="headerlink" title="Exposed Batch Insert"></a>Exposed Batch Insert</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">transaction(</span><br><span class="line">    exposedDataBase</span><br><span class="line">) &#123;</span><br><span class="line">    PaymentBack.batchInsert(</span><br><span class="line">        <span class="keyword">data</span> = payments,</span><br><span class="line">        shouldReturnGeneratedValues = <span class="literal">false</span></span><br><span class="line">    ) &#123; payment -&gt;</span><br><span class="line">        <span class="keyword">this</span>[PaymentBack.orderId] = payment.orderId</span><br><span class="line">        <span class="keyword">this</span>[PaymentBack.amount] = payment.amount</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Exposed</code>는 <code>batchInsert()</code> 메서드를 지원하기 때문에 쉽게 batch insert를 진행할 수 있습니다. Mysql의 경우 JDBC 드라이버에 <code>rewriteBatchedStatements=true</code> 속성을 반드시 입력해야 batch insert가 가능합니다. <code>shouldReturnGeneratedValues</code> 값을 <code>false</code>로 지정하면 <code>auto_increment</code>으로 증가된 ID 값을 가져오지 않기에 성능이 향상될 수 있습니다.</p>
<h2 id="Insert-성능-측정"><a href="#Insert-성능-측정" class="headerlink" title="Insert 성능 측정"></a>Insert 성능 측정</h2><p>Insert에 대한 성능 측정은 JPA, Statement, Exposed 3가지 라이브러리로 진행하겠습니다. JPA는 단건으로 저장하며, Statement는 문자열 기반으로 <code>addBatch()</code>를 직접 호출, Exposed는 자체적으로 지원하는 Batch Insert를 진행합니다.</p>
<p><strong>해당 속도 측정은 JpaCursorItemReader 기반으로 조회하는 시간까지 포함된 시간입니다.</strong> 수백수만 데이터를 한 번에 저장하는 경우는 보다 페이징 처리를 진행해서 저장하는 것이 일반적이기도 하고 모두 동일한 Reader를 사용했기 때문에 비율은 동일하게 측정됩니다. 측정 단위는 모두 <code>ms</code>입니다.</p>
<h4 id="chunk-size-1-000"><a href="#chunk-size-1-000" class="headerlink" title="chunk size &#x3D; 1,000"></a>chunk size &#x3D; 1,000</h4><p><img src="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/chunk_size_1000.png"></p>
<table>
<thead>
<tr>
<th>rows</th>
<th>JPA</th>
<th>Statement</th>
<th>Exposed</th>
</tr>
</thead>
<tbody><tr>
<td>10,000</td>
<td>9278</td>
<td>577</td>
<td>890</td>
</tr>
<tr>
<td>50,000</td>
<td>53330</td>
<td>2632</td>
<td>3119</td>
</tr>
<tr>
<td>100,000</td>
<td>108460(1.8 min)</td>
<td>3470</td>
<td>4820</td>
</tr>
<tr>
<td>500,000</td>
<td>561756(9.3 min)</td>
<td>14693</td>
<td>21154</td>
</tr>
<tr>
<td>1,000,000</td>
<td>1163130(19.3 min)</td>
<td>28633</td>
<td>46533</td>
</tr>
<tr>
<td>5,000,000</td>
<td>5452635(90.8 min)</td>
<td>140117(2.3 min)</td>
<td>227203(3.7 min)</td>
</tr>
<tr>
<td>10,000,000</td>
<td>x</td>
<td>282603(4.7 min)</td>
<td>438349(7.3 min)</td>
</tr>
</tbody></table>
<p><strong>rows <code>10,000,000</code> 측정은 너무 오래 걸려 진행하지 못했습니다.</strong> <code>5,000,000</code> 보다 약 2배 정도 <code>10905270 ms (181 min)</code> 정도 예상됩니다. JPA 성능 측정은 더 이상 의미가 없을 거 같아서 Statement, Exposed를 chunk size 기준으로 진행하겠습니다.</p>
<h4 id="chunk-size-5-000"><a href="#chunk-size-5-000" class="headerlink" title="chunk size &#x3D; 5,000"></a>chunk size &#x3D; 5,000</h4><p><img src="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/chunk_size_5000.png"></p>
<table>
<thead>
<tr>
<th>rows</th>
<th>Statement</th>
<th>Exposed</th>
</tr>
</thead>
<tbody><tr>
<td>10,000</td>
<td>415</td>
<td>787</td>
</tr>
<tr>
<td>50,000</td>
<td>1454</td>
<td>2569</td>
</tr>
<tr>
<td>100,000</td>
<td>2681</td>
<td>3777</td>
</tr>
<tr>
<td>500,000</td>
<td>10607</td>
<td>17911</td>
</tr>
<tr>
<td>1,000,000</td>
<td>22378</td>
<td>33637</td>
</tr>
<tr>
<td>5,000,000</td>
<td>105275</td>
<td>165472</td>
</tr>
<tr>
<td>10,000,000</td>
<td>215456</td>
<td>311385</td>
</tr>
</tbody></table>
<h4 id="chunk-size-10-000"><a href="#chunk-size-10-000" class="headerlink" title="chunk size &#x3D; 10,000"></a>chunk size &#x3D; 10,000</h4><p><img src="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/chunk_size_100000.png"></p>
<table>
<thead>
<tr>
<th>rows</th>
<th>Statement</th>
<th>Exposed</th>
</tr>
</thead>
<tbody><tr>
<td>10,000</td>
<td>421</td>
<td>879</td>
</tr>
<tr>
<td>50,000</td>
<td>1713</td>
<td>2582</td>
</tr>
<tr>
<td>100,000</td>
<td>2636</td>
<td>4101</td>
</tr>
<tr>
<td>500,000</td>
<td>10959</td>
<td>15479</td>
</tr>
<tr>
<td>1,000,000</td>
<td>21159</td>
<td>33711</td>
</tr>
<tr>
<td>5,000,000</td>
<td>105478</td>
<td>150009</td>
</tr>
<tr>
<td>10,000,000</td>
<td>205380</td>
<td>308874</td>
</tr>
</tbody></table>
<h3 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h3><p>JPA(단일 insert)와 성능은 비교 자체가 되지 않으며, 자바 코드와, 데이터베이스가 동일하지 않은 네트워크 환경에서는 IO 작업이 더 많이 발생하기 때문에 위 성능 측정보다 안 좋은 결과가 예상됩니다.</p>
<p><code>Exposed</code>도 내부적으로 <code>addBatch()</code>를 사용해서 batch insert를 진행하는데도 불과하고 대략 <code>30%</code>성능의 차이를 보였습니다. <code>Statement</code> 보다 느린 부분은 사실이지만 절대적인 성능 자체가 둘 모두 빠르기에 (<code>10,000,000</code> 기준 1분 40초 차이) 속도적인 측면보다는 개발 및 유지 보수 측면에서 <code>Exposed</code>가 더 좋다고 판단했습니다.</p>
<p>그리고 chunk size <code>5,000</code>, <code>10,000</code> 각각 측정해 본 결과 <code>Exposed</code>가 조금 더 효율적으로 성능이 향상되었습니다. 물론 모든 측정은 로컬 환경에서 진행한 것이니 절대적인 수치보다는 각 rows 별 <code>JPA</code>, <code>Statement</code>, <code>Exposed</code>의 비율을 보는 게 더 바람직합니다.</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Exposed/" rel="tag">Exposed</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/JPA/" rel="tag">JPA</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/ORM/" rel="tag">ORM</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Performance/" rel="tag">Performance</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/ktlint/"
                    data-tooltip="Ktlint 코드 스타일 검사"
                    aria-label="이전: Ktlint 코드 스타일 검사"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/jpa-batch-insert/"
                    data-tooltip="Batch Insert 성능 향상기 1편 - With JPA"
                    aria-label="다음: Batch Insert 성능 향상기 1편 - With JPA"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-batch-batch-insert/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-batch-batch-insert/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://cheese10yun.github.io/spring-batch-batch-insert/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>


<!-- Comment -->
<!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/ktlint/"
                    data-tooltip="Ktlint 코드 스타일 검사"
                    aria-label="이전: Ktlint 코드 스타일 검사"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/jpa-batch-insert/"
                    data-tooltip="Batch Insert 성능 향상기 1편 - With JPA"
                    aria-label="다음: Batch Insert 성능 향상기 1편 - With JPA"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-batch-batch-insert/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-batch-batch-insert/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://cheese10yun.github.io/spring-batch-batch-insert/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-batch-batch-insert/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-batch-batch-insert/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://cheese10yun.github.io/spring-batch-batch-insert/"
                        aria-label="Google+에 공유하기"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Google+에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>

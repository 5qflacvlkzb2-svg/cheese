
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="naver-site-verification" content="a37ea649edf26e70c3de94f9cb034f9d6e11de3f" />
    <meta name="generator" content="Yun Blog">
    <title>Batch Insert 성능 향상기 1편 - With JPA - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"성능 향상을 위해서 Batch Insert를 도입하는 과정 중 JPA, Mysql 환경에서의 Batch Insert에 대한 방법과 제약사항들에 대해서 정리했습니다. 결과적으로는 다른 프레임워크를 도입해서 해결했으며 본 포스팅은 JPA Batch Insert의 정리와, 왜 다른 프레임워크를 도입을 했는지에 대해한 내용입니다.\nBatch Insert 란 ?12345678910# 단건 insertinsert into payment_back (amount, order_id) values (?, ?)# 멀티 insertinsert into payment_back (amount, order_id)values        (1, 2),       (1, 2),       (1, 2),       (1, 2)\n\ninsert rows 여러 개 연결해서 한 번에 입력하는 것을 Batch Insert라고 말합니다. 당연한 이야기이지만 Batch Insert는 하나의 트랜잭션으로 묶이게 됩니다.\nBatch Insert With JPA위 Batch Insert SQL이 간단해 보이지만 실제 로직으로 작성하려면 코드가 복잡해지고 실수하기 좋은 포인트들이 있어 유지 보수하기 어려운 코드가 되기 쉽습니다. 해당 포인트들은 아래 주석으로 작성했습니다. JPA를 사용하면 이러한 문제들을 정말 쉽게 해결이 가능합니다.\n123456789101112131415161718// 문자열로 기반으로 SQL을 관리하기 때문에 변경 및 유지 보수에 좋지 않음val sql = &quot;insert into payment_back (id, amount, order_id) values (?, ?, ?)&quot;val statement = connection.prepareStatement(sql)!!fun addBatch(payment: Payment) = statement.apply &#123;    // code 바인딩 순서에 따라 오동작 가능성이 높음    // 매번 자료형을 지정해서 값을 입력해야 함    this.setLong(1, payment.id!!)    this.setBigDecimal(2, payment.amount)    this.setLong(3, payment.orderId)    this.addBatch()&#125;// connection &amp; statement 객체를 직접 close 진행, 하지 않을 경우 문제 발생 가능성이 있음fun close() &#123;    if (statement.isClosed.not())        statement.close()&#125;\n\n쓰기 지연 SQL 지원 이란 ?123456789101112EntityMaanger em  = emf.createEnttiyManager();ENtityTranscation transaction = em.getTransaction();// 엔티티 매니저는 데이터 변경 시 트랜잭션을 시작해야 한다.transaction.begin();em.persist(memberA);em.persist(memberB);// 여기까지 Insert SQL을 데이터베이스에 보내지 않는다.// Commit을 하는 순간 데이터베이스에 Insert SQL을 보낸다transaction.commit();\n\n엔티티 매니저는 트랜잭션을 커밋 하기 직전까지 데이터베이스에 엔티티를 저장하지 않고 내부 쿼리 저장소에 INSERT SQL을 모아둔다. 그리고 트랜잭션을 커밋 할 때 모아둔 쿼리를 데이터베이스에 보내는데 이것을 트랜잭션을 지원하는 쓰기 지연이라 한다.\n\n회원 A를 영속화했다. 영속성 컨텍스트는 1차 캐시에 회원 엔티티를 저장하면서 동시에 회원 엔티티 정보로 등록 쿼리를 만든다. 그리고 만들어진 등록 쿼리를 쓰기 지연 SQL 저장소에 보관한다.\n다음으로 회원 B를 영속화했다. 마찬가지로 회원 엔티티 정보로 등록 쿼리를 생성해서 쓰지 지연 SQL 저장소에 보관한다. 현재 쓰기 지연 SQL 저장소에는 등록 쿼리가 2건이 저장되어 있다.\n\n마지막으로 트랜잭션을 커밋 했다. 트랜잭션을 커밋 하면 엔티티 매니저는 우선 영속성 컨텍스트를 플러시 한다. 플러시는 영속성 컨텍스트의 변경 내용을 데이터베이스에 동기화하는 작업인데 이때 등록, 수정, 삭제한 엔티티를 데이터베이스에 반영한다. 이러한 부분은 JPA 내부적으로 이루어지기 때문에 사용하는 코드에서는 코드의 변경 없이 이러한 작업들이 가능하다.\nJPA With Batch Insert Code12345678910111213spring:    jpa:        database: mysql        properties:            hibernate.jdbc.batch_size: 50            hibernate.order_inserts: true            hibernate.order_updates: true            hibernate.dialect: org.hibernate.dialect.MySQL5InnoDBDialect            hibernate.show_sql: true    datasource:        url: jdbc:mysql://localhost:3366/batch_study?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;rewriteBatchedStatements=true        driver-class-name: com.mysql.cj.jdbc.Driver\naddBatch 구분을 사용하기 위해서는 rewriteBatchedStatements=true 속성을 지정해야 합니다. 기본 설정은 false이며, 해당 설정이 없으면 Batch Insert는 동작하지 않습니다. 정확한 내용은 공식 문서를 참고해 주세요.\n\nMySQL Connector&#x2F;J 8.0 Developer Guide : 6.3.13 Performance ExtensionsStops checking if every INSERT statement contains the “ON DUPLICATE KEY UPDATE” clause. As a side effect, obtaining the statement’s generated keys information will return a list where normally it wouldn’t. Also be aware that, in this case, the list of generated keys returned may not be accurate. The effect of this property is canceled if set simultaneously with ‘rewriteBatchedStatements&#x3D;true’.\n\nhibernate.jdbc.batch_size: 50 Batch Insert의 size를 지정합니다. 해당 크기에 따라서 한 번에 insert 되는 rows가 결정됩니다. 자세한 내용은 아래에서 설명드리겠습니다.\n12345678910111213141516@Entity@Table(name = &quot;payment_back&quot;)class PaymentBackJpa(    @Column(name = &quot;amount&quot;, nullable = false)    var amount: BigDecimal,    @Column(name = &quot;order_id&quot;, nullable = false, updatable = false)    val orderId: Long)&#123;        @Id    @Column(name = &quot;id&quot;, updatable = false) // @GeneratedValue를 지정하지 않았음    var id: Long? = null&#125;interface PaymentBackJpaRepository: JpaRepository&lt;PaymentBackJpa, Long&gt;\n엔티티 클래스는 간단합니다. 중요한 부분은 @GeneratedValue을 지정하지 않은 부분입니다.\n123456789101112131415161718192021@SpringBootTest@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)internal class BulkInsertJobConfigurationTest(    private val paymentBackJpaRepository: PaymentBackJpaRepository) &#123;    @Test    internal fun `jpa 기반 bulk insert`() &#123;        (1..100).map &#123;            PaymentBackJpa(                amount = it.toBigDecimal(),                orderId = it.toLong()            )                .apply &#123;                    this.id = it.toLong() // ID를 직접 지정                &#125;        &#125;.also &#123;            paymentBackJpaRepository.saveAll(it)        &#125;    &#125;&#125;\npaymentBackJpaRepository.saveAll()를 이용해서 batch insert를 진행합니다. JPA 기반으로 Batch Insert를 진행할 때 별다른 코드가 필요 없습니다. 컬렉션 객체를 saveAll()으로 저장하는 것이 전부입니다. hibernate.show_sql: true으로 로킹 결고를 확인해보겠습니다.\n\n로그상으로는 Batch Insert가 진행되지 않은 것처럼 보입니다. 결론부터 말씀드리면 실제로는 Batch Insert가 진행됐지만 hibernate.show_sql: true 기반 로그에는 제대로 표시가 되지 않습니다. Mysql의 실제 로그로 확인해보겠습니다.\n12show variables like &#x27;general_log%&#x27;; # general_log 획인set global general_log = &#x27;ON&#x27;; # `OFF` 경우 `ON` 으로 변경\n\n해당 로그 설정은 성능에 지장을 줄 수 있기 때문에 테스트, 개발 환경에서만 지정하는 것을 권장합니다. 해당 기능은 실시간으로 변경 가능하기 때문에 설정 완료 이후 /var/lib/mysql/0a651fe44d20.log 파일에 로그를 확인할 수 있습니다.\nbatch size123456Query\tSELECT @@session.transaction_read_onlyQuery\tinsert into payment_back (amount, order_id, id) values (1, 1, 1),(2, 2, 2),(3, 3, 3),(4, 4, 4),(5, 5, 5),(6, 6, 6),(7, 7, 7),(8, 8, 8),(9, 9, 9),(10, 10, 10),(11, 11, 11),(12, 12, 12),(13, 13, 13),(14, 14, 14),(15, 15, 15),(16, 16, 16),(17, 17, 17),(18, 18, 18),(19, 19, 19),(20, 20, 20),(21, 21, 21),(22, 22, 22),(23, 23, 23),(24, 24, 24),(25, 25, 25),(26, 26, 26),(27, 27, 27),(28, 28, 28),(29, 29, 29),(30, 30, 30),(31, 31, 31),(32, 32, 32),(33, 33, 33),(34, 34, 34),(35, 35, 35),(36, 36, 36),(37, 37, 37),(38, 38, 38),(39, 39, 39),(40, 40, 40),(41, 41, 41),(42, 42, 42),(43, 43, 43),(44, 44, 44),(45, 45, 45),(46, 46, 46),(47, 47, 47),(48, 48, 48),(49, 49, 49),(50, 50, 50)Query\tSELECT @@session.transaction_read_onlyQuery\tinsert into payment_back (amount, order_id, id) values (51, 51, 51),(52, 52, 52),(53, 53, 53),(54, 54, 54),(55, 55, 55),(56, 56, 56),(57, 57, 57),(58, 58, 58),(59, 59, 59),(60, 60, 60),(61, 61, 61),(62, 62, 62),(63, 63, 63),(64, 64, 64),(65, 65, 65),(66, 66, 66),(67, 67, 67),(68, 68, 68),(69, 69, 69),(70, 70, 70),(71, 71, 71),(72, 72, 72),(73, 73, 73),(74, 74, 74),(75, 75, 75),(76, 76, 76),(77, 77, 77),(78, 78, 78),(79, 79, 79),(80, 80, 80),(81, 81, 81),(82, 82, 82),(83, 83, 83),(84, 84, 84),(85, 85, 85),(86, 86, 86),(87, 87, 87),(88, 88, 88),(89, 89, 89),(90, 90, 90),(91, 91, 91),(92, 92, 92),(93, 93, 93),(94, 94, 94),(95, 95, 95),(96, 96, 96),(97, 97, 97),(98, 98, 98),(99, 99, 99),(100, 100, 100)Query\tcommitQuery\tSET autocommit=1\n\n실제 mysql 로그에서는 Batch Insert를 확인할 수 있습니다. 그런데 왜 2번에 걸쳐서 Batch Insert가 진행되었을까요? hibernate.jdbc.batch_size: 50설정으로 Batch Insert에 대한 size를 50으로 지정했기 때문에 rows 100를 저장할 때 2번에 걸쳐 insert를 진행하는 것입니다. 만약 hibernate.jdbc.batch_size: 100이라면 1번의 insert로 저장됩니다.\n1Query\tinsert into payment_back (amount, order_id, id) values (1, 1, 1),(2, 2, 2),(3, 3, 3),(4, 4, 4),(5, 5, 5),(6, 6, 6),(7, 7, 7),(8, 8, 8),(9, 9, 9),(10, 10, 10),(11, 11, 11),(12, 12, 12),(13, 13, 13),(14, 14, 14),(15, 15, 15),(16, 16, 16),(17, 17, 17),(18, 18, 18),(19, 19, 19),(20, 20, 20),(21, 21, 21),(22, 22, 22),(23, 23, 23),(24, 24, 24),(25, 25, 25),(26, 26, 26),(27, 27, 27),(28, 28, 28),(29, 29, 29),(30, 30, 30),(31, 31, 31),(32, 32, 32),(33, 33, 33),(34, 34, 34),(35, 35, 35),(36, 36, 36),(37, 37, 37),(38, 38, 38),(39, 39, 39),(40, 40, 40),(41, 41, 41),(42, 42, 42),(43, 43, 43),(44, 44, 44),(45, 45, 45),(46, 46, 46),(47, 47, 47),(48, 48, 48),(49, 49, 49),(50, 50, 50),(51, 51, 51),(52, 52, 52),(53, 53, 53),(54, 54, 54),(55, 55, 55),(56, 56, 56),(57, 57, 57),(58, 58, 58),(59, 59, 59),(60, 60, 60),(61, 61, 61),(62, 62, 62),(63, 63, 63),(64, 64, 64),(65, 65, 65),(66, 66, 66),(67, 67, 67),(68, 68, 68),(69, 69, 69),(70, 70, 70),(71, 71, 71),(72, 72, 72),(73, 73, 73),(74, 74, 74),(75, 75, 75),(76, 76, 76),(77, 77, 77),(78, 78, 78),(79, 79, 79),(80, 80, 80),(81, 81, 81),(82, 82, 82),(83, 83, 83),(84, 84, 84),(85, 85, 85),(86, 86, 86),(87, 87, 87),(88, 88, 88),(89, 89, 89),(90, 90, 90),(91, 91, 91),(92, 92, 92),(93, 93, 93),(94, 94, 94),(95, 95, 95),(96, 96, 96),(97, 97, 97),(98, 98, 98),(99, 99, 99),(100, 100, 100)\n위 쿼리는 hibernate.jdbc.batch_size: 100으로 지정한 결과입니다. 그렇다면 왜 batch_size 옵션을 주어서 한 번에 insert 할 수 있는 데이터의 크기를 제한하는 것일까요? 아래 코드에서 해답을 찾을 수 있습니다.\n\nHibernate User Guide: 12.2.1. Batch inserts\nWhen you make new objects persistent, employ methods flush() and clear() to the session regularly, to control the size of the first-level cache.\n\n123456789101112131415161718192021222324252627282930EntityManager entityManager = null;EntityTransaction txn = null;try &#123;\tentityManager = entityManagerFactory().createEntityManager();\ttxn = entityManager.getTransaction();\ttxn.begin();\tint batchSize = 25;\tfor ( int i = 0; i &lt; entityCount; i++ ) &#123;\t\tif ( i &gt; 0 &amp;&amp; i % batchSize == 0 ) &#123;\t\t\t//flush a batch of inserts and release memory\t\t\tentityManager.flush();\t\t\tentityManager.clear();\t\t&#125;\t\tPerson Person = new Person( String.format( &quot;Person %d&quot;, i ) );\t\tentityManager.persist( Person );\t&#125;\ttxn.commit();&#125; catch (RuntimeException e) &#123;\tif ( txn != null &amp;&amp; txn.isActive()) txn.rollback();\t\tthrow e;&#125; finally &#123;\tif (entityManager != null) &#123;\t\tentityManager.close();\t&#125;&#125;\n하이버네이트 공식 가이드의 내용입니다. batchSize 값을 기준으로 flush();, clear();를 이용해서 영속성 컨텍스트를 초기화 작업을 진행하고 있습니다. batchSize에 대한 제한이 없으면 영속성 컨텍스트에 모든 엔티티가 올라가기 때문에 OutOfMemoryException 발생할 수 있고, 메모리 관리 측면에서도 효율적이지 않기 때문입니다. 하이버네이트의 공식 가이드에서도 해당 부분의 언급이 있습니다.\n\nHibernate User Guide: 12.2. Session batching\n\nHibernate caches all the newly inserted Customer instances in the session-level cache, so, when the transaction ends, 100 000 entities are managed by the persistence context. If the maximum memory allocated to the JVM is rather low, this example could fail with an OutOfMemoryException. The Java 1.8 JVM allocated either 1&#x2F;4 of available RAM or 1Gb, which can easily accommodate 100 000 objects on the heap.\nlong-running transactions can deplete a connection pool so other transactions don’t get a chance to proceed\nJDBC batching is not enabled by default, so every insert statement requires a database roundtrip. To enable JDBC batching, set the hibernate.jdbc.batch_size property to an integer between 10 and 50.\n\n\n쓰기 지연 SQL 제약 사항batchSize: 50 경우 PaymentBackJpa 객체를 50 단위로 Batch Insert 쿼리가 실행되지만, 중간에 다른 엔티티를 저장하는 경우 아래처럼 지금까지의 PaymentBackJpa에 대한 지정하기 때문에 최종적으로 batchSize: 50 단위로 저장되지 않습니다.\n1234567em.persist(new PaymentBackJpa()); // 1em.persist(new PaymentBackJpa()); // 2em.persist(new PaymentBackJpa()); // 3em.persist(new PaymentBackJpa()); // 4em.persist(new Orders()); // 1-1, 다른 SQL이 추가 되었기 때문에  SQL 배치를 다시 시작 해야 한다.em.persist(new PaymentBackJpa()); // 1em.persist(new PaymentBackJpa()); // 2\n이러한 문제는 hibernate.order_updates: true, hibernate.order_inserts: true 값으로 해결 할 수 있습니다.\nJPA Batch Insert의 가장 큰 문제…위에서 설명했던 부분들은 Batch Insert에 필요한 properties 설정, 그리고 내부적으로 JPA에서 Batch Insert에 대한 동작 방식을 설명한 것입니다. 실제 Batch Insert를 진행하는 코드는 별다른 부분이 없고 컬렉션 객체를 saveAll() 메서드로 호출하는 것이 전부입니다. 이로써 JPA는 Batch Insert를 강력하게 지원해 주고 있습니다. 하지만 가장 큰 문제가 있습니다. @GeneratedValue(strategy = GenerationType.IDENTITY) 방식의 경우 Batch Insert를 지원하지 않습니다.\n\nHibernate User Guide: 12.2. Session batching\nHibernate disables insert batching at the JDBC level transparently if you use an identity identifier generator.\n\n공식 문서에도 언급이 있듯이 @GeneratedValue(strategy = GenerationType.IDENTITY) 경우 Batch Insert를 지원하지 않습니다. 정확히 어떤 이유 때문인지에 대해서는 언급이 없고, 관련 내용을 잘 설명한 StackOverflow를 첨부합니다.\n제가 이해한 바로는 하이버네이트는 Transactional Write Behind 방식(마지막까지 영속성 컨텍스트에서 데이터를 가지고 있어 플러시를 연기하는 방식)을 사용하기 때문에 GenerationType.IDENTITY 방식의 경우 JDBC Batch Insert를 비활성화함. GenerationType.IDENTITY 방식이란 auto_increment으로 PK 값을 자동으로 증분 해서 생성하는 것으로 매우 효율적으로 관리할 수 있다.(heavyweight transactional course-grain locks 보다 효율적). 하지만 Insert를 실행하기 전까지는 ID에 할당된 값을 알 수 없기 때문에 Transactional Write Behind을 할 수 없고 결과적으로 Batch Insert를 진행할 수 없다.\nMysql에서는 대부분 GenerationType.IDENTITY으로 사용하기 때문에 해당 문제는 치명적입니다. 우선 GenerationType.IDENTITY 으로 지정하고 다시 테스트 코드를 돌려 보겠습니다.\n123456789101112131415161718192021222324252627282930313233@Entity@Table(name = &quot;payment_back&quot;)class PaymentBackJpa(    @Column(name = &quot;amount&quot;, nullable = false)    var amount: BigDecimal,    @Column(name = &quot;order_id&quot;, nullable = false, updatable = false)    val orderId: Long)&#123;    @Id    @GeneratedValue(strategy = GenerationType.IDENTITY) // GenerationType.IDENTITY 지정    var id: Long? = null&#125;internal class BulkInsertJobConfigurationTest(    private val paymentBackJpaRepository: PaymentBackJpaRepository) &#123;    @Test    internal fun `jpa 기반 bulk insert`() &#123;        (1..100).map &#123;            PaymentBackJpa(                amount = it.toBigDecimal(),                orderId = it.toLong()            )                .apply &#123;//                    this.id = it.toLong() // ID를 자동 증가로 변경 했기 때문에 코드 주석                &#125;        &#125;.also &#123;            paymentBackJpaRepository.saveAll(it)        &#125;    &#125;&#125;\n\n12345678910111213Query\tinsert into payment_back (amount, order_id) values (1, 1)Query\tinsert into payment_back (amount, order_id) values (2, 2)Query\tinsert into payment_back (amount, order_id) values (3, 3)Query\tinsert into payment_back (amount, order_id) values (4, 4)Query\tinsert into payment_back (amount, order_id) values (5, 5)Query\tinsert into payment_back (amount, order_id) values (6, 6)Query\tinsert into payment_back (amount, order_id) values (7, 7)Query\tinsert into payment_back (amount, order_id) values (8, 8)Query\tinsert into payment_back (amount, order_id) values (9, 9)Query\tinsert into payment_back (amount, order_id) values (10, 10)Query\tinsert into payment_back (amount, order_id) values (11, 11)Query\tinsert into payment_back (amount, order_id) values (12, 12)...\nGenerationType.IDENTITY의 경우에는 Batch Insert가 진행되지 않습니다. 그래서 다른 대안을 찾아야 했습니다. 이 부분부터는 다음 포스팅에서 이어가겠습니다.\n참고\nSpring Data에서 Batch Insert 최적화\nJPA GenerationType에 따른 INSERT 성능 차이\nJPA Batch inserts Document\nHow do persist and merge work in JPA\nMySQL Connector&#x2F;J 8.0 Developer Guide\nHibernate ORM 5.4.28.Final User Guide\n자바 ORM 표준 JPA 프로그래밍\n\n","dateCreated":"2021-02-22T00:00:00+09:00","dateModified":"2025-01-31T04:44:52+09:00","datePublished":"2021-02-22T00:00:00+09:00","description":"성능 향상을 위해서 Batch Insert를 도입하는 과정 중 JPA, Mysql 환경에서의 Batch Insert에 대한 방법과 제약사항들에 대해서 정리했습니다.","headline":"Batch Insert 성능 향상기 1편 - With JPA","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheese10yun.github.io/jpa-batch-insert/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"https://cheese10yun.github.io/jpa-batch-insert/","keywords":"JPA, ORM, Performance, Batch Insert"}</script>
    <meta name="description" content="성능 향상을 위해서 Batch Insert를 도입하는 과정 중 JPA, Mysql 환경에서의 Batch Insert에 대한 방법과 제약사항들에 대해서 정리했습니다.">
<meta property="og:type" content="blog">
<meta property="og:title" content="Batch Insert 성능 향상기 1편 - With JPA">
<meta property="og:url" content="https://cheese10yun.github.io/jpa-batch-insert/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="성능 향상을 위해서 Batch Insert를 도입하는 과정 중 JPA, Mysql 환경에서의 Batch Insert에 대한 방법과 제약사항들에 대해서 정리했습니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://github.com/cheese10yun/TIL/raw/master/assets/jpa-insert-persistent.png">
<meta property="og:image" content="https://github.com/cheese10yun/TIL/raw/master/assets/jpa-insert-persistent-2.png">
<meta property="og:image" content="https://github.com/cheese10yun/TIL/raw/master/assets/jpa-insert-persistent-3.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/sql-batch-1.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/sql-general.png">
<meta property="article:published_time" content="2021-02-21T15:00:00.000Z">
<meta property="article:modified_time" content="2025-01-30T19:44:52.001Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="JPA">
<meta property="article:tag" content="ORM">
<meta property="article:tag" content="Performance">
<meta property="article:tag" content="Batch Insert">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/cheese10yun/TIL/raw/master/assets/jpa-insert-persistent.png">
    
    
        
    
    
        <meta property="og:image" content="https://cheese10yun.github.io/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5813739623204880" crossorigin="anonymous"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="카테고리"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">카테고리</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="검색"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">검색</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Batch Insert 성능 향상기 1편 - With JPA
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2021-02-22T00:00:00+09:00">
	
		    2021/02/22
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>성능 향상을 위해서 Batch Insert를 도입하는 과정 중 JPA, Mysql 환경에서의 Batch Insert에 대한 방법과 제약사항들에 대해서 정리했습니다. 결과적으로는 다른 프레임워크를 도입해서 해결했으며 본 포스팅은 JPA Batch Insert의 정리와, 왜 다른 프레임워크를 도입을 했는지에 대해한 내용입니다.</p>
<h2 id="Batch-Insert-란"><a href="#Batch-Insert-란" class="headerlink" title="Batch Insert 란 ?"></a>Batch Insert 란 ?</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 단건 <span class="keyword">insert</span></span><br><span class="line"><span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (?, ?)</span><br><span class="line"></span><br><span class="line"># 멀티 <span class="keyword">insert</span></span><br><span class="line"><span class="keyword">insert into</span> payment_back (amount, order_id)</span><br><span class="line"><span class="keyword">values</span> </span><br><span class="line">       (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>insert rows 여러 개 연결해서 한 번에 입력하는 것을 Batch Insert라고 말합니다. 당연한 이야기이지만 Batch Insert는 하나의 트랜잭션으로 묶이게 됩니다.</p>
<h2 id="Batch-Insert-With-JPA"><a href="#Batch-Insert-With-JPA" class="headerlink" title="Batch Insert With JPA"></a>Batch Insert With JPA</h2><p>위 Batch Insert SQL이 간단해 보이지만 실제 로직으로 작성하려면 코드가 복잡해지고 실수하기 좋은 포인트들이 있어 유지 보수하기 어려운 코드가 되기 쉽습니다. 해당 포인트들은 아래 주석으로 작성했습니다. <strong>JPA를 사용하면 이러한 문제들을 정말 쉽게 해결이 가능합니다.</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 문자열로 기반으로 SQL을 관리하기 때문에 변경 및 유지 보수에 좋지 않음</span></span><br><span class="line"><span class="keyword">val</span> sql = <span class="string">&quot;insert into payment_back (id, amount, order_id) values (?, ?, ?)&quot;</span></span><br><span class="line"><span class="keyword">val</span> statement = connection.prepareStatement(sql)!!</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">addBatch</span><span class="params">(payment: <span class="type">Payment</span>)</span></span> = statement.apply &#123;</span><br><span class="line">    <span class="comment">// code 바인딩 순서에 따라 오동작 가능성이 높음</span></span><br><span class="line">    <span class="comment">// 매번 자료형을 지정해서 값을 입력해야 함</span></span><br><span class="line">    <span class="keyword">this</span>.setLong(<span class="number">1</span>, payment.id!!)</span><br><span class="line">    <span class="keyword">this</span>.setBigDecimal(<span class="number">2</span>, payment.amount)</span><br><span class="line">    <span class="keyword">this</span>.setLong(<span class="number">3</span>, payment.orderId)</span><br><span class="line">    <span class="keyword">this</span>.addBatch()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connection &amp; statement 객체를 직접 close 진행, 하지 않을 경우 문제 발생 가능성이 있음</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">close</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (statement.isClosed.not())</span><br><span class="line">        statement.close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="쓰기-지연-SQL-지원-이란"><a href="#쓰기-지연-SQL-지원-이란" class="headerlink" title="쓰기 지연 SQL 지원 이란 ?"></a>쓰기 지연 SQL 지원 이란 ?</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">EntityMaanger</span> <span class="variable">em</span>  <span class="operator">=</span> emf.createEnttiyManager();</span><br><span class="line"><span class="type">ENtityTranscation</span> <span class="variable">transaction</span> <span class="operator">=</span> em.getTransaction();</span><br><span class="line"><span class="comment">// 엔티티 매니저는 데이터 변경 시 트랜잭션을 시작해야 한다.</span></span><br><span class="line"></span><br><span class="line">transaction.begin();</span><br><span class="line"></span><br><span class="line">em.persist(memberA);</span><br><span class="line">em.persist(memberB);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 여기까지 Insert SQL을 데이터베이스에 보내지 않는다.</span></span><br><span class="line"><span class="comment">// Commit을 하는 순간 데이터베이스에 Insert SQL을 보낸다</span></span><br><span class="line">transaction.commit();</span><br></pre></td></tr></table></figure>

<p>엔티티 매니저는 트랜잭션을 커밋 하기 직전까지 데이터베이스에 엔티티를 저장하지 않고 내부 쿼리 저장소에 INSERT SQL을 모아둔다. 그리고 트랜잭션을 커밋 할 때 모아둔 쿼리를 데이터베이스에 보내는데 이것을 트랜잭션을 지원하는 쓰기 지연이라 한다.</p>
<p><img src="https://github.com/cheese10yun/TIL/raw/master/assets/jpa-insert-persistent.png"></p>
<p>회원 A를 영속화했다. 영속성 컨텍스트는 1차 캐시에 회원 엔티티를 저장하면서 동시에 회원 엔티티 정보로 등록 쿼리를 만든다. 그리고 만들어진 등록 쿼리를 쓰기 지연 SQL 저장소에 보관한다.</p>
<p><img src="https://github.com/cheese10yun/TIL/raw/master/assets/jpa-insert-persistent-2.png"><br>다음으로 회원 B를 영속화했다. 마찬가지로 회원 엔티티 정보로 등록 쿼리를 생성해서 쓰지 지연 SQL 저장소에 보관한다. 현재 쓰기 지연 SQL 저장소에는 등록 쿼리가 2건이 저장되어 있다.</p>
<p><img src="https://github.com/cheese10yun/TIL/raw/master/assets/jpa-insert-persistent-3.png"></p>
<p>마지막으로 트랜잭션을 커밋 했다. 트랜잭션을 커밋 하면 엔티티 매니저는 우선 영속성 컨텍스트를 플러시 한다. 플러시는 영속성 컨텍스트의 변경 내용을 데이터베이스에 동기화하는 작업인데 이때 등록, 수정, 삭제한 엔티티를 데이터베이스에 반영한다. <strong>이러한 부분은 JPA 내부적으로 이루어지기 때문에 사용하는 코드에서는 코드의 변경 없이 이러한 작업들이 가능하다.</strong></p>
<h3 id="JPA-With-Batch-Insert-Code"><a href="#JPA-With-Batch-Insert-Code" class="headerlink" title="JPA With Batch Insert Code"></a>JPA With Batch Insert Code</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">jpa:</span></span><br><span class="line">        <span class="attr">database:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">hibernate.jdbc.batch_size:</span> <span class="number">50</span></span><br><span class="line">            <span class="attr">hibernate.order_inserts:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">hibernate.order_updates:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">hibernate.dialect:</span> <span class="string">org.hibernate.dialect.MySQL5InnoDBDialect</span></span><br><span class="line">            <span class="attr">hibernate.show_sql:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3366/batch_study?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;rewriteBatchedStatements=true</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>
<p>addBatch 구분을 사용하기 위해서는 <code>rewriteBatchedStatements=true</code> 속성을 지정해야 합니다. 기본 설정은 <code>false</code>이며, 해당 설정이 없으면 Batch Insert는 동작하지 않습니다. 정확한 내용은 공식 문서를 참고해 주세요.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-performance-extensions.html">MySQL Connector&#x2F;J 8.0 Developer Guide : 6.3.13 Performance Extensions</a><br>Stops checking if every INSERT statement contains the “ON DUPLICATE KEY UPDATE” clause. As a side effect, obtaining the statement’s generated keys information will return a list where normally it wouldn’t. Also be aware that, in this case, the list of generated keys returned may not be accurate. The effect of this property is canceled if set simultaneously with ‘rewriteBatchedStatements&#x3D;true’.</p>
</blockquote>
<p><code>hibernate.jdbc.batch_size: 50</code> Batch Insert의 size를 지정합니다. 해당 크기에 따라서 한 번에 insert 되는 rows가 결정됩니다. 자세한 내용은 아래에서 설명드리겠습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = <span class="string">&quot;payment_back&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PaymentBackJpa</span>(</span><br><span class="line">    <span class="meta">@Column(name = <span class="string">&quot;amount&quot;</span>, nullable = false)</span></span><br><span class="line">    <span class="keyword">var</span> amount: BigDecimal,</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = <span class="string">&quot;order_id&quot;</span>, nullable = false, updatable = false)</span></span><br><span class="line">    <span class="keyword">val</span> orderId: <span class="built_in">Long</span></span><br><span class="line">)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@Column(name = <span class="string">&quot;id&quot;</span>, updatable = false)</span> <span class="comment">// @GeneratedValue를 지정하지 않았음</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Long</span>? = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">PaymentBackJpaRepository</span>: <span class="type">JpaRepository</span>&lt;<span class="type">PaymentBackJpa, Long</span>&gt;</span><br></pre></td></tr></table></figure>
<p>엔티티 클래스는 간단합니다. 중요한 부분은 <code>@GeneratedValue</code>을 지정하지 않은 부분입니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">BulkInsertJobConfigurationTest</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paymentBackJpaRepository: PaymentBackJpaRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `jpa 기반 bulk insert`<span class="params">()</span></span> &#123;</span><br><span class="line">        (<span class="number">1.</span><span class="number">.100</span>).map &#123;</span><br><span class="line">            PaymentBackJpa(</span><br><span class="line">                amount = it.toBigDecimal(),</span><br><span class="line">                orderId = it.toLong()</span><br><span class="line">            )</span><br><span class="line">                .apply &#123;</span><br><span class="line">                    <span class="keyword">this</span>.id = it.toLong() <span class="comment">// ID를 직접 지정</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;.also &#123;</span><br><span class="line">            paymentBackJpaRepository.saveAll(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>paymentBackJpaRepository.saveAll()</code>를 이용해서 batch insert를 진행합니다. JPA 기반으로 Batch Insert를 진행할 때 별다른 코드가 필요 없습니다. 컬렉션 객체를 <code>saveAll()</code>으로 저장하는 것이 전부입니다. <code>hibernate.show_sql: true</code>으로 로킹 결고를 확인해보겠습니다.</p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/sql-batch-1.png"></p>
<p>로그상으로는 Batch Insert가 진행되지 않은 것처럼 보입니다. 결론부터 말씀드리면 실제로는 Batch Insert가 진행됐지만 <code>hibernate.show_sql: true</code> 기반 로그에는 제대로 표시가 되지 않습니다. Mysql의 실제 로그로 확인해보겠습니다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;general_log%&#x27;</span>; # general_log 획인</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>; # `OFF` 경우 `<span class="keyword">ON</span>` 으로 변경</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/sql-general.png"></p>
<p><strong>해당 로그 설정은 성능에 지장을 줄 수 있기 때문에 테스트, 개발 환경에서만 지정하는 것을 권장합니다.</strong> 해당 기능은 실시간으로 변경 가능하기 때문에 설정 완료 이후 <code>/var/lib/mysql/0a651fe44d20.log</code> 파일에 로그를 확인할 수 있습니다.</p>
<h3 id="batch-size"><a href="#batch-size" class="headerlink" title="batch size"></a>batch size</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Query	<span class="keyword">SELECT</span> @<span class="variable">@session</span>.transaction_read_only</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id, id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>),(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>),(<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>),(<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>),(<span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>),(<span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>),(<span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>),(<span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>),(<span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>),(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>),(<span class="number">11</span>, <span class="number">11</span>, <span class="number">11</span>),(<span class="number">12</span>, <span class="number">12</span>, <span class="number">12</span>),(<span class="number">13</span>, <span class="number">13</span>, <span class="number">13</span>),(<span class="number">14</span>, <span class="number">14</span>, <span class="number">14</span>),(<span class="number">15</span>, <span class="number">15</span>, <span class="number">15</span>),(<span class="number">16</span>, <span class="number">16</span>, <span class="number">16</span>),(<span class="number">17</span>, <span class="number">17</span>, <span class="number">17</span>),(<span class="number">18</span>, <span class="number">18</span>, <span class="number">18</span>),(<span class="number">19</span>, <span class="number">19</span>, <span class="number">19</span>),(<span class="number">20</span>, <span class="number">20</span>, <span class="number">20</span>),(<span class="number">21</span>, <span class="number">21</span>, <span class="number">21</span>),(<span class="number">22</span>, <span class="number">22</span>, <span class="number">22</span>),(<span class="number">23</span>, <span class="number">23</span>, <span class="number">23</span>),(<span class="number">24</span>, <span class="number">24</span>, <span class="number">24</span>),(<span class="number">25</span>, <span class="number">25</span>, <span class="number">25</span>),(<span class="number">26</span>, <span class="number">26</span>, <span class="number">26</span>),(<span class="number">27</span>, <span class="number">27</span>, <span class="number">27</span>),(<span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>),(<span class="number">29</span>, <span class="number">29</span>, <span class="number">29</span>),(<span class="number">30</span>, <span class="number">30</span>, <span class="number">30</span>),(<span class="number">31</span>, <span class="number">31</span>, <span class="number">31</span>),(<span class="number">32</span>, <span class="number">32</span>, <span class="number">32</span>),(<span class="number">33</span>, <span class="number">33</span>, <span class="number">33</span>),(<span class="number">34</span>, <span class="number">34</span>, <span class="number">34</span>),(<span class="number">35</span>, <span class="number">35</span>, <span class="number">35</span>),(<span class="number">36</span>, <span class="number">36</span>, <span class="number">36</span>),(<span class="number">37</span>, <span class="number">37</span>, <span class="number">37</span>),(<span class="number">38</span>, <span class="number">38</span>, <span class="number">38</span>),(<span class="number">39</span>, <span class="number">39</span>, <span class="number">39</span>),(<span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>),(<span class="number">41</span>, <span class="number">41</span>, <span class="number">41</span>),(<span class="number">42</span>, <span class="number">42</span>, <span class="number">42</span>),(<span class="number">43</span>, <span class="number">43</span>, <span class="number">43</span>),(<span class="number">44</span>, <span class="number">44</span>, <span class="number">44</span>),(<span class="number">45</span>, <span class="number">45</span>, <span class="number">45</span>),(<span class="number">46</span>, <span class="number">46</span>, <span class="number">46</span>),(<span class="number">47</span>, <span class="number">47</span>, <span class="number">47</span>),(<span class="number">48</span>, <span class="number">48</span>, <span class="number">48</span>),(<span class="number">49</span>, <span class="number">49</span>, <span class="number">49</span>),(<span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>)</span><br><span class="line">Query	<span class="keyword">SELECT</span> @<span class="variable">@session</span>.transaction_read_only</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id, id) <span class="keyword">values</span> (<span class="number">51</span>, <span class="number">51</span>, <span class="number">51</span>),(<span class="number">52</span>, <span class="number">52</span>, <span class="number">52</span>),(<span class="number">53</span>, <span class="number">53</span>, <span class="number">53</span>),(<span class="number">54</span>, <span class="number">54</span>, <span class="number">54</span>),(<span class="number">55</span>, <span class="number">55</span>, <span class="number">55</span>),(<span class="number">56</span>, <span class="number">56</span>, <span class="number">56</span>),(<span class="number">57</span>, <span class="number">57</span>, <span class="number">57</span>),(<span class="number">58</span>, <span class="number">58</span>, <span class="number">58</span>),(<span class="number">59</span>, <span class="number">59</span>, <span class="number">59</span>),(<span class="number">60</span>, <span class="number">60</span>, <span class="number">60</span>),(<span class="number">61</span>, <span class="number">61</span>, <span class="number">61</span>),(<span class="number">62</span>, <span class="number">62</span>, <span class="number">62</span>),(<span class="number">63</span>, <span class="number">63</span>, <span class="number">63</span>),(<span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>),(<span class="number">65</span>, <span class="number">65</span>, <span class="number">65</span>),(<span class="number">66</span>, <span class="number">66</span>, <span class="number">66</span>),(<span class="number">67</span>, <span class="number">67</span>, <span class="number">67</span>),(<span class="number">68</span>, <span class="number">68</span>, <span class="number">68</span>),(<span class="number">69</span>, <span class="number">69</span>, <span class="number">69</span>),(<span class="number">70</span>, <span class="number">70</span>, <span class="number">70</span>),(<span class="number">71</span>, <span class="number">71</span>, <span class="number">71</span>),(<span class="number">72</span>, <span class="number">72</span>, <span class="number">72</span>),(<span class="number">73</span>, <span class="number">73</span>, <span class="number">73</span>),(<span class="number">74</span>, <span class="number">74</span>, <span class="number">74</span>),(<span class="number">75</span>, <span class="number">75</span>, <span class="number">75</span>),(<span class="number">76</span>, <span class="number">76</span>, <span class="number">76</span>),(<span class="number">77</span>, <span class="number">77</span>, <span class="number">77</span>),(<span class="number">78</span>, <span class="number">78</span>, <span class="number">78</span>),(<span class="number">79</span>, <span class="number">79</span>, <span class="number">79</span>),(<span class="number">80</span>, <span class="number">80</span>, <span class="number">80</span>),(<span class="number">81</span>, <span class="number">81</span>, <span class="number">81</span>),(<span class="number">82</span>, <span class="number">82</span>, <span class="number">82</span>),(<span class="number">83</span>, <span class="number">83</span>, <span class="number">83</span>),(<span class="number">84</span>, <span class="number">84</span>, <span class="number">84</span>),(<span class="number">85</span>, <span class="number">85</span>, <span class="number">85</span>),(<span class="number">86</span>, <span class="number">86</span>, <span class="number">86</span>),(<span class="number">87</span>, <span class="number">87</span>, <span class="number">87</span>),(<span class="number">88</span>, <span class="number">88</span>, <span class="number">88</span>),(<span class="number">89</span>, <span class="number">89</span>, <span class="number">89</span>),(<span class="number">90</span>, <span class="number">90</span>, <span class="number">90</span>),(<span class="number">91</span>, <span class="number">91</span>, <span class="number">91</span>),(<span class="number">92</span>, <span class="number">92</span>, <span class="number">92</span>),(<span class="number">93</span>, <span class="number">93</span>, <span class="number">93</span>),(<span class="number">94</span>, <span class="number">94</span>, <span class="number">94</span>),(<span class="number">95</span>, <span class="number">95</span>, <span class="number">95</span>),(<span class="number">96</span>, <span class="number">96</span>, <span class="number">96</span>),(<span class="number">97</span>, <span class="number">97</span>, <span class="number">97</span>),(<span class="number">98</span>, <span class="number">98</span>, <span class="number">98</span>),(<span class="number">99</span>, <span class="number">99</span>, <span class="number">99</span>),(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line">Query	<span class="keyword">commit</span></span><br><span class="line">Query	<span class="keyword">SET</span> autocommit<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>실제 mysql 로그에서는 Batch Insert를 확인할 수 있습니다. 그런데 왜 2번에 걸쳐서 Batch Insert가 진행되었을까요? <strong><code>hibernate.jdbc.batch_size: 50</code>설정으로 Batch Insert에 대한 size를 50으로 지정했기 때문에 rows 100를 저장할 때 2번에 걸쳐 insert를 진행하는 것입니다.</strong> 만약 <code>hibernate.jdbc.batch_size: 100</code>이라면 1번의 insert로 저장됩니다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id, id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>),(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>),(<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>),(<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>),(<span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>),(<span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>),(<span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>),(<span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>),(<span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>),(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>),(<span class="number">11</span>, <span class="number">11</span>, <span class="number">11</span>),(<span class="number">12</span>, <span class="number">12</span>, <span class="number">12</span>),(<span class="number">13</span>, <span class="number">13</span>, <span class="number">13</span>),(<span class="number">14</span>, <span class="number">14</span>, <span class="number">14</span>),(<span class="number">15</span>, <span class="number">15</span>, <span class="number">15</span>),(<span class="number">16</span>, <span class="number">16</span>, <span class="number">16</span>),(<span class="number">17</span>, <span class="number">17</span>, <span class="number">17</span>),(<span class="number">18</span>, <span class="number">18</span>, <span class="number">18</span>),(<span class="number">19</span>, <span class="number">19</span>, <span class="number">19</span>),(<span class="number">20</span>, <span class="number">20</span>, <span class="number">20</span>),(<span class="number">21</span>, <span class="number">21</span>, <span class="number">21</span>),(<span class="number">22</span>, <span class="number">22</span>, <span class="number">22</span>),(<span class="number">23</span>, <span class="number">23</span>, <span class="number">23</span>),(<span class="number">24</span>, <span class="number">24</span>, <span class="number">24</span>),(<span class="number">25</span>, <span class="number">25</span>, <span class="number">25</span>),(<span class="number">26</span>, <span class="number">26</span>, <span class="number">26</span>),(<span class="number">27</span>, <span class="number">27</span>, <span class="number">27</span>),(<span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>),(<span class="number">29</span>, <span class="number">29</span>, <span class="number">29</span>),(<span class="number">30</span>, <span class="number">30</span>, <span class="number">30</span>),(<span class="number">31</span>, <span class="number">31</span>, <span class="number">31</span>),(<span class="number">32</span>, <span class="number">32</span>, <span class="number">32</span>),(<span class="number">33</span>, <span class="number">33</span>, <span class="number">33</span>),(<span class="number">34</span>, <span class="number">34</span>, <span class="number">34</span>),(<span class="number">35</span>, <span class="number">35</span>, <span class="number">35</span>),(<span class="number">36</span>, <span class="number">36</span>, <span class="number">36</span>),(<span class="number">37</span>, <span class="number">37</span>, <span class="number">37</span>),(<span class="number">38</span>, <span class="number">38</span>, <span class="number">38</span>),(<span class="number">39</span>, <span class="number">39</span>, <span class="number">39</span>),(<span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>),(<span class="number">41</span>, <span class="number">41</span>, <span class="number">41</span>),(<span class="number">42</span>, <span class="number">42</span>, <span class="number">42</span>),(<span class="number">43</span>, <span class="number">43</span>, <span class="number">43</span>),(<span class="number">44</span>, <span class="number">44</span>, <span class="number">44</span>),(<span class="number">45</span>, <span class="number">45</span>, <span class="number">45</span>),(<span class="number">46</span>, <span class="number">46</span>, <span class="number">46</span>),(<span class="number">47</span>, <span class="number">47</span>, <span class="number">47</span>),(<span class="number">48</span>, <span class="number">48</span>, <span class="number">48</span>),(<span class="number">49</span>, <span class="number">49</span>, <span class="number">49</span>),(<span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>),(<span class="number">51</span>, <span class="number">51</span>, <span class="number">51</span>),(<span class="number">52</span>, <span class="number">52</span>, <span class="number">52</span>),(<span class="number">53</span>, <span class="number">53</span>, <span class="number">53</span>),(<span class="number">54</span>, <span class="number">54</span>, <span class="number">54</span>),(<span class="number">55</span>, <span class="number">55</span>, <span class="number">55</span>),(<span class="number">56</span>, <span class="number">56</span>, <span class="number">56</span>),(<span class="number">57</span>, <span class="number">57</span>, <span class="number">57</span>),(<span class="number">58</span>, <span class="number">58</span>, <span class="number">58</span>),(<span class="number">59</span>, <span class="number">59</span>, <span class="number">59</span>),(<span class="number">60</span>, <span class="number">60</span>, <span class="number">60</span>),(<span class="number">61</span>, <span class="number">61</span>, <span class="number">61</span>),(<span class="number">62</span>, <span class="number">62</span>, <span class="number">62</span>),(<span class="number">63</span>, <span class="number">63</span>, <span class="number">63</span>),(<span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>),(<span class="number">65</span>, <span class="number">65</span>, <span class="number">65</span>),(<span class="number">66</span>, <span class="number">66</span>, <span class="number">66</span>),(<span class="number">67</span>, <span class="number">67</span>, <span class="number">67</span>),(<span class="number">68</span>, <span class="number">68</span>, <span class="number">68</span>),(<span class="number">69</span>, <span class="number">69</span>, <span class="number">69</span>),(<span class="number">70</span>, <span class="number">70</span>, <span class="number">70</span>),(<span class="number">71</span>, <span class="number">71</span>, <span class="number">71</span>),(<span class="number">72</span>, <span class="number">72</span>, <span class="number">72</span>),(<span class="number">73</span>, <span class="number">73</span>, <span class="number">73</span>),(<span class="number">74</span>, <span class="number">74</span>, <span class="number">74</span>),(<span class="number">75</span>, <span class="number">75</span>, <span class="number">75</span>),(<span class="number">76</span>, <span class="number">76</span>, <span class="number">76</span>),(<span class="number">77</span>, <span class="number">77</span>, <span class="number">77</span>),(<span class="number">78</span>, <span class="number">78</span>, <span class="number">78</span>),(<span class="number">79</span>, <span class="number">79</span>, <span class="number">79</span>),(<span class="number">80</span>, <span class="number">80</span>, <span class="number">80</span>),(<span class="number">81</span>, <span class="number">81</span>, <span class="number">81</span>),(<span class="number">82</span>, <span class="number">82</span>, <span class="number">82</span>),(<span class="number">83</span>, <span class="number">83</span>, <span class="number">83</span>),(<span class="number">84</span>, <span class="number">84</span>, <span class="number">84</span>),(<span class="number">85</span>, <span class="number">85</span>, <span class="number">85</span>),(<span class="number">86</span>, <span class="number">86</span>, <span class="number">86</span>),(<span class="number">87</span>, <span class="number">87</span>, <span class="number">87</span>),(<span class="number">88</span>, <span class="number">88</span>, <span class="number">88</span>),(<span class="number">89</span>, <span class="number">89</span>, <span class="number">89</span>),(<span class="number">90</span>, <span class="number">90</span>, <span class="number">90</span>),(<span class="number">91</span>, <span class="number">91</span>, <span class="number">91</span>),(<span class="number">92</span>, <span class="number">92</span>, <span class="number">92</span>),(<span class="number">93</span>, <span class="number">93</span>, <span class="number">93</span>),(<span class="number">94</span>, <span class="number">94</span>, <span class="number">94</span>),(<span class="number">95</span>, <span class="number">95</span>, <span class="number">95</span>),(<span class="number">96</span>, <span class="number">96</span>, <span class="number">96</span>),(<span class="number">97</span>, <span class="number">97</span>, <span class="number">97</span>),(<span class="number">98</span>, <span class="number">98</span>, <span class="number">98</span>),(<span class="number">99</span>, <span class="number">99</span>, <span class="number">99</span>),(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>위 쿼리는 <code>hibernate.jdbc.batch_size: 100</code>으로 지정한 결과입니다. 그렇다면 왜 <code>batch_size</code> 옵션을 주어서 한 번에 insert 할 수 있는 데이터의 크기를 제한하는 것일까요? 아래 코드에서 해답을 찾을 수 있습니다.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#batch-jdbcbatch">Hibernate User Guide: 12.2.1. Batch inserts</a></p>
<p>When you make new objects persistent, employ methods flush() and clear() to the session regularly, to control the size of the first-level cache.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">EntityManager</span> <span class="variable">entityManager</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">EntityTransaction</span> <span class="variable">txn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	entityManager = entityManagerFactory().createEntityManager();</span><br><span class="line"></span><br><span class="line">	txn = entityManager.getTransaction();</span><br><span class="line">	txn.begin();</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> ( <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; entityCount; i++ ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( i &gt; <span class="number">0</span> &amp;&amp; i % batchSize == <span class="number">0</span> ) &#123;</span><br><span class="line">			<span class="comment">//flush a batch of inserts and release memory</span></span><br><span class="line">			entityManager.flush();</span><br><span class="line">			entityManager.clear();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">Person</span> <span class="variable">Person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>( String.format( <span class="string">&quot;Person %d&quot;</span>, i ) );</span><br><span class="line">		entityManager.persist( Person );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	txn.commit();</span><br><span class="line">&#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">	<span class="keyword">if</span> ( txn != <span class="literal">null</span> &amp;&amp; txn.isActive()) txn.rollback();</span><br><span class="line">		<span class="keyword">throw</span> e;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (entityManager != <span class="literal">null</span>) &#123;</span><br><span class="line">		entityManager.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>하이버네이트 공식 가이드의 내용입니다. <code>batchSize</code> 값을 기준으로 <code>flush();</code>, <code>clear();</code>를 이용해서 영속성 컨텍스트를 초기화 작업을 진행하고 있습니다. <code>batchSize</code>에 대한 제한이 없으면 영속성 컨텍스트에 모든 엔티티가 올라가기 때문에 <code>OutOfMemoryException</code> 발생할 수 있고, 메모리 관리 측면에서도 효율적이지 않기 때문입니다. 하이버네이트의 공식 가이드에서도 해당 부분의 언급이 있습니다.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#batch-session-batch">Hibernate User Guide: 12.2. Session batching</a></p>
<ol>
<li>Hibernate caches all the newly inserted Customer instances in the session-level cache, so, when the transaction ends, 100 000 entities are managed by the persistence context. If the maximum memory allocated to the JVM is rather low, this example could fail with an OutOfMemoryException. The Java 1.8 JVM allocated either 1&#x2F;4 of available RAM or 1Gb, which can easily accommodate 100 000 objects on the heap.</li>
<li>long-running transactions can deplete a connection pool so other transactions don’t get a chance to proceed</li>
<li>JDBC batching is not enabled by default, so every insert statement requires a database roundtrip. To enable JDBC batching, set the hibernate.jdbc.batch_size property to an integer between 10 and 50.</li>
</ol>
</blockquote>
<h3 id="쓰기-지연-SQL-제약-사항"><a href="#쓰기-지연-SQL-제약-사항" class="headerlink" title="쓰기 지연 SQL 제약 사항"></a>쓰기 지연 SQL 제약 사항</h3><p><code>batchSize: 50</code> 경우 <code>PaymentBackJpa</code> 객체를 50 단위로 Batch Insert 쿼리가 실행되지만, 중간에 다른 엔티티를 저장하는 경우 아래처럼 지금까지의 <code>PaymentBackJpa</code>에 대한 지정하기 때문에 최종적으로 <code>batchSize: 50</code> 단위로 저장되지 않습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">em.persist(<span class="keyword">new</span> <span class="title class_">PaymentBackJpa</span>()); <span class="comment">// 1</span></span><br><span class="line">em.persist(<span class="keyword">new</span> <span class="title class_">PaymentBackJpa</span>()); <span class="comment">// 2</span></span><br><span class="line">em.persist(<span class="keyword">new</span> <span class="title class_">PaymentBackJpa</span>()); <span class="comment">// 3</span></span><br><span class="line">em.persist(<span class="keyword">new</span> <span class="title class_">PaymentBackJpa</span>()); <span class="comment">// 4</span></span><br><span class="line">em.persist(<span class="keyword">new</span> <span class="title class_">Orders</span>()); <span class="comment">// 1-1, 다른 SQL이 추가 되었기 때문에  SQL 배치를 다시 시작 해야 한다.</span></span><br><span class="line">em.persist(<span class="keyword">new</span> <span class="title class_">PaymentBackJpa</span>()); <span class="comment">// 1</span></span><br><span class="line">em.persist(<span class="keyword">new</span> <span class="title class_">PaymentBackJpa</span>()); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
<p>이러한 문제는 <code>hibernate.order_updates: true</code>, <code>hibernate.order_inserts: true</code> 값으로 해결 할 수 있습니다.</p>
<h3 id="JPA-Batch-Insert의-가장-큰-문제…"><a href="#JPA-Batch-Insert의-가장-큰-문제…" class="headerlink" title="JPA Batch Insert의 가장 큰 문제…"></a>JPA Batch Insert의 가장 큰 문제…</h3><p>위에서 설명했던 부분들은 Batch Insert에 필요한 properties 설정, 그리고 내부적으로 JPA에서 Batch Insert에 대한 동작 방식을 설명한 것입니다. <strong>실제 Batch Insert를 진행하는 코드는 별다른 부분이 없고 컬렉션 객체를 <code>saveAll()</code> 메서드로 호출하는 것이 전부입니다.</strong> 이로써 JPA는 Batch Insert를 강력하게 지원해 주고 있습니다. <strong>하지만 가장 큰 문제가 있습니다. <code>@GeneratedValue(strategy = GenerationType.IDENTITY)</code> 방식의 경우 Batch Insert를 지원하지 않습니다.</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#batch-session-batch">Hibernate User Guide: 12.2. Session batching</a></p>
<p>Hibernate disables insert batching at the JDBC level transparently if you use an identity identifier generator.</p>
</blockquote>
<p>공식 문서에도 언급이 있듯이 <code>@GeneratedValue(strategy = GenerationType.IDENTITY)</code> 경우 Batch Insert를 지원하지 않습니다. 정확히 어떤 이유 때문인지에 대해서는 언급이 없고, 관련 내용을 잘 설명한 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/27697810/why-does-hibernate-disable-insert-batching-when-using-an-identity-identifier-gen/27732138#27732138">StackOverflow</a>를 첨부합니다.</p>
<p>제가 이해한 바로는 하이버네이트는 <code>Transactional Write Behind</code> 방식(마지막까지 영속성 컨텍스트에서 데이터를 가지고 있어 플러시를 연기하는 방식)을 사용하기 때문에 <code>GenerationType.IDENTITY</code> 방식의 경우 JDBC Batch Insert를 비활성화함. <code>GenerationType.IDENTITY</code> 방식이란 <code>auto_increment</code>으로 PK 값을 자동으로 증분 해서 생성하는 것으로 매우 효율적으로 관리할 수 있다.(heavyweight transactional course-grain locks 보다 효율적). 하지만 Insert를 실행하기 전까지는 ID에 할당된 값을 알 수 없기 때문에 <code>Transactional Write Behind</code>을 할 수 없고 결과적으로 Batch Insert를 진행할 수 없다.</p>
<p>Mysql에서는 대부분 <code>GenerationType.IDENTITY</code>으로 사용하기 때문에 해당 문제는 치명적입니다. 우선 <code>GenerationType.IDENTITY</code> 으로 지정하고 다시 테스트 코드를 돌려 보겠습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = <span class="string">&quot;payment_back&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PaymentBackJpa</span>(</span><br><span class="line">    <span class="meta">@Column(name = <span class="string">&quot;amount&quot;</span>, nullable = false)</span></span><br><span class="line">    <span class="keyword">var</span> amount: BigDecimal,</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = <span class="string">&quot;order_id&quot;</span>, nullable = false, updatable = false)</span></span><br><span class="line">    <span class="keyword">val</span> orderId: <span class="built_in">Long</span></span><br><span class="line">)&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span> <span class="comment">// GenerationType.IDENTITY 지정</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Long</span>? = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">BulkInsertJobConfigurationTest</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paymentBackJpaRepository: PaymentBackJpaRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `jpa 기반 bulk insert`<span class="params">()</span></span> &#123;</span><br><span class="line">        (<span class="number">1.</span><span class="number">.100</span>).map &#123;</span><br><span class="line">            PaymentBackJpa(</span><br><span class="line">                amount = it.toBigDecimal(),</span><br><span class="line">                orderId = it.toLong()</span><br><span class="line">            )</span><br><span class="line">                .apply &#123;</span><br><span class="line"><span class="comment">//                    this.id = it.toLong() // ID를 자동 증가로 변경 했기 때문에 코드 주석</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;.also &#123;</span><br><span class="line">            paymentBackJpaRepository.saveAll(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">4</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">5</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">6</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">7</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">8</span>, <span class="number">8</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">9</span>, <span class="number">9</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">11</span>, <span class="number">11</span>)</span><br><span class="line">Query	<span class="keyword">insert into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">12</span>, <span class="number">12</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong><code>GenerationType.IDENTITY</code>의 경우에는 Batch Insert가 진행되지 않습니다.</strong> 그래서 다른 대안을 찾아야 했습니다. 이 부분부터는 다음 포스팅에서 이어가겠습니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a target="_blank" rel="noopener" href="https://homoefficio.github.io/2020/01/25/Spring-Data%EC%97%90%EC%84%9C-Batch-Insert-%EC%B5%9C%EC%A0%81%ED%99%94/">Spring Data에서 Batch Insert 최적화</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/HomoEfficio/dev-tips/blob/master/JPA-GenerationType-%EB%B3%84-INSERT-%EC%84%B1%EB%8A%A5-%EB%B9%84%EA%B5%90.md">JPA GenerationType에 따른 INSERT 성능 차이</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#batch-session-batch-insert">JPA Batch inserts Document</a></li>
<li><a target="_blank" rel="noopener" href="https://vladmihalcea.com/jpa-persist-and-merge/">How do persist and merge work in JPA</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/connector-j/8.0/en/">MySQL Connector&#x2F;J 8.0 Developer Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html">Hibernate ORM 5.4.28.Final User Guide</a></li>
<li><a target="_blank" rel="noopener" href="http://www.acornpub.co.kr/book/jpa-programmig">자바 ORM 표준 JPA 프로그래밍</a></li>
</ul>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Batch-Insert/" rel="tag">Batch Insert</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/JPA/" rel="tag">JPA</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/ORM/" rel="tag">ORM</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Performance/" rel="tag">Performance</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-batch-batch-insert/"
                    data-tooltip="Batch Insert 성능 향상기 2편 - 성능 측정"
                    aria-label="이전: Batch Insert 성능 향상기 2편 - 성능 측정"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-batch-test-2/"
                    data-tooltip="Spring Batch Test 작성 방법 및 고찰"
                    aria-label="다음: Spring Batch Test 작성 방법 및 고찰"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/jpa-batch-insert/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/jpa-batch-insert/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://cheese10yun.github.io/jpa-batch-insert/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>


<!-- Comment -->
<!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-batch-batch-insert/"
                    data-tooltip="Batch Insert 성능 향상기 2편 - 성능 측정"
                    aria-label="이전: Batch Insert 성능 향상기 2편 - 성능 측정"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-batch-test-2/"
                    data-tooltip="Spring Batch Test 작성 방법 및 고찰"
                    aria-label="다음: Spring Batch Test 작성 방법 및 고찰"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/jpa-batch-insert/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/jpa-batch-insert/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://cheese10yun.github.io/jpa-batch-insert/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/jpa-batch-insert/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/jpa-batch-insert/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://cheese10yun.github.io/jpa-batch-insert/"
                        aria-label="Google+에 공유하기"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Google+에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>

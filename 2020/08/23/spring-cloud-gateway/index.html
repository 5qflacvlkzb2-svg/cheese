
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Yun Blog">
    <title>Spring Cloud Gateway - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"\n해당 코드는 Github 공개되어 있습니다.\n\n용어\n\n\n명칭\n설명\n\n\n\n라우트(Route)\n라우트는 목적지 URI, 조건자 목록과 필터의 목록을 식별하기 위한 고유 ID로 구성된다. 라우트는 모든 조건자가 충족됐을 때만 매칭된다\n\n\n조건자(Predicates)\n각 요청을 처리하기 전에 실행되는 로직, 헤더와 입력된 값 등 다양한 HTTP 요청이 정의된 기준에 맞는지를 찾는다.\n\n\n필터(Filters)\nHTTP 요청 또는 나가는 HTTP 응답을 수정할 수 있게한다. 다운스트림 요청을 보내기전이나 후에 수정할 수 있다. 라우트 필터는 특정 라우트에 한정된다.\n\n\nGetting Started12implementation(&quot;org.springframework.cloud:spring-cloud-starter-gateway&quot;)implementation(&quot;org.springframework.boot:spring-boot-starter-actuator&quot;)\n\n123456@SpringBootApplicationclass GatewayServerApplicationfun main(args: Array&lt;String&gt;) &#123;    runApplication&lt;GatewayServerApplication&gt;(*args)&#125;\n필요한 의존성만 추가하면 빠르게 Spring Cloud Gateway를 만들 수 있습니다.\nGateway Route 노출123456789management:    endpoints:        web:            exposure:                include:                    - &quot;gateway&quot;    endpoint:        gateway:            enabled: true\n위에서 추가한 actuator의존성으로 gateway를 노출하면 아래처럼 url mapping 정보를 확인할 수 있습니다.\n\n현재 아무것도 설정하지 않은 상태이기 때문에 /actuator/gateway/routes를 호출하면 아래와 같은 결과를 확인할 수 있습니다.\n123456789GET http://127.0.0.1:5555/actuator/gateway/routesHTTP/1.1 200 OKtransfer-encoding: chunkedContent-Type: application/json[]Response code: 200 (OK); Time: 321ms; Content length: 2 bytes\n\nRoute 설정API를 서버를 만들고 게이트웨이와 연결해 보겠습니다.\n12345678910111213141516cloud:    gateway:        routes:            -   id: order-service                uri: http://localhost:8181                predicates:                    - Path=/order/**                filters:                    - RewritePath=/order/(?&lt;path&gt;.*),/$\\&#123;path&#125;            -   id: cart-service                uri: http://localhost:8181                predicates:                    - Path=/cart/**                filters:                    - RewritePath=/cart/(?&lt;path&gt;.*),/$\\&#123;path&#125;\n\nid: 해당 라우트의 고유 식별자를 나타냅니다.\nuri: 해당 라우터의 주소를 나타냅니다.\npredicates: 해당 라우터의 조건을 작성, /order/**으로 시작하는 요청의 경우 해당 라우터로 요청을 보냄\nfilters: 해당 라우터의 필터로, RewritePath는 강제로 Path를 다시 작성합니다.\n\n연결할 API Servercart-service, order-service 2 개의 API 서버를 구성합니다. 각 포트의 설정은 cloud.gateway.routes에 등록된 포트를 설정합니다.\norder-service12345678910111213141516171819@RestController@RequestMapping(&quot;/orders&quot;)class OrderApi(        private val orderRepository: OrderRepository) &#123;    @GetMapping    fun getOrders(pageable: Pageable) = orderRepository.findAll(pageable)&#125;@Entity@Table(name = &quot;orders&quot;)class Order(        @Column(name = &quot;product_id&quot;, nullable = false)        val productId: Long) : EntityAuditing() &#123;    @Column(name = &quot;order_number&quot;, nullable = false)    val orderNumber: String = UUID.randomUUID().toString()&#125;\ncart-service123456789101112131415@RestController@RequestMapping(&quot;/carts&quot;)class CartApi(        private val cartRepository: CartRepository) &#123;    @GetMapping    fun getCarts(pageable: Pageable) = cartRepository.findAll(pageable)&#125;@Entity@Table(name = &quot;cart&quot;)class Cart(        @Column(name = &quot;product_id&quot;, nullable = false)        var productId: Long) : EntityAuditing()\n\nRouter 확인actuator/gateway/routes 확인을 해보면 위에서 설정한 라우터를 확인할 수 있습니다.\n12345678910111213141516171819202122232425262728GET http://127.0.0.1:5555/actuator/gateway/routesHTTP/1.1 200 OKtransfer-encoding: chunkedContent-Type: application/json[  &#123;    &quot;predicate&quot;: &quot;Paths: [/order/**], match trailing slash: true&quot;,    &quot;route_id&quot;: &quot;order-service&quot;,    &quot;filters&quot;: [      &quot;[[RewritePath /order/(?&lt;path&gt;.*) = &#x27;/$&#123;path&#125;&#x27;], order = 1]&quot;    ],    &quot;uri&quot;: &quot;http://localhost:8181&quot;,    &quot;order&quot;: 0  &#125;,  &#123;    &quot;predicate&quot;: &quot;Paths: [/cart/**], match trailing slash: true&quot;,    &quot;route_id&quot;: &quot;cart-service&quot;,    &quot;filters&quot;: [      &quot;[[RewritePath /cart/(?&lt;path&gt;.*) = &#x27;/$&#123;path&#125;&#x27;], order = 1]&quot;    ],    &quot;uri&quot;: &quot;http://localhost:8181&quot;,    &quot;order&quot;: 0  &#125;]Response code: 200 (OK); Time: 207ms; Content length: 404 bytes\n연결된 서비스 확인123456789101112131415161718192021222324252627GET http://localhost:5555/order/orders?page=0&amp;size=5HTTP/1.1 200 OKContent-Type: application/jsonContent-Length: 1075Date: Sat, 22 Aug 2020 09:29:57 GMTCUSTOM-RESPONSE-HEADER: It worked&#123;  &quot;content&quot;: [    &#123;      &quot;productId&quot;: 1,      &quot;id&quot;: 1,      &quot;createdAt&quot;: &quot;2020-08-22T17:19:08.038&quot;,      &quot;updatedAt&quot;: &quot;2020-08-22T17:19:08.038&quot;,      &quot;orderNumber&quot;: &quot;7d684c44-1ea3-4dc4-9247-12c351606df3&quot;    &#125;,    ...  ],  &quot;pageable&quot;: &#123;    ...  &#125;,  &quot;last&quot;: false,  ...&#125;Response code: 200 (OK); Time: 168ms; Content length: 1075 bytes\n\n게이트웨이 /order/orders?page=0&amp;size=5를 호출하면 filters.RewritePath에 의해서 orders?page=0&amp;size=5를 호출하게 됩니다. 즉 라우터에 등록된 order-service를 호출하게 됩니다.\nPredicatesPredicates는 조건으로서 해당 라우터에 라우팅 될 조건을 표시합니다. 위 예제에서는 Path=/order/**, Path=/cart/**으로 해당 path로 들어오는 경우 해당 라우터로 라우팅 됩니다. 그 밖에도 여러 가지를 지원합니다. 대표적인 몇 개를 정리해보았습니다. 날짜 관련 매개변수는 ZonedDateTime를 사용해야 합니다.\nAfter123456routes:    -   id: order-service        uri: http://localhost:8181        predicates:            - Path=/order/**            - After=2020-08-23T19:25:19.126+09:00[Asia/Seoul]\n\nAfter는 특정 날짜 이후에 호출이 가능합니다. 현재 날짜가 After에서 지정한 날짜 보다 이후 이어야 합니다. 서비스에 대한 이벤트 API 등 특정 시점에 Open 시킬 API가 있다면 유용합니다.\n12345678910111213141516GET http://localhost:5555/order/orders?page=0&amp;size=5HTTP/1.1 404 Not FoundContent-Type: application/jsonContent-Length: 141&#123;  &quot;timestamp&quot;: &quot;2020-08-22T10:37:11.955+00:00&quot;,  &quot;path&quot;: &quot;/order/orders&quot;,  &quot;status&quot;: 404,  &quot;error&quot;: &quot;Not Found&quot;,  &quot;message&quot;: null,  &quot;requestId&quot;: &quot;9b635742-2&quot;&#125;Response code: 404 (Not Found); Time: 28ms; Content length: 141 bytes\n현재 시각 2020-08-22T19:25:19.126+09:00[Asia/Seoul] 이라면 HTTP/1.1 404 Not Found을 응답 받게됩니다.\nBefore123456routes:    -   id: order-service        uri: http://localhost:8181        predicates:            - Path=/order/**            - Before=2020-08-20T19:25:19.126+09:00[Asia/Seoul]\nBefore는 특정 날짜 이전 호출이 가능합니다. 현재 날짜가 Before에서 지정한 날짜 보다 이전 이어야 합니다. 특정 API가 deprecate가 되는 경우 유용합니다.\nBetween123456routes:    -   id: order-service        uri: http://localhost:8181        predicates:            - Path=/order/**            - Between=2020-08-17T19:25:19.126+09:00[Asia/Seoul], 2020-08-20T19:25:19.126+09:00[Asia/Seoul]\nBetween는 특정 날짜 사이에만 호출이 가능합니다. 특정 기간에만 사용하는 이벤트 API 등에 사용하면 유용합니다.\nWeight12345678910111213141516routes:    -   id: order-service-high        uri: http://localhost:8181        predicates:            - Path=/order/**            - Weight=group-order, 7        filters:            - RewritePath=/order/(?&lt;path&gt;.*),/$\\&#123;path&#125;    -   id: order-service-low        uri: http://localhost:8787        predicates:            - Path=/order/**            - Weight=group-order, 3        filters:            - RewritePath=/order/(?&lt;path&gt;.*),/$\\&#123;path&#125;\ngroup, weight를 기반으로 그룹별로 가중치를 계산하게 됩니다. 위 설정은 70% order-service-high, 30% order-service-low으로 라우팅을 분배합니다.\nFiltersHTTP Request, Reponse에 대한 수정을 할 수 있습니다. 특정 라우터에에서 안에서 동작하게 됩니다.\nRewritePathRewritePath는 HTTP Request를 수정하여 특정 Server에 전달하게 됩니다. 정규표현식을 사용해서 유연하게 HTTP Request Path를 변경합니다.\n12345routes:    -   id: order-service        uri: http://localhost:8181        filters:            - RewritePath=/order/(?&lt;path&gt;.*),/$\\&#123;path&#125;\n\nRewritePath를 통해서 /order/orders -&gt; /order/orders으로 재작성합니다. 즉, /order/orders?page=0&amp;size=5 요청이 오면 /order/를제거하고 orders?page=0&amp;size=5를 기반으로 order-service를 호출하게 됩니다.\nRetry\n\n\nname\n설명\n기본값\n\n\n\nretries\n재시도 횟수\n3번\n\n\nstatuses\n재시도해야하는 HTTP 상태 코드(org.springframework.http.HttpStatus)\n-\n\n\nseries\n재시도해야하는 HTTP 상태 코드시리즈(org.springframework.http.HttpStatus.Series)\n5XX\n\n\nmethods\n재시도해야하는 HTTP 메소드(org.springframework.http.HttpMethod)\nGET\n\n\nexceptions\n재시도해야하는 Exception\nIOException, TimeoutException\n\n\nbackoff\n재시도하는 시간텀 지정 firstBackoff * (factor ^ n) n번 반복\n비활성화\n\n\n1234567891011121314151617181920212223spring:    cloud:        gateway:            discovery:                locator:                    enabled: true            routes:                -   id: order-service                    uri: lb://order-service                    predicates:                        - Path=/order/**                    filters:                        - RewritePath=/order/(?&lt;path&gt;.*),/$\\&#123;path&#125;                        -   name: Retry                            args:                                retries: 3                                statuses: INTERNAL_SERVER_ERROR                                methods: GET                                backoff:                                    firstBackoff: 1000ms                                    maxBackoff: 6000ms                                    factor: 2                                    basedOnPreviousValue: false\n제시도 횟수는 retries: 3, 재시도 HTTP Status는 statuses: INTERNAL_SERVER_ERROR (500), 재시도 HTTP method는 GET backoff 설정은 1000ms(firstBackoff) * (2(factor) ^ n(retries))으로 retries 만큼 반복됩니다.\n123456789101112131415161718@RestController@RequestMapping(&quot;/orders&quot;)class OrderApi(        private val orderRepository: OrderRepository) &#123;    @GetMapping    fun getOrders(pageable: Pageable): Page&lt;Order&gt; &#123;        println(&quot;getOrders 호출&quot;)        if(true)&#123;            throw RuntimeException(&quot;Error&quot;)        &#125;        return orderRepository.findAll(pageable)    &#125;    @GetMapping(&quot;/carts/&#123;id&#125;&quot;)    fun getCarts(@PathVariable id: Long) = cartClient.getCart(id)&#125;\n해당 API는 RuntimeException(&quot;Error&quot;)를 발생시키고 있어 Status 500을 응답합니다.\n1234567891011121314151617GET http://localhost:5555/order/orders?page=0&amp;size=5HTTP/1.1 500 Internal Server Errortransfer-encoding: chunkedContent-Type: application/jsonDate: Sat, 22 Aug 2020 14:57:15 GMTCUSTOM-RESPONSE-HEADER: It did not work&#123;  &quot;timestamp&quot;: &quot;2020-08-22T14:57:15.122+00:00&quot;,  &quot;status&quot;: 500,  &quot;error&quot;: &quot;Internal Server Error&quot;,  &quot;message&quot;: &quot;&quot;,  &quot;path&quot;: &quot;/orders&quot;&#125;Response code: 500 (Internal Server Error); Time: 7062ms; Content length: 120 bytes\n결과를 확인하면 3번의 Retry가 있었고, 결국 500을 리턴하게 됩니다.\n12345678getOrders 호출2020-08-22 23:57:08.080 ERROR [order-service,,,] 17139 --- [nio-8181-exec-7] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.RuntimeException: Error] with root causegetOrders 호출2020-08-22 23:57:09.091 ERROR [order-service,,,] 17139 --- [nio-8181-exec-8] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.RuntimeException: Error] with root causegetOrders 호출2020-08-22 23:57:11.107 ERROR [order-service,,,] 17139 --- [nio-8181-exec-9] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.RuntimeException: Error] with root cause\norder-service 로그를 확인해보면 3번의 호출이 있었는지를 확인할 수 있습니다.\n1234567891011121314151617181920@RestController@RequestMapping(&quot;/orders&quot;)class OrderApi(        private val orderRepository: OrderRepository) &#123;    var errorCount = 0    @GetMapping    fun getOrders(pageable: Pageable): Page&lt;Order&gt; &#123;        println(&quot;getOrders 호출&quot;)        if (errorCount &lt; 2) &#123;            println(&quot;예외발생 $errorCount 1증가&quot;)            errorCount++            throw RuntimeException(&quot;Error&quot;)        &#125;        errorCount = 0 // 초기화        return orderRepository.findAll(pageable)    &#125;&#125;\n해당 코드는 2번 예외가 발생하지만 3번째에서 응답을 리턴해주는 코드입니다. 재시도를 3번 실행하기 때문에 3번째에는 정상적인 응답을 받을 수 있습니다.\n1234567891011121314151617181920212223242526GET http://localhost:5555/order/orders?page=0&amp;size=5HTTP/1.1 200 OKtransfer-encoding: chunkedContent-Type: application/jsonDate: Sat, 22 Aug 2020 15:13:16 GMTCUSTOM-RESPONSE-HEADER: It worked&#123;  &quot;content&quot;: [    &#123;      &quot;productId&quot;: 1,      &quot;id&quot;: 1,      &quot;createdAt&quot;: &quot;2020-08-23T00:11:24.747&quot;,      &quot;updatedAt&quot;: &quot;2020-08-23T00:11:24.747&quot;,      &quot;orderNumber&quot;: &quot;519011ff-7eaf-4e85-b48f-a9aa6ab879ac&quot;    &#125;    ...  ],  &quot;pageable&quot;: &#123;   ...  &quot;totalPages&quot;: 2,   ...&#125;Response code: 200 (OK); Time: 3034ms; Content length: 1075 bytes\n3번의 응답시간을 기다려야 하기 때문에 3034ms 정도 걸리는 걸 확인할 수 있습니다. 재시도는 단순 조회만 하는 GET 요청에 외에는 신중하게 선택해야 합니다. 게이트웨이에서 재시도를 진행하기 때문에 각 서비스 간의 통신에서 생성, 삭제, 수정 등 조회 조건 외에 동작이 있다면 문제가 생길 가능성이 높습니다. 또 HTTP Status 5XX 응답은 재시도를 하는 것은 바람직하지만, HTTP Status 4XXX에서는 동일한 요청이면 동일한 이유로 실패하기 때문에 재시도를 안 하는 게 더 효율적입니다. 단순 조회 용이 아니면 신중하게 사용해야 합니다.\nHTTP Timeout 설정글로벌 설정123456spring:    cloud:        gateway:            httpclient:                connect-timeout: 10000                response-timeout: 10s\n\nconnect-timeout 밀리 초 단위로 지정, response-timeout Duration으로 지정 해야 합니다.\n12345678910111213@RestController@RequestMapping(&quot;/orders&quot;)class OrderApi(        private val orderRepository: OrderRepository) &#123;    @GetMapping    fun getOrders(pageable: Pageable): Page&lt;Order&gt; &#123;        Thread.sleep(1100) // timeout 발생        return orderRepository.findAll(pageable)    &#125;\n클라이언트 응답시간이 1초로 설정했기 때문에 1초를 넘어가면 아래와 같이 HTTP/1.1 504 Gateway Timeout응답을 확인할 수 있습니다.\n12345678910111213141516GET http://localhost:5555/order/orders?page=0&amp;size=5HTTP/1.1 504 Gateway TimeoutContent-Type: application/jsonContent-Length: 145&#123;  &quot;timestamp&quot;: &quot;2020-08-22T14:05:09.267+00:00&quot;,  &quot;path&quot;: &quot;/order/orders&quot;,  &quot;status&quot;: 504,  &quot;error&quot;: &quot;Gateway Timeout&quot;,  &quot;message&quot;: &quot;&quot;,  &quot;requestId&quot;: &quot;0d492aaf-1&quot;&#125;Response code: 504 (Gateway Timeout); Time: 4798ms; Content length: 145 bytes\n\n라우터별 설정12345678910111213spring:    cloud:        gateway:            routes:                -   id: order-service                    uri: lb://order-service                    predicates:                        - Path=/order/**                    filters:                        - RewritePath=/order/(?&lt;path&gt;.*),/$\\&#123;path&#125;                    metadata:                        connect-timeout: 1000                        response-timeout: 1000\nmetadata설정을 통해서 라우터별 설정을 진행할 수 있습니다. 여기서 중요한 점은 metadata 설정 시 connect-timeout, response-timeout 모두 밀리 초 단위로 지정해야 합니다. Global 설정과는 차이가 있습니다.\nLogging SleuthGateway Logging123456class GatewayServerApplicationfun main(args: Array&lt;String&gt;) &#123;    System.setProperty(&quot;reactor.netty.http.server.accessLogEnabled&quot;, &quot;true&quot;)    runApplication&lt;GatewayServerApplication&gt;(*args)&#125;\nReactor Netty 액세스 로그를 활성화하려면 System.setProperty(&quot;reactor.netty.http.server.accessLogEnabled&quot;, &quot;true&quot;)을 설정해야 합니다. 공식 문서에 따르면 Spring Boot 설정이 아니기 때문에 yml으로 설정하지 않고 위처럼 설정해야 한다고 합니다.\n\n정상적으로 로킹이 되는 것을 확인할 수 있습니다.\nSleuth스프링 클라우드 슬루스(Sleuth)는 마이크로 서비스 환경에서 서로 다른 시스템의 요청을 연결하여 로깅을 해줄 수 있게 해주는 도구입니다. 이런 경우 슬루스를 이용해서 쉽게 요청에 대한 로깅을 연결해서 볼 수 있습니다. 또 RestTemplate, 페인 클라이언트, 메시지 채널 등등 다양한 플랫폼과 연결하기 쉽습니다. 아래 예제에서는 폐인 클라이언트와 연결해서 로깅하는 방법을 설명하겠습니다.\n의존성 추가1implementation(&quot;org.springframework.cloud:spring-cloud-starter-sleuth&quot;)\ngateway-server, order-service. cart-service 모듈에 해당 의존성을 추가합니다.\n12345678910111213141516171819cloud:    gateway:        discovery:            locator:                enabled: true        routes:            -   id: order-service                uri: lb://order-service                predicates:                    - Path=/order/**                filters:                    - RewritePath=/order/(?&lt;path&gt;.*),/$\\&#123;path&#125;            -   id: cart-service                uri: lb://cart-service                predicates:                    - Path=/cart/**                filters:                    - RewritePath=/cart/(?&lt;path&gt;.*),/$\\&#123;path&#125;\nopenfeign을 이용해서 클라이언트를 호출할 것이므로 discovery(Eureka) 설정을 합니다.(아래 포스팅에서 유레카, 페인 관련 설정을 진행하겠습니다.) 호출 순서가 Gateway -&gt; order-service -&gt; cart-service 호출에 대한 로깅입니다.\n12345678910111213# spring-gateway2020-08-22 22:11:20.671 DEBUG [gateway-server,d1905ab24f0b5d1a,d1905ab24f0b5d1a,true] 12133 --- [ctor-http-nio-4] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: order-service2020-08-22 22:11:20.671 DEBUG [gateway-server,d1905ab24f0b5d1a,d1905ab24f0b5d1a,true] 12133 --- [ctor-http-nio-4] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:5555/order/orders/carts/2] to Route&#123;id=&#x27;order-service&#x27;, uri=lb://order-service, order=0, predicate=Paths: [/order/**], match trailing slash: true, gatewayFilters=[[[RewritePath /order/(?&lt;path&gt;.*) = &#x27;/$&#123;path&#125;&#x27;], order = 1], [[Retry retries = 3, series = list[SERVER_ERROR], statuses = list[502 BAD_GATEWAY], methods = list[GET, POST], exceptions = list[IOException, TimeoutException]], order = 2]], metadata=&#123;&#125;&#125;# order-service2020-08-22 22:11:20.685  INFO [order-service,d1905ab24f0b5d1a,ba6672843cb90f99,true] 11949 --- [nio-8181-exec-6] com.service.order.HttpLoggingFilter      :     ⊙ GET /orders/carts/2    ├─ Headers: accept: application/json, user-agent: Apache-HttpClient/4.5.12 (Java/11.0.7), accept-encoding: gzip,deflate, custom-request-header: userName, forwarded: proto=http;host=&quot;localhost:5555&quot;;for=&quot;127.0.0.1:57509&quot;, x-forwarded-for: 127.0.0.1, x-forwarded-proto: http, x-forwarded-prefix: /order, x-forwarded-port: 5555, x-forwarded-host: localhost:5555, host: 192.168.0.5:8181, x-b3-traceid: d1905ab24f0b5d1a, x-b3-spanid: ba6672843cb90f99, x-b3-parentspanid: d1905ab24f0b5d1a, x-b3-sampled: 1, content-length: 0# cart-service2020-08-22 22:11:20.683  INFO [cart-service,d1905ab24f0b5d1a,716b9cd4e4e52bdf,true] 11935 --- [nio-8282-exec-5] com.service.cart.HttpLoggingFilter       :     ⊙ GET /carts/2    ├─ Headers: x-b3-traceid: d1905ab24f0b5d1a, x-b3-spanid: 716b9cd4e4e52bdf, x-b3-parentspanid: ba6672843cb90f99, x-b3-sampled: 1, accept: */*, user-agent: Java/1.8.0_212, host: 192.168.0.5:8282, connection: keep-alive\n\n로그를 보면 gateway-server에서 traceId: d1905ab24f0b5d1a발급하고 order-service에게 전달할 때 header 정보에 x-b3-traceid: d1905ab24f0b5d1a를 추가하고, cart-service도 마찬가지로 traceId를 전달받고 자신의 고유한 ID x-b3-parentspanid: ba6672843cb90f99(order-service에서 전달받은) 발급합니다. 결국 d1905ab24f0b5d1a 값 하나로 연결된 하나의 요청을 추적할 수 있습니다.\nEureka &amp; Feign &amp; RibbonSpring Cloud Gateway는 유레카 연동도 손쉽게 가능합니다. 본 포스팅은 Spring Cloud Gateway에 대한 포스팅이므로 유레카에 대한 설정은 다루지 않겠습니다. 해당 내용은 실제 코드를 확인해 주세요.\n\norder-service, cart-service 서비스를 유레카에 등록 시켰습니다. 이제 라우터에 uri를 연결하기만 하면 손쉽게 연결이 가능합니다.\n1234567891011121314151617181920gateway:    discovery:        locator:            enabled: true    routes:        -   id: order-service            #                    uri: http://localhost:8181 # 기존 방시            uri: lb://order-service # 유레카를 통한 방식            predicates:                - Path=/order/**            filters:                - RewritePath=/order/(?&lt;path&gt;.*),/$\\&#123;path&#125;        -   id: cart-service            #                    uri: http://localhost:8181 # 기존 방시            uri: lb://cart-service # 유레카를 통한 방식            predicates:                - Path=/cart/**            filters:                - RewritePath=/cart/(?&lt;path&gt;.*),/$\\&#123;path&#125;\n설정은 간단합니다. uri: lb://&#123;service-name&#125;형식으로 유레카에 등록된 서비스 네임을 작성하게 되면 완료됩니다. 유레카에 등록했기 때문에 Feign, Ribbon 이용한 클라이언트 사이드 로드 밸런싱이 가능합니다.\n123456789101112131415161718192021@FeignClient(&quot;cart-service&quot;)@RibbonClient(&quot;cart-service&quot;)interface CartClient &#123;    @GetMapping(&quot;/carts/&#123;id&#125;&quot;)    fun getCart(@PathVariable id: Long): CartResponse    data class CartResponse(            val productId: Long    )&#125;@RestController@RequestMapping(&quot;/orders&quot;)class OrderApi(        private val cartClient: CartClient) &#123;    @GetMapping(&quot;/carts/&#123;id&#125;&quot;)    fun getCarts(@PathVariable id: Long) = cartClient.getCart(id)&#125;\n\n게이트웨이를 호출해서 order-service를 호출하고, 페인 클라이언트를 이용해서 cart-service를 호출하는 것을 확인할 수 있습니다.\n12345678910111213GET http://localhost:5555/order/orders/carts/2HTTP/1.1 200 OKContent-Type: application/jsonContent-Length: 15Date: Sat, 22 Aug 2020 13:37:48 GMTCUSTOM-RESPONSE-HEADER: It worked&#123;  &quot;productId&quot;: 2&#125;Response code: 200 (OK); Time: 109ms; Content length: 15 bytes\n\nFilter 설명\n클라이언트는 Spring Cloud Gateway를 통해 요청을 하고 게이트웨이는 매핑에서 요청이 경로와 일치한다고 판단하면 게이트웨이 웹 처리기로 요청을 전송하게 됩니다.\n\nSpring Cloud Gateway Document\n\n\n12345678910111213141516171819202122232425262728293031323334@Componentclass CustomFilter : AbstractGatewayFilterFactory&lt;CustomFilter.Config&gt;(Config::class.java) &#123;    val log by logger()    override fun apply(config: Config): GatewayFilter &#123;        return GatewayFilter &#123; exchange, chain -&gt;            val request = exchange.request            val response = exchange.response            log.info(&quot;CustomFilter request id: $&#123;request.id&#125;&quot;)            chain.filter(exchange).then(Mono.fromRunnable &#123; log.info(&quot;CustomFilter response status code: $&#123;response.statusCode&#125;&quot;) &#125;)        &#125;    &#125;    class Config&#125;@Componentclass GlobalFilter : AbstractGatewayFilterFactory&lt;GlobalFilter.Config&gt;(Config::class.java) &#123;    val log by logger()    override fun apply(config: Config): GatewayFilter &#123;        return GatewayFilter &#123; exchange, chain -&gt;            val request = exchange.request            val response = exchange.response            log.info(&quot;Global request id: $&#123;request.id&#125;&quot;)            chain.filter(exchange).then(Mono.fromRunnable &#123;                log.info(&quot;Global response status code: $&#123;response.statusCode&#125;&quot;)            &#125;)        &#125;    &#125;    class Config&#125;\n필터는 모두 AbstractGatewayFilterFactory를 상속받아 구현을 진행합니다. 실제 Gateay 로그는 아래와 같습니다.\n\n출처\nSpring Cloud Gateway  Reference\n\n","dateCreated":"2020-08-23T00:00:00+09:00","dateModified":"2025-01-31T04:41:33+09:00","datePublished":"2020-08-23T00:00:00+09:00","description":"Spring Cloud Gateway 정리","headline":"Spring Cloud Gateway","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/08/23/spring-cloud-gateway/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"http://localhost:4000/2020/08/23/spring-cloud-gateway/","keywords":"Spring, MSA, Gateway"}</script>
    <meta name="description" content="Spring Cloud Gateway 정리">
<meta property="og:type" content="blog">
<meta property="og:title" content="Spring Cloud Gateway">
<meta property="og:url" content="http://localhost:4000/2020/08/23/spring-cloud-gateway/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="Spring Cloud Gateway 정리">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/result-1.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/result-2.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/result-3.png">
<meta property="og:image" content="https://cloud.spring.io/spring-cloud-gateway/reference/html/images/spring_cloud_gateway_diagram.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/gateway-flow.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/gateway-log.png">
<meta property="article:published_time" content="2020-08-22T15:00:00.000Z">
<meta property="article:modified_time" content="2025-01-30T19:41:33.768Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="MSA">
<meta property="article:tag" content="Gateway">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/result-1.png">
    
    
        
    
    
        <meta property="og:image" content="http://localhost:4000/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="카테고리"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">카테고리</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="검색"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">검색</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Spring Cloud Gateway
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-08-23T00:00:00+09:00">
	
		    2020/08/23
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <blockquote>
<p>해당 코드는 <a target="_blank" rel="noopener" href="https://github.com/cheese10yun/blog-sample/tree/master/spring-gateway">Github</a> 공개되어 있습니다.</p>
</blockquote>
<h1 id="용어"><a href="#용어" class="headerlink" title="용어"></a>용어</h1><table>
<thead>
<tr>
<th>명칭</th>
<th>설명</th>
</tr>
</thead>
<tbody><tr>
<td>라우트(Route)</td>
<td>라우트는 목적지 URI, 조건자 목록과 필터의 목록을 식별하기 위한 고유 ID로 구성된다. 라우트는 모든 조건자가 충족됐을 때만 매칭된다</td>
</tr>
<tr>
<td>조건자(Predicates)</td>
<td>각 요청을 처리하기 전에 실행되는 로직, 헤더와 입력된 값 등 다양한 HTTP 요청이 정의된 기준에 맞는지를 찾는다.</td>
</tr>
<tr>
<td>필터(Filters)</td>
<td>HTTP 요청 또는 나가는 HTTP 응답을 수정할 수 있게한다. 다운스트림 요청을 보내기전이나 후에 수정할 수 있다. 라우트 필터는 특정 라우트에 한정된다.</td>
</tr>
</tbody></table>
<h1 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation(&quot;org.springframework.cloud:spring-cloud-starter-gateway&quot;)</span><br><span class="line">implementation(&quot;org.springframework.boot:spring-boot-starter-actuator&quot;)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GatewayServerApplication</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    runApplication&lt;GatewayServerApplication&gt;(*args)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>필요한 의존성만 추가하면 빠르게 Spring Cloud Gateway를 만들 수 있습니다.</p>
<h2 id="Gateway-Route-노출"><a href="#Gateway-Route-노출" class="headerlink" title="Gateway Route 노출"></a>Gateway Route 노출</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">    <span class="attr">endpoints:</span></span><br><span class="line">        <span class="attr">web:</span></span><br><span class="line">            <span class="attr">exposure:</span></span><br><span class="line">                <span class="attr">include:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">&quot;gateway&quot;</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">        <span class="attr">gateway:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>위에서 추가한 <code>actuator</code>의존성으로 <code>gateway</code>를 노출하면 아래처럼 url mapping 정보를 확인할 수 있습니다.</p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/result-1.png"></p>
<p>현재 아무것도 설정하지 않은 상태이기 때문에 <code>/actuator/gateway/routes</code>를 호출하면 아래와 같은 결과를 확인할 수 있습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET http://127.0.0.1:5555/actuator/gateway/routes</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">[]</span><br><span class="line"></span><br><span class="line">Response code: 200 (OK); Time: 321ms; Content length: 2 bytes</span><br></pre></td></tr></table></figure>

<h2 id="Route-설정"><a href="#Route-설정" class="headerlink" title="Route 설정"></a>Route 설정</h2><p>API를 서버를 만들고 게이트웨이와 연결해 보겠습니다.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">        <span class="attr">routes:</span></span><br><span class="line">            <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">                <span class="attr">uri:</span> <span class="string">http://localhost:8181</span></span><br><span class="line">                <span class="attr">predicates:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">                <span class="attr">filters:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">RewritePath=/order/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">cart-service</span></span><br><span class="line">                <span class="attr">uri:</span> <span class="string">http://localhost:8181</span></span><br><span class="line">                <span class="attr">predicates:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">Path=/cart/**</span></span><br><span class="line">                <span class="attr">filters:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">RewritePath=/cart/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>id: 해당 라우트의 고유 식별자를 나타냅니다.</li>
<li>uri: 해당 라우터의 주소를 나타냅니다.</li>
<li>predicates: 해당 라우터의 조건을 작성, <code>/order/**</code>으로 시작하는 요청의 경우 해당 라우터로 요청을 보냄</li>
<li>filters: 해당 라우터의 필터로, RewritePath는 강제로 Path를 다시 작성합니다.</li>
</ul>
<h2 id="연결할-API-Server"><a href="#연결할-API-Server" class="headerlink" title="연결할 API Server"></a>연결할 API Server</h2><p><code>cart-service</code>, <code>order-service</code> 2 개의 API 서버를 구성합니다. 각 포트의 설정은 <code>cloud.gateway.routes</code>에 등록된 포트를 설정합니다.</p>
<h2 id="order-service"><a href="#order-service" class="headerlink" title="order-service"></a>order-service</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/orders&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderApi</span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> orderRepository: OrderRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getOrders</span><span class="params">(pageable: <span class="type">Pageable</span>)</span></span> = orderRepository.findAll(pageable)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = <span class="string">&quot;orders&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>(</span><br><span class="line">        <span class="meta">@Column(name = <span class="string">&quot;product_id&quot;</span>, nullable = false)</span></span><br><span class="line">        <span class="keyword">val</span> productId: <span class="built_in">Long</span></span><br><span class="line">) : EntityAuditing() &#123;</span><br><span class="line">    <span class="meta">@Column(name = <span class="string">&quot;order_number&quot;</span>, nullable = false)</span></span><br><span class="line">    <span class="keyword">val</span> orderNumber: String = UUID.randomUUID().toString()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="cart-service"><a href="#cart-service" class="headerlink" title="cart-service"></a>cart-service</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/carts&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CartApi</span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> cartRepository: CartRepository</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getCarts</span><span class="params">(pageable: <span class="type">Pageable</span>)</span></span> = cartRepository.findAll(pageable)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = <span class="string">&quot;cart&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cart</span>(</span><br><span class="line">        <span class="meta">@Column(name = <span class="string">&quot;product_id&quot;</span>, nullable = false)</span></span><br><span class="line">        <span class="keyword">var</span> productId: <span class="built_in">Long</span></span><br><span class="line">) : EntityAuditing()</span><br></pre></td></tr></table></figure>

<h2 id="Router-확인"><a href="#Router-확인" class="headerlink" title="Router 확인"></a>Router 확인</h2><p><code>actuator/gateway/routes</code> 확인을 해보면 위에서 설정한 라우터를 확인할 수 있습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET http://127.0.0.1:5555/actuator/gateway/routes</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;predicate&quot;: &quot;Paths: [/order/**], match trailing slash: true&quot;,</span><br><span class="line">    &quot;route_id&quot;: &quot;order-service&quot;,</span><br><span class="line">    &quot;filters&quot;: [</span><br><span class="line">      &quot;[[RewritePath /order/(?&lt;path&gt;.*) = &#x27;/$&#123;path&#125;&#x27;], order = 1]&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;uri&quot;: &quot;http://localhost:8181&quot;,</span><br><span class="line">    &quot;order&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;predicate&quot;: &quot;Paths: [/cart/**], match trailing slash: true&quot;,</span><br><span class="line">    &quot;route_id&quot;: &quot;cart-service&quot;,</span><br><span class="line">    &quot;filters&quot;: [</span><br><span class="line">      &quot;[[RewritePath /cart/(?&lt;path&gt;.*) = &#x27;/$&#123;path&#125;&#x27;], order = 1]&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;uri&quot;: &quot;http://localhost:8181&quot;,</span><br><span class="line">    &quot;order&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Response code: 200 (OK); Time: 207ms; Content length: 404 bytes</span><br></pre></td></tr></table></figure>
<h2 id="연결된-서비스-확인"><a href="#연결된-서비스-확인" class="headerlink" title="연결된 서비스 확인"></a>연결된 서비스 확인</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:5555/order/orders?page=0&amp;size=5</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 1075</span><br><span class="line">Date: Sat, 22 Aug 2020 09:29:57 GMT</span><br><span class="line">CUSTOM-RESPONSE-HEADER: It worked</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;productId&quot;: 1,</span><br><span class="line">      &quot;id&quot;: 1,</span><br><span class="line">      &quot;createdAt&quot;: &quot;2020-08-22T17:19:08.038&quot;,</span><br><span class="line">      &quot;updatedAt&quot;: &quot;2020-08-22T17:19:08.038&quot;,</span><br><span class="line">      &quot;orderNumber&quot;: &quot;7d684c44-1ea3-4dc4-9247-12c351606df3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">  &quot;pageable&quot;: &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;last&quot;: false,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 200 (OK); Time: 168ms; Content length: 1075 bytes</span><br></pre></td></tr></table></figure>

<p>게이트웨이 <code>/order/orders?page=0&amp;size=5</code>를 호출하면 <code>filters.RewritePath</code>에 의해서 <code>orders?page=0&amp;size=5</code>를 호출하게 됩니다. 즉 라우터에 등록된 <code>order-service</code>를 호출하게 됩니다.</p>
<h1 id="Predicates"><a href="#Predicates" class="headerlink" title="Predicates"></a>Predicates</h1><p>Predicates는 조건으로서 해당 라우터에 라우팅 될 조건을 표시합니다. 위 예제에서는 <code>Path=/order/**</code>, <code>Path=/cart/**</code>으로 해당 path로 들어오는 경우 해당 라우터로 라우팅 됩니다. 그 밖에도 여러 가지를 지원합니다. 대표적인 몇 개를 정리해보았습니다. 날짜 관련 매개변수는 <code>ZonedDateTime</code>를 사용해야 합니다.</p>
<h2 id="After"><a href="#After" class="headerlink" title="After"></a>After</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:8181</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">After=2020-08-23T19:25:19.126+09:00[Asia/Seoul]</span></span><br></pre></td></tr></table></figure>

<p><code>After</code>는 특정 날짜 이후에 호출이 가능합니다. 현재 날짜가 <code>After</code>에서 지정한 날짜 보다 이후 이어야 합니다. 서비스에 대한 이벤트 API 등 특정 시점에 Open 시킬 API가 있다면 유용합니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:5555/order/orders?page=0&amp;size=5</span><br><span class="line"></span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 141</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;timestamp&quot;: &quot;2020-08-22T10:37:11.955+00:00&quot;,</span><br><span class="line">  &quot;path&quot;: &quot;/order/orders&quot;,</span><br><span class="line">  &quot;status&quot;: 404,</span><br><span class="line">  &quot;error&quot;: &quot;Not Found&quot;,</span><br><span class="line">  &quot;message&quot;: null,</span><br><span class="line">  &quot;requestId&quot;: &quot;9b635742-2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 404 (Not Found); Time: 28ms; Content length: 141 bytes</span><br></pre></td></tr></table></figure>
<p>현재 시각 <code>2020-08-22T19:25:19.126+09:00[Asia/Seoul]</code> 이라면 <code>HTTP/1.1 404 Not Found</code>을 응답 받게됩니다.</p>
<h2 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:8181</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Before=2020-08-20T19:25:19.126+09:00[Asia/Seoul]</span></span><br></pre></td></tr></table></figure>
<p><code>Before</code>는 특정 날짜 이전 호출이 가능합니다. 현재 날짜가 <code>Before</code>에서 지정한 날짜 보다 이전 이어야 합니다. 특정 API가 deprecate가 되는 경우 유용합니다.</p>
<h2 id="Between"><a href="#Between" class="headerlink" title="Between"></a>Between</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:8181</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Between=2020-08-17T19:25:19.126+09:00[Asia/Seoul],</span> <span class="number">2020-08-20T19:25:19.126+09:00</span>[<span class="string">Asia/Seoul</span>]</span><br></pre></td></tr></table></figure>
<p><code>Between</code>는 특정 날짜 사이에만 호출이 가능합니다. 특정 기간에만 사용하는 이벤트 API 등에 사용하면 유용합니다.</p>
<h2 id="Weight"><a href="#Weight" class="headerlink" title="Weight"></a>Weight</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service-high</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:8181</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group-order,</span> <span class="number">7</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RewritePath=/order/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service-low</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:8787</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group-order,</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RewritePath=/order/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>group</code>, <code>weight</code>를 기반으로 그룹별로 가중치를 계산하게 됩니다. 위 설정은 70% <code>order-service-high</code>, 30% <code>order-service-low</code>으로 라우팅을 분배합니다.</p>
<h1 id="Filters"><a href="#Filters" class="headerlink" title="Filters"></a>Filters</h1><p>HTTP Request, Reponse에 대한 수정을 할 수 있습니다. 특정 라우터에에서 안에서 동작하게 됩니다.</p>
<h2 id="RewritePath"><a href="#RewritePath" class="headerlink" title="RewritePath"></a>RewritePath</h2><p>RewritePath는 HTTP Request를 수정하여 특정 Server에 전달하게 됩니다. 정규표현식을 사용해서 유연하게 HTTP Request Path를 변경합니다.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:8181</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RewritePath=/order/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>RewritePath</code>를 통해서 <code>/order/orders</code> -&gt; <code>/order/orders</code>으로 재작성합니다. 즉, <code>/order/orders?page=0&amp;size=5</code> 요청이 오면 <code>/order/</code>를제거하고 <code>orders?page=0&amp;size=5</code>를 기반으로 <code>order-service</code>를 호출하게 됩니다.</p>
<h2 id="Retry"><a href="#Retry" class="headerlink" title="Retry"></a>Retry</h2><table>
<thead>
<tr>
<th>name</th>
<th>설명</th>
<th>기본값</th>
</tr>
</thead>
<tbody><tr>
<td>retries</td>
<td>재시도 횟수</td>
<td>3번</td>
</tr>
<tr>
<td>statuses</td>
<td>재시도해야하는 HTTP 상태 코드(<code>org.springframework.http.HttpStatus</code>)</td>
<td>-</td>
</tr>
<tr>
<td>series</td>
<td>재시도해야하는 HTTP 상태 코드시리즈(<code>org.springframework.http.HttpStatus.Series</code>)</td>
<td>5XX</td>
</tr>
<tr>
<td>methods</td>
<td>재시도해야하는 HTTP 메소드(<code>org.springframework.http.HttpMethod</code>)</td>
<td>GET</td>
</tr>
<tr>
<td>exceptions</td>
<td>재시도해야하는 Exception</td>
<td><code>IOException</code>, <code>TimeoutException</code></td>
</tr>
<tr>
<td>backoff</td>
<td>재시도하는 시간텀 지정 <code>firstBackoff * (factor ^ n)</code> n번 반복</td>
<td>비활성화</td>
</tr>
</tbody></table>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">gateway:</span></span><br><span class="line">            <span class="attr">discovery:</span></span><br><span class="line">                <span class="attr">locator:</span></span><br><span class="line">                    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">routes:</span></span><br><span class="line">                <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">                    <span class="attr">uri:</span> <span class="string">lb://order-service</span></span><br><span class="line">                    <span class="attr">predicates:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">                    <span class="attr">filters:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">RewritePath=/order/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br><span class="line">                        <span class="bullet">-</span>   <span class="attr">name:</span> <span class="string">Retry</span></span><br><span class="line">                            <span class="attr">args:</span></span><br><span class="line">                                <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">                                <span class="attr">statuses:</span> <span class="string">INTERNAL_SERVER_ERROR</span></span><br><span class="line">                                <span class="attr">methods:</span> <span class="string">GET</span></span><br><span class="line">                                <span class="attr">backoff:</span></span><br><span class="line">                                    <span class="attr">firstBackoff:</span> <span class="string">1000ms</span></span><br><span class="line">                                    <span class="attr">maxBackoff:</span> <span class="string">6000ms</span></span><br><span class="line">                                    <span class="attr">factor:</span> <span class="number">2</span></span><br><span class="line">                                    <span class="attr">basedOnPreviousValue:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>제시도 횟수는 <code>retries: 3</code>, 재시도 HTTP Status는 <code>statuses: INTERNAL_SERVER_ERROR (500)</code>, 재시도 HTTP method는 <code>GET</code> <code>backoff</code> 설정은 <code>1000ms(firstBackoff) * (2(factor) ^ n(retries))</code>으로 <code>retries</code> 만큼 반복됩니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/orders&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderApi</span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> orderRepository: OrderRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getOrders</span><span class="params">(pageable: <span class="type">Pageable</span>)</span></span>: Page&lt;Order&gt; &#123;</span><br><span class="line">        println(<span class="string">&quot;getOrders 호출&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;Error&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> orderRepository.findAll(pageable)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/carts/&#123;id&#125;&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getCarts</span><span class="params">(<span class="meta">@PathVariable</span> id: <span class="type">Long</span>)</span></span> = cartClient.getCart(id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>해당 API는 <code>RuntimeException(&quot;Error&quot;)</code>를 발생시키고 있어 Status 500을 응답합니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:5555/order/orders?page=0&amp;size=5</span><br><span class="line"></span><br><span class="line">HTTP/1.1 500 Internal Server Error</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Date: Sat, 22 Aug 2020 14:57:15 GMT</span><br><span class="line">CUSTOM-RESPONSE-HEADER: It did not work</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;timestamp&quot;: &quot;2020-08-22T14:57:15.122+00:00&quot;,</span><br><span class="line">  &quot;status&quot;: 500,</span><br><span class="line">  &quot;error&quot;: &quot;Internal Server Error&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;&quot;,</span><br><span class="line">  &quot;path&quot;: &quot;/orders&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 500 (Internal Server Error); Time: 7062ms; Content length: 120 bytes</span><br></pre></td></tr></table></figure>
<p>결과를 확인하면 3번의 Retry가 있었고, 결국 500을 리턴하게 됩니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getOrders 호출</span><br><span class="line">2020-08-22 23:57:08.080 ERROR [order-service,,,] 17139 --- [nio-8181-exec-7] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.RuntimeException: Error] with root cause</span><br><span class="line"></span><br><span class="line">getOrders 호출</span><br><span class="line">2020-08-22 23:57:09.091 ERROR [order-service,,,] 17139 --- [nio-8181-exec-8] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.RuntimeException: Error] with root cause</span><br><span class="line"></span><br><span class="line">getOrders 호출</span><br><span class="line">2020-08-22 23:57:11.107 ERROR [order-service,,,] 17139 --- [nio-8181-exec-9] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.RuntimeException: Error] with root cause</span><br></pre></td></tr></table></figure>
<p><code>order-service</code> 로그를 확인해보면 3번의 호출이 있었는지를 확인할 수 있습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/orders&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderApi</span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> orderRepository: OrderRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> errorCount = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getOrders</span><span class="params">(pageable: <span class="type">Pageable</span>)</span></span>: Page&lt;Order&gt; &#123;</span><br><span class="line">        println(<span class="string">&quot;getOrders 호출&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (errorCount &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            println(<span class="string">&quot;예외발생 <span class="variable">$errorCount</span> 1증가&quot;</span>)</span><br><span class="line">            errorCount++</span><br><span class="line">            <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;Error&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        errorCount = <span class="number">0</span> <span class="comment">// 초기화</span></span><br><span class="line">        <span class="keyword">return</span> orderRepository.findAll(pageable)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>해당 코드는 2번 예외가 발생하지만 3번째에서 응답을 리턴해주는 코드입니다. 재시도를 3번 실행하기 때문에 3번째에는 정상적인 응답을 받을 수 있습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:5555/order/orders?page=0&amp;size=5</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Date: Sat, 22 Aug 2020 15:13:16 GMT</span><br><span class="line">CUSTOM-RESPONSE-HEADER: It worked</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;productId&quot;: 1,</span><br><span class="line">      &quot;id&quot;: 1,</span><br><span class="line">      &quot;createdAt&quot;: &quot;2020-08-23T00:11:24.747&quot;,</span><br><span class="line">      &quot;updatedAt&quot;: &quot;2020-08-23T00:11:24.747&quot;,</span><br><span class="line">      &quot;orderNumber&quot;: &quot;519011ff-7eaf-4e85-b48f-a9aa6ab879ac&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">  &quot;pageable&quot;: &#123;</span><br><span class="line">   ...</span><br><span class="line">  &quot;totalPages&quot;: 2,</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 200 (OK); Time: 3034ms; Content length: 1075 bytes</span><br></pre></td></tr></table></figure>
<p>3번의 응답시간을 기다려야 하기 때문에 <code>3034ms</code> 정도 걸리는 걸 확인할 수 있습니다. 재시도는 단순 조회만 하는 GET 요청에 외에는 신중하게 선택해야 합니다. 게이트웨이에서 재시도를 진행하기 때문에 각 서비스 간의 통신에서 생성, 삭제, 수정 등 조회 조건 외에 동작이 있다면 문제가 생길 가능성이 높습니다. 또 <code>HTTP Status 5XX</code> 응답은 재시도를 하는 것은 바람직하지만, <code>HTTP Status 4XXX</code>에서는 동일한 요청이면 동일한 이유로 실패하기 때문에 재시도를 안 하는 게 더 효율적입니다. 단순 조회 용이 아니면 신중하게 사용해야 합니다.</p>
<h1 id="HTTP-Timeout-설정"><a href="#HTTP-Timeout-설정" class="headerlink" title="HTTP Timeout 설정"></a>HTTP Timeout 설정</h1><h2 id="글로벌-설정"><a href="#글로벌-설정" class="headerlink" title="글로벌 설정"></a>글로벌 설정</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">gateway:</span></span><br><span class="line">            <span class="attr">httpclient:</span></span><br><span class="line">                <span class="attr">connect-timeout:</span> <span class="number">10000</span></span><br><span class="line">                <span class="attr">response-timeout:</span> <span class="string">10s</span></span><br></pre></td></tr></table></figure>

<p><code>connect-timeout</code> 밀리 초 단위로 지정, <code>response-timeout</code> Duration으로 지정 해야 합니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/orders&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderApi</span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> orderRepository: OrderRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getOrders</span><span class="params">(pageable: <span class="type">Pageable</span>)</span></span>: Page&lt;Order&gt; &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1100</span>) <span class="comment">// timeout 발생</span></span><br><span class="line">        <span class="keyword">return</span> orderRepository.findAll(pageable)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>클라이언트 응답시간이 1초로 설정했기 때문에 1초를 넘어가면 아래와 같이 <code>HTTP/1.1 504 Gateway Timeout</code>응답을 확인할 수 있습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:5555/order/orders?page=0&amp;size=5</span><br><span class="line"></span><br><span class="line">HTTP/1.1 504 Gateway Timeout</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 145</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;timestamp&quot;: &quot;2020-08-22T14:05:09.267+00:00&quot;,</span><br><span class="line">  &quot;path&quot;: &quot;/order/orders&quot;,</span><br><span class="line">  &quot;status&quot;: 504,</span><br><span class="line">  &quot;error&quot;: &quot;Gateway Timeout&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;&quot;,</span><br><span class="line">  &quot;requestId&quot;: &quot;0d492aaf-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 504 (Gateway Timeout); Time: 4798ms; Content length: 145 bytes</span><br></pre></td></tr></table></figure>

<h2 id="라우터별-설정"><a href="#라우터별-설정" class="headerlink" title="라우터별 설정"></a>라우터별 설정</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">gateway:</span></span><br><span class="line">            <span class="attr">routes:</span></span><br><span class="line">                <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">                    <span class="attr">uri:</span> <span class="string">lb://order-service</span></span><br><span class="line">                    <span class="attr">predicates:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">                    <span class="attr">filters:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">RewritePath=/order/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br><span class="line">                    <span class="attr">metadata:</span></span><br><span class="line">                        <span class="attr">connect-timeout:</span> <span class="number">1000</span></span><br><span class="line">                        <span class="attr">response-timeout:</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<p><code>metadata</code>설정을 통해서 라우터별 설정을 진행할 수 있습니다. 여기서 중요한 점은 <code>metadata</code> 설정 시 <code>connect-timeout</code>, <code>response-timeout</code> 모두 밀리 초 단위로 지정해야 합니다. Global 설정과는 차이가 있습니다.</p>
<h1 id="Logging-Sleuth"><a href="#Logging-Sleuth" class="headerlink" title="Logging Sleuth"></a>Logging Sleuth</h1><h2 id="Gateway-Logging"><a href="#Gateway-Logging" class="headerlink" title="Gateway Logging"></a>Gateway Logging</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GatewayServerApplication</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    System.setProperty(<span class="string">&quot;reactor.netty.http.server.accessLogEnabled&quot;</span>, <span class="string">&quot;true&quot;</span>)</span><br><span class="line">    runApplication&lt;GatewayServerApplication&gt;(*args)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Reactor Netty 액세스 로그를 활성화하려면 <code>System.setProperty(&quot;reactor.netty.http.server.accessLogEnabled&quot;, &quot;true&quot;)</code>을 설정해야 합니다. 공식 문서에 따르면 Spring Boot 설정이 아니기 때문에 yml으로 설정하지 않고 위처럼 설정해야 한다고 합니다.</p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/result-2.png"></p>
<p>정상적으로 로킹이 되는 것을 확인할 수 있습니다.</p>
<h2 id="Sleuth"><a href="#Sleuth" class="headerlink" title="Sleuth"></a>Sleuth</h2><p>스프링 클라우드 슬루스(Sleuth)는 마이크로 서비스 환경에서 서로 다른 시스템의 요청을 연결하여 로깅을 해줄 수 있게 해주는 도구입니다. 이런 경우 슬루스를 이용해서 쉽게 요청에 대한 로깅을 연결해서 볼 수 있습니다. 또 RestTemplate, 페인 클라이언트, 메시지 채널 등등 다양한 플랫폼과 연결하기 쉽습니다. 아래 예제에서는 폐인 클라이언트와 연결해서 로깅하는 방법을 설명하겠습니다.</p>
<h2 id="의존성-추가"><a href="#의존성-추가" class="headerlink" title="의존성 추가"></a>의존성 추가</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(&quot;org.springframework.cloud:spring-cloud-starter-sleuth&quot;)</span><br></pre></td></tr></table></figure>
<p><code>gateway-server</code>, <code>order-service</code>. <code>cart-service</code> 모듈에 해당 의존성을 추가합니다.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">        <span class="attr">discovery:</span></span><br><span class="line">            <span class="attr">locator:</span></span><br><span class="line">                <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">routes:</span></span><br><span class="line">            <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">                <span class="attr">uri:</span> <span class="string">lb://order-service</span></span><br><span class="line">                <span class="attr">predicates:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">                <span class="attr">filters:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">RewritePath=/order/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">cart-service</span></span><br><span class="line">                <span class="attr">uri:</span> <span class="string">lb://cart-service</span></span><br><span class="line">                <span class="attr">predicates:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">Path=/cart/**</span></span><br><span class="line">                <span class="attr">filters:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">RewritePath=/cart/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>openfeign</code>을 이용해서 클라이언트를 호출할 것이므로 <code>discovery(Eureka)</code> 설정을 합니다.(아래 포스팅에서 유레카, 페인 관련 설정을 진행하겠습니다.) 호출 순서가 <code>Gateway</code> -&gt; <code>order-service</code> -&gt; <code>cart-service</code> 호출에 대한 로깅입니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># spring-gateway</span><br><span class="line">2020-08-22 22:11:20.671 DEBUG [gateway-server,d1905ab24f0b5d1a,d1905ab24f0b5d1a,true] 12133 --- [ctor-http-nio-4] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: order-service</span><br><span class="line">2020-08-22 22:11:20.671 DEBUG [gateway-server,d1905ab24f0b5d1a,d1905ab24f0b5d1a,true] 12133 --- [ctor-http-nio-4] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:5555/order/orders/carts/2] to Route&#123;id=&#x27;order-service&#x27;, uri=lb://order-service, order=0, predicate=Paths: [/order/**], match trailing slash: true, gatewayFilters=[[[RewritePath /order/(?&lt;path&gt;.*) = &#x27;/$&#123;path&#125;&#x27;], order = 1], [[Retry retries = 3, series = list[SERVER_ERROR], statuses = list[502 BAD_GATEWAY], methods = list[GET, POST], exceptions = list[IOException, TimeoutException]], order = 2]], metadata=&#123;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># order-service</span><br><span class="line">2020-08-22 22:11:20.685  INFO [order-service,d1905ab24f0b5d1a,ba6672843cb90f99,true] 11949 --- [nio-8181-exec-6] com.service.order.HttpLoggingFilter      : </span><br><span class="line">    ⊙ GET /orders/carts/2</span><br><span class="line">    ├─ Headers: accept: application/json, user-agent: Apache-HttpClient/4.5.12 (Java/11.0.7), accept-encoding: gzip,deflate, custom-request-header: userName, forwarded: proto=http;host=&quot;localhost:5555&quot;;for=&quot;127.0.0.1:57509&quot;, x-forwarded-for: 127.0.0.1, x-forwarded-proto: http, x-forwarded-prefix: /order, x-forwarded-port: 5555, x-forwarded-host: localhost:5555, host: 192.168.0.5:8181, x-b3-traceid: d1905ab24f0b5d1a, x-b3-spanid: ba6672843cb90f99, x-b3-parentspanid: d1905ab24f0b5d1a, x-b3-sampled: 1, content-length: 0</span><br><span class="line"></span><br><span class="line"># cart-service</span><br><span class="line">2020-08-22 22:11:20.683  INFO [cart-service,d1905ab24f0b5d1a,716b9cd4e4e52bdf,true] 11935 --- [nio-8282-exec-5] com.service.cart.HttpLoggingFilter       : </span><br><span class="line">    ⊙ GET /carts/2</span><br><span class="line">    ├─ Headers: x-b3-traceid: d1905ab24f0b5d1a, x-b3-spanid: 716b9cd4e4e52bdf, x-b3-parentspanid: ba6672843cb90f99, x-b3-sampled: 1, accept: */*, user-agent: Java/1.8.0_212, host: 192.168.0.5:8282, connection: keep-alive</span><br></pre></td></tr></table></figure>

<p>로그를 보면 <code>gateway-server</code>에서 <code>traceId: d1905ab24f0b5d1a</code>발급하고 <code>order-service</code>에게 전달할 때 header 정보에 <code>x-b3-traceid: d1905ab24f0b5d1a</code>를 추가하고, <code>cart-service</code>도 마찬가지로 <code>traceId</code>를 전달받고 자신의 고유한 ID <code>x-b3-parentspanid: ba6672843cb90f99(order-service에서 전달받은)</code> 발급합니다. 결국 <code>d1905ab24f0b5d1a</code> 값 하나로 연결된 하나의 요청을 추적할 수 있습니다.</p>
<h1 id="Eureka-Feign-Ribbon"><a href="#Eureka-Feign-Ribbon" class="headerlink" title="Eureka &amp; Feign &amp; Ribbon"></a>Eureka &amp; Feign &amp; Ribbon</h1><p>Spring Cloud Gateway는 유레카 연동도 손쉽게 가능합니다. 본 포스팅은 Spring Cloud Gateway에 대한 포스팅이므로 유레카에 대한 설정은 다루지 않겠습니다. 해당 내용은 실제 코드를 확인해 주세요.</p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/result-3.png"></p>
<p><code>order-service</code>, <code>cart-service</code> 서비스를 유레카에 등록 시켰습니다. 이제 라우터에 uri를 연결하기만 하면 손쉽게 연결이 가능합니다.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">gateway:</span></span><br><span class="line">    <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">            <span class="comment">#                    uri: http://localhost:8181 # 기존 방시</span></span><br><span class="line">            <span class="attr">uri:</span> <span class="string">lb://order-service</span> <span class="comment"># 유레카를 통한 방식</span></span><br><span class="line">            <span class="attr">predicates:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">            <span class="attr">filters:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">RewritePath=/order/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span>   <span class="attr">id:</span> <span class="string">cart-service</span></span><br><span class="line">            <span class="comment">#                    uri: http://localhost:8181 # 기존 방시</span></span><br><span class="line">            <span class="attr">uri:</span> <span class="string">lb://cart-service</span> <span class="comment"># 유레카를 통한 방식</span></span><br><span class="line">            <span class="attr">predicates:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">Path=/cart/**</span></span><br><span class="line">            <span class="attr">filters:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">RewritePath=/cart/(?&lt;path&gt;.*),/$\&#123;path&#125;</span></span><br></pre></td></tr></table></figure>
<p>설정은 간단합니다. <code>uri: lb://&#123;service-name&#125;</code>형식으로 유레카에 등록된 서비스 네임을 작성하게 되면 완료됩니다. 유레카에 등록했기 때문에 Feign, Ribbon 이용한 클라이언트 사이드 로드 밸런싱이 가능합니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(<span class="string">&quot;cart-service&quot;</span>)</span></span><br><span class="line"><span class="meta">@RibbonClient(<span class="string">&quot;cart-service&quot;</span>)</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">CartClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/carts/&#123;id&#125;&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getCart</span><span class="params">(<span class="meta">@PathVariable</span> id: <span class="type">Long</span>)</span></span>: CartResponse</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">CartResponse</span>(</span><br><span class="line">            <span class="keyword">val</span> productId: <span class="built_in">Long</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/orders&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderApi</span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> cartClient: CartClient</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/carts/&#123;id&#125;&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getCarts</span><span class="params">(<span class="meta">@PathVariable</span> id: <span class="type">Long</span>)</span></span> = cartClient.getCart(id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>게이트웨이를 호출해서 <code>order-service</code>를 호출하고, 페인 클라이언트를 이용해서 <code>cart-service</code>를 호출하는 것을 확인할 수 있습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:5555/order/orders/carts/2</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 15</span><br><span class="line">Date: Sat, 22 Aug 2020 13:37:48 GMT</span><br><span class="line">CUSTOM-RESPONSE-HEADER: It worked</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;productId&quot;: 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 200 (OK); Time: 109ms; Content length: 15 bytes</span><br></pre></td></tr></table></figure>

<h2 id="Filter-설명"><a href="#Filter-설명" class="headerlink" title="Filter 설명"></a>Filter 설명</h2><p><img src="https://cloud.spring.io/spring-cloud-gateway/reference/html/images/spring_cloud_gateway_diagram.png"></p>
<p>클라이언트는 Spring Cloud Gateway를 통해 요청을 하고 게이트웨이는 매핑에서 요청이 경로와 일치한다고 판단하면 게이트웨이 웹 처리기로 요청을 전송하게 됩니다.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-gateway/reference/html/">Spring Cloud Gateway Document</a></p>
</blockquote>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/gateway-flow.png"></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomFilter</span> : <span class="type">AbstractGatewayFilterFactory</span>&lt;<span class="type">CustomFilter.Config</span>&gt;(Config::<span class="keyword">class</span>.java) &#123;</span><br><span class="line">    <span class="keyword">val</span> log <span class="keyword">by</span> logger()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(config: <span class="type">Config</span>)</span></span>: GatewayFilter &#123;</span><br><span class="line">        <span class="keyword">return</span> GatewayFilter &#123; exchange, chain -&gt;</span><br><span class="line">            <span class="keyword">val</span> request = exchange.request</span><br><span class="line">            <span class="keyword">val</span> response = exchange.response</span><br><span class="line">            log.info(<span class="string">&quot;CustomFilter request id: <span class="subst">$&#123;request.id&#125;</span>&quot;</span>)</span><br><span class="line">            chain.filter(exchange).then(Mono.fromRunnable &#123; log.info(<span class="string">&quot;CustomFilter response status code: <span class="subst">$&#123;response.statusCode&#125;</span>&quot;</span>) &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Config</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GlobalFilter</span> : <span class="type">AbstractGatewayFilterFactory</span>&lt;<span class="type">GlobalFilter.Config</span>&gt;(Config::<span class="keyword">class</span>.java) &#123;</span><br><span class="line">    <span class="keyword">val</span> log <span class="keyword">by</span> logger()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(config: <span class="type">Config</span>)</span></span>: GatewayFilter &#123;</span><br><span class="line">        <span class="keyword">return</span> GatewayFilter &#123; exchange, chain -&gt;</span><br><span class="line">            <span class="keyword">val</span> request = exchange.request</span><br><span class="line">            <span class="keyword">val</span> response = exchange.response</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;Global request id: <span class="subst">$&#123;request.id&#125;</span>&quot;</span>)</span><br><span class="line">            chain.filter(exchange).then(Mono.fromRunnable &#123;</span><br><span class="line">                log.info(<span class="string">&quot;Global response status code: <span class="subst">$&#123;response.statusCode&#125;</span>&quot;</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Config</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>필터는 모두 AbstractGatewayFilterFactory를 상속받아 구현을 진행합니다. 실제 Gateay 로그는 아래와 같습니다.</p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/spring-msa/docs/images/gateway-log.png"></p>
<h1 id="출처"><a href="#출처" class="headerlink" title="출처"></a>출처</h1><ul>
<li><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-gateway/reference/html/">Spring Cloud Gateway  Reference</a></li>
</ul>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Gateway/" rel="tag">Gateway</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/MSA/" rel="tag">MSA</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Spring/" rel="tag">Spring</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/09/29/mock-server-netty/"
                    data-tooltip="Mockserver Netty 사용해서 HTTP 통신 Mocking 하기"
                    aria-label="이전: Mockserver Netty 사용해서 HTTP 통신 Mocking 하기"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/08/16/event-transaction/"
                    data-tooltip="ApplicationEventPublisher 기반으로 강결합 및 트랜잭션 문제 해결"
                    aria-label="다음: ApplicationEventPublisher 기반으로 강결합 및 트랜잭션 문제 해결"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2020/08/23/spring-cloud-gateway/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://localhost:4000/2020/08/23/spring-cloud-gateway/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://localhost:4000/2020/08/23/spring-cloud-gateway/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>


<!-- Comment -->
<!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/09/29/mock-server-netty/"
                    data-tooltip="Mockserver Netty 사용해서 HTTP 통신 Mocking 하기"
                    aria-label="이전: Mockserver Netty 사용해서 HTTP 통신 Mocking 하기"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/08/16/event-transaction/"
                    data-tooltip="ApplicationEventPublisher 기반으로 강결합 및 트랜잭션 문제 해결"
                    aria-label="다음: ApplicationEventPublisher 기반으로 강결합 및 트랜잭션 문제 해결"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2020/08/23/spring-cloud-gateway/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://localhost:4000/2020/08/23/spring-cloud-gateway/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://localhost:4000/2020/08/23/spring-cloud-gateway/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2020/08/23/spring-cloud-gateway/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=http://localhost:4000/2020/08/23/spring-cloud-gateway/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=http://localhost:4000/2020/08/23/spring-cloud-gateway/"
                        aria-label="Google+에 공유하기"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Google+에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>


<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="naver-site-verification" content="a37ea649edf26e70c3de94f9cb034f9d6e11de3f" />
    <meta name="generator" content="Yun Blog">
    <title>ApplicationEventPublisher 기반으로 강결합 및 트랜잭션 문제 해결 - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"\n해당 코드는 Github 공개되어 있습니다.\n\n회원 가입 시나리오\n회원 가입 시 회원 가입 쿠폰 발행, 회원 가입 이메일 발등을 해야 한다면 다음 코드처럼 로직을 만들 수 있습니다. 이메일 전송 실패, 쿠폰 발급이 실패하는 경우 회원 가입을 다시 해야 한다는 가정으로 설명드리겠습니다.(다소 과격한 시나리오지만 원자성에 대한 설명을 위해서 이런 시나리오를 정했습니다.)\n문제점시스템의 강결한 결합 문제12345678910111213@Serviceclass MemberSignUpService(    private val memberRepository: MemberRepository,    private val couponIssueService: CouponIssueService,    private val emailSenderService: EmailSenderService) &#123;    @Transactional    fun signUp(dto: MemberSignUpRequest) &#123;        val member = createMember(dto.toEntity()) // 1. member 엔티티 영속화        emailSenderService.sendSignUpEmail(member) // 2. 외부 시스템 회원 가입 이메일 전송        couponIssueService.issueSignUpCoupon(member.id!!) // 3. 회원가입 쿠폰 발급    &#125;&#125;\n해당 흐름을 코드로 표현하면 위와 같습니다. 여기서 signUp메서드에 많은 책임들이 부여되는 것입니다. 회원 엔티티를 영속화 시키고, 회원 가입 이메일도 전송 요청하고, 회원 가입 쿠폰까지 발급 시키고 있습니다. 그 결과 MemberSignUpService에 많은 의존성이 필요해지고 이런 의존성들 사이에서 강한 결합 관계가 발생하게 됩니다. 해당 코드 정도는 복잡도가 높진 않지만, 회원가입 시 필요한 로직들이 추가될 때마다 MemberSignUpService 객체에는 더 많은 의존성 주입이 생기며, 더 많은 책임들을 부여받게 됩니다.\n트랜잭션의 문제1234567891011@Serviceclass CouponIssueService(    private val couponRepository: CouponRepository) &#123;    @Transactional    fun issueSignUpCoupon(memberId: Long) &#123;        couponRepository.save(Coupon(100.toBigDecimal(), memberId))        throw RuntimeException(&quot;RuntimeException....&quot;)    &#125;&#125;\n만약 3. 회원가입 쿠폰 발급에서 위 코드처럼 예외를 발생시킨다면 회원가입, 회원가입 쿠폰 발행은 트랜잭션이 묶여있기 때문에 Rollback이 진행됩니다. 하지만 2. 외부 시스템 회원 가입 이메일 전송의 경우는 외부 인프라스트럭처이기 때문에 Rollback 과는 무관하게 이메일을 전송하게 됩니다. 회원가입이 실패했지만, 이메일을 전송하게 되는 문제가 발생하게 된 것입니다.\n\nRuntimeException 예외가 발생해서 Member, Coupon은 Rollback 되었지만 회원 가입 이메일은 전송하게 됩니다.(위 코드는 외부 시스템 연동이 아닌 print 메서드로 간단하게 호출 한 것입니다.)\n해결\n해당 문제는 스프링에서 지원하는 ApplicationEventPublisher으로 해결할 수 있습니다. 이벤트 핸들러는 이벤트 생성 주체가 발행한 이벤트에 반응하고, 이벤트 핸들러는 생성 주체가 발행한 이벤트를 전달받아 이벤트에 담긴 정보(데이터)를 기반으로 해당 기능을 수행하게 됩니다.\n회원 가입 -&gt; 회원 가입 쿠폰 발행 -&gt; 회원 가입 완료 이벤트 발행  -&gt; 회원 가입 이벤트 리스너 동작 -&gt; 회원 가입 이메일 전송으로 동작하게 됩니다.\n시스템의 강결한 결합 문제 해결1234567891011121314151617181920212223242526272829303132@Serviceclass MemberSignUpService(    private val memberRepository: MemberRepository,    private val couponIssueService: CouponIssueService,    // private val emailSenderService: EmailSenderService, 의존성 주석    private val eventPublisher: ApplicationEventPublisher // 의존성 추가) &#123;    @Transactional    fun signUp(dto: MemberSignUpRequest) &#123;        val member = createMember(dto.toEntity()) // 1. member 엔티티 영속화//        emailSenderService.sendSignUpEmail(member) // 2. 외부 시스템 이메일 호출 -&gt; 주석        eventPublisher.publishEvent(MemberSignedUpEvent(member)) //2. 회원 가입 완료 이벤트 발행        couponIssueService.issueSignUpCoupon(member.id!!) // 3. 회원가입 쿠폰 발급    &#125;&#125;data class MemberSignedUpEvent(    val member: Member)@Componentclass MemberEventHandler(    private val emailSenderService: EmailSenderService) &#123;        // 회원가입 완료 이벤트 리스너 Bean 등록    @TransactionalEventListener    fun memberSignedUpEventListener(event: MemberSignedUpEvent) &#123;        emailSenderService.sendSignUpEmail(event.member)    &#125;&#125;\n\n기존 회원가입 이메일 전송하는 로직과 회원가입 로직이 서로 섞여 있는 것을 위 코드처럼 방지할 수 있습니다. 회원가입이 완료됐다고 생각하는 시점에 회원 가입 완료 이벤트를 발행 하기면 하면 되기 때문에 더 이상 signUp 메서드에서 이메일 전송 관련 의존성이 필요 없어지게 됩니다.\n트랜잭션의 문제 해결ApplicationEventPublisher에서 발행한 이벤트를 리스닝 하는 방식은 @TransactionalEventListener, @EventListener 2가지 방식이 있습니다. 각각의 차이점을 설명하고 트랜잭션의 문제 해결에 대해서 설명드리겠습니다.\n@EventListener1234@EventListenerfun memberSignedUpEventListener(event: MemberSignedUpEvent) &#123;    emailSenderService.sendSignUpEmail(event.member)&#125;\n\n@EventListener으로 리스너를 등록하는 경우 이벤트를 퍼블리싱 한 이후 바로 리스너가 동작하게 됩니다. 만약 memberSignedUpEventListener를 @EventListener으로 등록한 경우에 동일하게 회원 가입 쿠폰 발급 시 예외가 발생하게 되면 결과는 동일하게 이메일을 전송하게 됩니다.\n12345@Transactionalfun issueSignUpCoupon(memberId: Long) &#123;    couponRepository.save(Coupon(100.toBigDecimal(), memberId))    throw RuntimeException(&quot;RuntimeException....&quot;) // 동일하게 예외가 발생 시킨다.&#125;\n\n\n@EventListener는 이벤트를 발행하는 시점에 바로 리스닝을 진행하기 때문에 issueSignUpCoupon 메서드 실행 이전에 동작하게 된다. 그 결과 위처럼 동일하게 이메일을 전송하게 된다.\n@TransactionalEventListener1234@TransactionalEventListenerfun memberSignedUpEventListener(event: MemberSignedUpEvent) &#123;    emailSenderService.sendSignUpEmail(event.member)&#125;\n\n@TransactionalEventListener으로 리스너를 등록하는 경우 해당 트랜잭션이 Commit된 이후에 리스너가 동작하게 됩니다. 위처럼 동일하게 회원 가입 쿠폰에서 예외가 발생하게 된다면 트랜잭션 Commit이 진행되지 않기 때문에 해당 리스너가 동작하지 않게 되어 트랜잭션 문제를 해결할 수 있습니다.\n\n@TransactionalEventListener으로 빈등 등록을 하게 되면 회원 가입 이메일 관련 메시지가 출력되지 않는 것을 확인할 수 있습니다.\n주문 시나리오\n상품을 주문 시 장바구니에 있는 제품인 경우 해당 유저의 장바구니를 제거합니다. 만약 장바구니를 제거하다 예외가 발생하더라도 주문은 완료되어야 한다는 것이 전제입니다.\n문제점장바구니 삭제시 트랜잭션 문제123456789101112131415161718192021222324@Serviceclass OrderService(    private val orderRepository: OrderRepository,    private val cartService: CartService,    private val emailSenderService: EmailSenderService) &#123;    @Transactional    fun doOrder(dto: OrderRequest) &#123;        val order = orderRepository.save(dto.toEntity()) // 1. order 엔티티 영속화        cartService.deleteCartWithOrder(order) // 2. 해당상품의 장바구니 제거    &#125;&#125;@Serviceclass CartService(    private val cartRepository: CartRepository) &#123;    @Transactional    fun deleteCartWithOrder(order: Order) &#123;        cartRepository.deleteByProductId(order.productId)        throw RuntimeException(&quot;runtime exception ....&quot;) // 예외를 발생시키면 주문 트랜잭션까지 Rollback이 진행된다.    &#125;&#125;\n\n해당 흐름을 코드로 표현하면 위와 같습니다. 만약 2. 해당 상품의 장바구니 제거 도중 예외가 발생하면 한 트랜잭션으로 묶었기 때문에 주문까지 Rollback 되게 됩니다. 이 문제를 해결하기 위해서는 트랜잭션을 분리 시켜야 합니다.\n성능 문제1cartService.deleteCartWithOrder(order) // 2. 해당상품의 장바구니 제거\n\n해당 코드는 동기식으로 진행되기 때문에 deleteCartWithOrder() 메서드가 블록 되는 만큼 주문 완료에 대한 응답이 늦어질 수밖에 없습니다. 해당 문제를 해결하기 위해서는 비동기로 동작하게 하여 해결이 가능합니다.\n해결해당 문제도 ApplicationEventPublisher, @Async으로 해결할 수 있습니다.\n장바구니 삭제시 트랜잭션 문제, 성능 문제 해결12345678910111213141516171819202122232425262728293031323334353637383940@Serviceclass OrderService(    private val orderRepository: OrderRepository,    private val eventPublisher: ApplicationEventPublisher) &#123;    @Transactional    fun doOrder(dto: OrderRequest) &#123;        val order = orderRepository.save(dto.toEntity()) // 1. order 엔티티 영속화        eventPublisher.publishEvent(OrderCompletedEvent(order)) // 2. 주문 완료 이벤트 발행    &#125;&#125;class OrderCompletedEvent(    val order: Order)@Componentclass OrderEventHandler(    private val cartService: CartService,) &#123;    @Async // 비동기 처리를 위해 추가    @EventListener    fun orderCompletedEventListener(event: OrderCompletedEvent) &#123;        cartService.deleteCartWithOrder(event.order)    &#125;&#125;@Serviceclass CartService(    private val cartRepository: CartRepository) &#123;    @Transactional    fun deleteCartWithOrder(order: Order) &#123;        println(&quot;deleteCartWithOrder CurrentTransactionName: $&#123;TransactionSynchronizationManager.getCurrentTransactionName()&#125;&quot;)        cartRepository.deleteByProductId(order.productId)        throw RuntimeException(&quot;runtime exception ....&quot;) // 예외 발생    &#125;&#125;\n\n@Async을 추가하면 해당 메서드는 기존 스레드와 분리되게 됩니다. 그러기 때문에 비동기로 동작하기 때문에 deleteCartWithOrder() 메서드에서 블록 되더라도 주문에 대한 응답 대기는 사라지게 되며 스레드가 다르기 때문에 트랜잭션도 자연스럽게 분리가 됩니다.\n\nTransactionSynchronizationManager.getCurrentTransactionName()으로 현재 트랜잭션을 확인해보면 두 트랜잭션은 다르다는 것을 확인할 수 있습니다.\n\n위처럼 deleteCartWithOrder() 메서드에서 예외가 발행하더라도 주문 요청 응답은 HTTP Status 200을 받게 되어 장바구니 제거를 실패했더라도 주문 요청은 정상적으로 완료할 수 있습니다. 하지만 문제는 있습니다. 주문은 완료했지만, 해당 상품의 장바구니가 제거되지 않은 상태입니다. 이런 문제가 발생했을 경우 ApplicationEventPublisher만 이용해서 재처리를 진행하기는 매우 어렵습니다.\nApplicationEventPublisher에대한 개인적 생각ApplicationEventPublisher는 활용이 하는 구간이 명확하다고 생각합니다. 스프링 Bean 기반으로 동작하기 때문에 외부 시스템과의 연동은 되지 않으며 단일 환경에서만 사용할 수 있습니다.\n위처럼 단일 서비스에서 강결합 문제, 트랜잭션 문제, 비동기로 동작이 필요한 경우 등에서 활용이 가능하며, ApplicationEventPublisher기반으로 코드를 작성해 놓으면 이후에 다른 메시지 시스템을 도입할 때 전체적인 흐름과 이벤트에 대한 DTO 객체를 활용할 수 있어 큰 도움이 된다고 생각합니다.\nRabbitMQ 경우에는 setChannelTransacted 설정을 통해서 @Transactional이 묶이는 효과 즉, @TransactionalEventListener와 같은 효과를 보장해 주지만 Amazon Simple Queue Service(SQS)같은 경우는 (2019년에 사용해서 현재는 지원하는지는 모르겠습니다.) @TransactionalEventListener 와 같은 트랜잭션 처리를 지원해 주지 않기 때문에 @TransactionalEventListener + SQS를 조합해서 사용해도 좋다고 생각합니다.\n그리고 실패에 대한 재처리를 별도로 지원해 주지 않고, 이벤트에 대한 별도의 모니터링 시스템을 지원해 주기 않기 때문에 신중하게 사용해야 합니다.\n","dateCreated":"2020-08-16T00:00:00+09:00","dateModified":"2025-01-31T06:34:16+09:00","datePublished":"2020-08-16T00:00:00+09:00","description":"회원 가입 시 회원 가입 쿠폰 발행, 회원 가입 이메일 발등을 해야 한다면 다음 코드처럼 로직을 만들 수 있습니다.","headline":"ApplicationEventPublisher 기반으로 강결합 및 트랜잭션 문제 해결","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheese10yun.github.io/event-transaction/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"https://cheese10yun.github.io/event-transaction/","keywords":"Transaction, Event"}</script>
    <meta name="description" content="회원 가입 시 회원 가입 쿠폰 발행, 회원 가입 이메일 발등을 해야 한다면 다음 코드처럼 로직을 만들 수 있습니다.">
<meta property="og:type" content="blog">
<meta property="og:title" content="ApplicationEventPublisher 기반으로 강결합 및 트랜잭션 문제 해결">
<meta property="og:url" content="https://cheese10yun.github.io/event-transaction/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="회원 가입 시 회원 가입 쿠폰 발행, 회원 가입 이메일 발등을 해야 한다면 다음 코드처럼 로직을 만들 수 있습니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/seq-sign-up.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/result-1.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/event-dram.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/result-1.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/result-2.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/seq_2.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/result-3.png">
<meta property="og:image" content="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/result-4.png">
<meta property="article:published_time" content="2020-08-15T15:00:00.000Z">
<meta property="article:modified_time" content="2025-01-30T21:34:16.704Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="Transaction">
<meta property="article:tag" content="Event">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/seq-sign-up.png">
    
    
        
    
    
        <meta property="og:image" content="https://cheese10yun.github.io/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5813739623204880" crossorigin="anonymous"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="카테고리"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">카테고리</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="검색"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">검색</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            ApplicationEventPublisher 기반으로 강결합 및 트랜잭션 문제 해결
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-08-16T00:00:00+09:00">
	
		    2020/08/16
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <blockquote>
<p>해당 코드는 <a target="_blank" rel="noopener" href="https://github.com/cheese10yun/blog-sample/tree/master/event-transaction">Github</a> 공개되어 있습니다.</p>
</blockquote>
<h2 id="회원-가입-시나리오"><a href="#회원-가입-시나리오" class="headerlink" title="회원 가입 시나리오"></a>회원 가입 시나리오</h2><p><img src="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/seq-sign-up.png"></p>
<p>회원 가입 시 회원 가입 쿠폰 발행, 회원 가입 이메일 발등을 해야 한다면 다음 코드처럼 로직을 만들 수 있습니다. 이메일 전송 실패, 쿠폰 발급이 실패하는 경우 회원 가입을 다시 해야 한다는 가정으로 설명드리겠습니다.(다소 과격한 시나리오지만 원자성에 대한 설명을 위해서 이런 시나리오를 정했습니다.)</p>
<h2 id="문제점"><a href="#문제점" class="headerlink" title="문제점"></a>문제점</h2><h3 id="시스템의-강결한-결합-문제"><a href="#시스템의-강결한-결합-문제" class="headerlink" title="시스템의 강결한 결합 문제"></a>시스템의 강결한 결합 문제</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemberSignUpService</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> memberRepository: MemberRepository,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> couponIssueService: CouponIssueService,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> emailSenderService: EmailSenderService</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">signUp</span><span class="params">(dto: <span class="type">MemberSignUpRequest</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> member = createMember(dto.toEntity()) <span class="comment">// 1. member 엔티티 영속화</span></span><br><span class="line">        emailSenderService.sendSignUpEmail(member) <span class="comment">// 2. 외부 시스템 회원 가입 이메일 전송</span></span><br><span class="line">        couponIssueService.issueSignUpCoupon(member.id!!) <span class="comment">// 3. 회원가입 쿠폰 발급</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>해당 흐름을 코드로 표현하면 위와 같습니다. 여기서 <code>signUp</code>메서드에 많은 책임들이 부여되는 것입니다. 회원 엔티티를 영속화 시키고, 회원 가입 이메일도 전송 요청하고, 회원 가입 쿠폰까지 발급 시키고 있습니다. 그 결과 <code>MemberSignUpService</code>에 많은 의존성이 필요해지고 이런 의존성들 사이에서 강한 결합 관계가 발생하게 됩니다. 해당 코드 정도는 복잡도가 높진 않지만, 회원가입 시 필요한 로직들이 추가될 때마다 <code>MemberSignUpService</code> 객체에는 더 많은 의존성 주입이 생기며, 더 많은 책임들을 부여받게 됩니다.</p>
<h3 id="트랜잭션의-문제"><a href="#트랜잭션의-문제" class="headerlink" title="트랜잭션의 문제"></a>트랜잭션의 문제</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CouponIssueService</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> couponRepository: CouponRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">issueSignUpCoupon</span><span class="params">(memberId: <span class="type">Long</span>)</span></span> &#123;</span><br><span class="line">        couponRepository.save(Coupon(<span class="number">100.</span>toBigDecimal(), memberId))</span><br><span class="line">        <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;RuntimeException....&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>만약 <code>3. 회원가입 쿠폰 발급</code>에서 위 코드처럼 예외를 발생시킨다면 회원가입, 회원가입 쿠폰 발행은 트랜잭션이 묶여있기 때문에 Rollback이 진행됩니다. <strong>하지만 2. 외부 시스템 회원 가입 이메일 전송의 경우는 외부 인프라스트럭처이기 때문에 Rollback 과는 무관하게 이메일을 전송하게 됩니다.</strong> 회원가입이 실패했지만, 이메일을 전송하게 되는 문제가 발생하게 된 것입니다.</p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/result-1.png"></p>
<p><code>RuntimeException</code> 예외가 발생해서 Member, Coupon은 Rollback 되었지만 회원 가입 이메일은 전송하게 됩니다.(위 코드는 외부 시스템 연동이 아닌 print 메서드로 간단하게 호출 한 것입니다.)</p>
<h2 id="해결"><a href="#해결" class="headerlink" title="해결"></a>해결</h2><p><img src="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/event-dram.png"></p>
<p>해당 문제는 스프링에서 지원하는 <code>ApplicationEventPublisher</code>으로 해결할 수 있습니다. 이벤트 핸들러는 이벤트 생성 주체가 발행한 이벤트에 반응하고, 이벤트 핸들러는 생성 주체가 발행한 이벤트를 전달받아 이벤트에 담긴 정보(데이터)를 기반으로 해당 기능을 수행하게 됩니다.</p>
<p><code>회원 가입</code> -&gt; <code>회원 가입 쿠폰 발행</code> -&gt; <code>회원 가입 완료 이벤트 발행 </code> -&gt; <code>회원 가입 이벤트 리스너 동작</code> -&gt; <code>회원 가입 이메일 전송</code>으로 동작하게 됩니다.</p>
<h3 id="시스템의-강결한-결합-문제-해결"><a href="#시스템의-강결한-결합-문제-해결" class="headerlink" title="시스템의 강결한 결합 문제 해결"></a>시스템의 강결한 결합 문제 해결</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemberSignUpService</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> memberRepository: MemberRepository,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> couponIssueService: CouponIssueService,</span><br><span class="line">    <span class="comment">// private val emailSenderService: EmailSenderService, 의존성 주석</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> eventPublisher: ApplicationEventPublisher <span class="comment">// 의존성 추가</span></span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">signUp</span><span class="params">(dto: <span class="type">MemberSignUpRequest</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> member = createMember(dto.toEntity()) <span class="comment">// 1. member 엔티티 영속화</span></span><br><span class="line"><span class="comment">//        emailSenderService.sendSignUpEmail(member) // 2. 외부 시스템 이메일 호출 -&gt; 주석</span></span><br><span class="line">        eventPublisher.publishEvent(MemberSignedUpEvent(member)) <span class="comment">//2. 회원 가입 완료 이벤트 발행</span></span><br><span class="line">        couponIssueService.issueSignUpCoupon(member.id!!) <span class="comment">// 3. 회원가입 쿠폰 발급</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">MemberSignedUpEvent</span>(</span><br><span class="line">    <span class="keyword">val</span> member: Member</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemberEventHandler</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> emailSenderService: EmailSenderService</span><br><span class="line">) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 회원가입 완료 이벤트 리스너 Bean 등록</span></span><br><span class="line">    <span class="meta">@TransactionalEventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">memberSignedUpEventListener</span><span class="params">(event: <span class="type">MemberSignedUpEvent</span>)</span></span> &#123;</span><br><span class="line">        emailSenderService.sendSignUpEmail(event.member)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>기존 회원가입 이메일 전송하는 로직과 회원가입 로직이 서로 섞여 있는 것을 위 코드처럼 방지할 수 있습니다. 회원가입이 완료됐다고 생각하는 시점에 <code>회원 가입 완료</code> 이벤트를 발행 하기면 하면 되기 때문에 더 이상 <code>signUp</code> 메서드에서 이메일 전송 관련 의존성이 필요 없어지게 됩니다.</p>
<h3 id="트랜잭션의-문제-해결"><a href="#트랜잭션의-문제-해결" class="headerlink" title="트랜잭션의 문제 해결"></a>트랜잭션의 문제 해결</h3><p><code>ApplicationEventPublisher</code>에서 발행한 이벤트를 리스닝 하는 방식은 <code>@TransactionalEventListener</code>, <code>@EventListener</code> 2가지 방식이 있습니다. 각각의 차이점을 설명하고 트랜잭션의 문제 해결에 대해서 설명드리겠습니다.</p>
<h4 id="EventListener"><a href="#EventListener" class="headerlink" title="@EventListener"></a>@EventListener</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EventListener</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">memberSignedUpEventListener</span><span class="params">(event: <span class="type">MemberSignedUpEvent</span>)</span></span> &#123;</span><br><span class="line">    emailSenderService.sendSignUpEmail(event.member)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@EventListener</code>으로 리스너를 등록하는 경우 이벤트를 퍼블리싱 한 이후 바로 리스너가 동작하게 됩니다. 만약 <code>memberSignedUpEventListener</code>를 <code>@EventListener</code>으로 등록한 경우에 동일하게 회원 가입 쿠폰 발급 시 예외가 발생하게 되면 결과는 동일하게 이메일을 전송하게 됩니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">issueSignUpCoupon</span><span class="params">(memberId: <span class="type">Long</span>)</span></span> &#123;</span><br><span class="line">    couponRepository.save(Coupon(<span class="number">100.</span>toBigDecimal(), memberId))</span><br><span class="line">    <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;RuntimeException....&quot;</span>) <span class="comment">// 동일하게 예외가 발생 시킨다.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/result-1.png"></p>
<p><code>@EventListener</code>는 이벤트를 발행하는 시점에 바로 리스닝을 진행하기 때문에 <code>issueSignUpCoupon</code> 메서드 실행 이전에 동작하게 된다. 그 결과 위처럼 동일하게 이메일을 전송하게 된다.</p>
<h4 id="TransactionalEventListener"><a href="#TransactionalEventListener" class="headerlink" title="@TransactionalEventListener"></a>@TransactionalEventListener</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TransactionalEventListener</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">memberSignedUpEventListener</span><span class="params">(event: <span class="type">MemberSignedUpEvent</span>)</span></span> &#123;</span><br><span class="line">    emailSenderService.sendSignUpEmail(event.member)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@TransactionalEventListener</code>으로 리스너를 등록하는 경우 해당 트랜잭션이 Commit된 이후에 리스너가 동작하게 됩니다. 위처럼 동일하게 회원 가입 쿠폰에서 예외가 발생하게 된다면 <strong>트랜잭션 Commit이 진행되지 않기 때문에 해당 리스너가 동작하지 않게 되어 트랜잭션 문제를 해결할 수 있습니다.</strong></p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/result-2.png"></p>
<p><code>@TransactionalEventListener</code>으로 빈등 등록을 하게 되면 회원 가입 이메일 관련 메시지가 출력되지 않는 것을 확인할 수 있습니다.</p>
<h2 id="주문-시나리오"><a href="#주문-시나리오" class="headerlink" title="주문 시나리오"></a>주문 시나리오</h2><p><img src="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/seq_2.png"></p>
<p>상품을 주문 시 장바구니에 있는 제품인 경우 해당 유저의 장바구니를 제거합니다. 만약 장바구니를 제거하다 예외가 발생하더라도 주문은 완료되어야 한다는 것이 전제입니다.</p>
<h2 id="문제점-1"><a href="#문제점-1" class="headerlink" title="문제점"></a>문제점</h2><h3 id="장바구니-삭제시-트랜잭션-문제"><a href="#장바구니-삭제시-트랜잭션-문제" class="headerlink" title="장바구니 삭제시 트랜잭션 문제"></a>장바구니 삭제시 트랜잭션 문제</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderService</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> orderRepository: OrderRepository,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> cartService: CartService,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> emailSenderService: EmailSenderService</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">doOrder</span><span class="params">(dto: <span class="type">OrderRequest</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> order = orderRepository.save(dto.toEntity()) <span class="comment">// 1. order 엔티티 영속화</span></span><br><span class="line">        cartService.deleteCartWithOrder(order) <span class="comment">// 2. 해당상품의 장바구니 제거</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CartService</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> cartRepository: CartRepository</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">deleteCartWithOrder</span><span class="params">(order: <span class="type">Order</span>)</span></span> &#123;</span><br><span class="line">        cartRepository.deleteByProductId(order.productId)</span><br><span class="line">        <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;runtime exception ....&quot;</span>) <span class="comment">// 예외를 발생시키면 주문 트랜잭션까지 Rollback이 진행된다.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>해당 흐름을 코드로 표현하면 위와 같습니다. 만약 <code>2. 해당 상품의 장바구니 제거</code> 도중 예외가 발생하면 한 트랜잭션으로 묶었기 때문에 주문까지 Rollback 되게 됩니다. 이 문제를 해결하기 위해서는 트랜잭션을 분리 시켜야 합니다.</p>
<h3 id="성능-문제"><a href="#성능-문제" class="headerlink" title="성능 문제"></a>성능 문제</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cartService.deleteCartWithOrder(order) <span class="comment">// 2. 해당상품의 장바구니 제거</span></span><br></pre></td></tr></table></figure>

<p>해당 코드는 동기식으로 진행되기 때문에 <code>deleteCartWithOrder()</code> 메서드가 블록 되는 만큼 주문 완료에 대한 응답이 늦어질 수밖에 없습니다. 해당 문제를 해결하기 위해서는 비동기로 동작하게 하여 해결이 가능합니다.</p>
<h2 id="해결-1"><a href="#해결-1" class="headerlink" title="해결"></a>해결</h2><p>해당 문제도 <code>ApplicationEventPublisher</code>, <code>@Async</code>으로 해결할 수 있습니다.</p>
<h3 id="장바구니-삭제시-트랜잭션-문제-성능-문제-해결"><a href="#장바구니-삭제시-트랜잭션-문제-성능-문제-해결" class="headerlink" title="장바구니 삭제시 트랜잭션 문제, 성능 문제 해결"></a>장바구니 삭제시 트랜잭션 문제, 성능 문제 해결</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderService</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> orderRepository: OrderRepository,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> eventPublisher: ApplicationEventPublisher</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">doOrder</span><span class="params">(dto: <span class="type">OrderRequest</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> order = orderRepository.save(dto.toEntity()) <span class="comment">// 1. order 엔티티 영속화</span></span><br><span class="line">        eventPublisher.publishEvent(OrderCompletedEvent(order)) <span class="comment">// 2. 주문 완료 이벤트 발행</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderCompletedEvent</span>(</span><br><span class="line">    <span class="keyword">val</span> order: Order</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderEventHandler</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> cartService: CartService,</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span> <span class="comment">// 비동기 처리를 위해 추가</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">orderCompletedEventListener</span><span class="params">(event: <span class="type">OrderCompletedEvent</span>)</span></span> &#123;</span><br><span class="line">        cartService.deleteCartWithOrder(event.order)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CartService</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> cartRepository: CartRepository</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">deleteCartWithOrder</span><span class="params">(order: <span class="type">Order</span>)</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;deleteCartWithOrder CurrentTransactionName: <span class="subst">$&#123;TransactionSynchronizationManager.getCurrentTransactionName()&#125;</span>&quot;</span>)</span><br><span class="line">        cartRepository.deleteByProductId(order.productId)</span><br><span class="line">        <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;runtime exception ....&quot;</span>) <span class="comment">// 예외 발생</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Async</code>을 추가하면 해당 메서드는 기존 스레드와 분리되게 됩니다. 그러기 때문에 비동기로 동작하기 때문에 <code>deleteCartWithOrder()</code> 메서드에서 블록 되더라도 주문에 대한 응답 대기는 사라지게 되며 스레드가 다르기 때문에 트랜잭션도 자연스럽게 분리가 됩니다.</p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/result-3.png"></p>
<p><code>TransactionSynchronizationManager.getCurrentTransactionName()</code>으로 현재 트랜잭션을 확인해보면 두 트랜잭션은 다르다는 것을 확인할 수 있습니다.</p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/event-transaction/docs/result-4.png"></p>
<p>위처럼 <code>deleteCartWithOrder()</code> 메서드에서 예외가 발행하더라도 주문 요청 응답은 HTTP Status 200을 받게 되어 장바구니 제거를 실패했더라도 주문 요청은 정상적으로 완료할 수 있습니다. <strong>하지만 문제는 있습니다. 주문은 완료했지만, 해당 상품의 장바구니가 제거되지 않은 상태입니다.</strong> 이런 문제가 발생했을 경우 <code>ApplicationEventPublisher</code>만 이용해서 재처리를 진행하기는 매우 어렵습니다.</p>
<h2 id="ApplicationEventPublisher에대한-개인적-생각"><a href="#ApplicationEventPublisher에대한-개인적-생각" class="headerlink" title="ApplicationEventPublisher에대한 개인적 생각"></a>ApplicationEventPublisher에대한 개인적 생각</h2><p><code>ApplicationEventPublisher</code>는 활용이 하는 구간이 명확하다고 생각합니다. 스프링 Bean 기반으로 동작하기 때문에 외부 시스템과의 연동은 되지 않으며 단일 환경에서만 사용할 수 있습니다.</p>
<p>위처럼 단일 서비스에서 강결합 문제, 트랜잭션 문제, 비동기로 동작이 필요한 경우 등에서 활용이 가능하며, <code>ApplicationEventPublisher</code>기반으로 코드를 작성해 놓으면 이후에 다른 메시지 시스템을 도입할 때 전체적인 흐름과 이벤트에 대한 DTO 객체를 활용할 수 있어 큰 도움이 된다고 생각합니다.</p>
<p>RabbitMQ 경우에는 <code>setChannelTransacted</code> 설정을 통해서 <code>@Transactional</code>이 묶이는 효과 즉, <code>@TransactionalEventListener</code>와 같은 효과를 보장해 주지만 <code>Amazon Simple Queue Service(SQS)</code>같은 경우는 (2019년에 사용해서 현재는 지원하는지는 모르겠습니다.) <code>@TransactionalEventListener</code> 와 같은 트랜잭션 처리를 지원해 주지 않기 때문에 <code>@TransactionalEventListener</code> + <code>SQS</code>를 조합해서 사용해도 좋다고 생각합니다.</p>
<p>그리고 실패에 대한 재처리를 별도로 지원해 주지 않고, 이벤트에 대한 별도의 모니터링 시스템을 지원해 주기 않기 때문에 신중하게 사용해야 합니다.</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Event/" rel="tag">Event</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Transaction/" rel="tag">Transaction</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-cloud-gateway/"
                    data-tooltip="Spring Cloud Gateway"
                    aria-label="이전: Spring Cloud Gateway"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-transacion-same-bean/"
                    data-tooltip="Spring 동일한 Bean(Class)에서 @Transactional 동작 방식"
                    aria-label="다음: Spring 동일한 Bean(Class)에서 @Transactional 동작 방식"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/event-transaction/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/event-transaction/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://cheese10yun.github.io/event-transaction/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>


<!-- Comment -->
<!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-cloud-gateway/"
                    data-tooltip="Spring Cloud Gateway"
                    aria-label="이전: Spring Cloud Gateway"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-transacion-same-bean/"
                    data-tooltip="Spring 동일한 Bean(Class)에서 @Transactional 동작 방식"
                    aria-label="다음: Spring 동일한 Bean(Class)에서 @Transactional 동작 방식"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/event-transaction/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/event-transaction/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://cheese10yun.github.io/event-transaction/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/event-transaction/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/event-transaction/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://cheese10yun.github.io/event-transaction/"
                        aria-label="Google+에 공유하기"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Google+에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
